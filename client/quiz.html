<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚¯ã‚¤ã‚ºãƒãƒˆãƒ« - CSå­¦ç¿’ã‚¯ã‚¤ã‚ºãƒãƒˆãƒ«</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body class="terminal-body quiz-battle">
    <div class="terminal-container">
        <div class="terminal-header">
            <div class="terminal-controls">
                <span class="control red"></span>
                <span class="control yellow"></span>
                <span class="control green"></span>
            </div>
            <div class="terminal-title">QUIZ-BATTLE-ARENA v1.0</div>
        </div>

        <div class="terminal-content">
            <!-- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æƒ…å ±ã¨ã‚¹ã‚³ã‚¢ -->
            <div class="battle-header">
                <div class="player-info left">
                    <div class="player-avatar">ğŸ›¡ï¸</div>
                    <div class="player-details">
                        <div class="player-name" id="player1Name">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1</div>
                        <div class="player-score" id="player1Score">0</div>
                    </div>
                </div>
                
                <div class="battle-status">
                    <div class="round-info">
                        <span id="currentRound">1</span> / 5
                    </div>
                    <div class="timer-container">
                        <div class="timer" id="timer">30</div>
                        <div class="timer-bar">
                            <div class="timer-progress" id="timerProgress"></div>
                        </div>
                    </div>
                </div>
                
                <div class="player-info right">
                    <div class="player-avatar">âš”ï¸</div>
                    <div class="player-details">
                        <div class="player-name" id="player2Name">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼2</div>
                        <div class="player-score" id="player2Score">0</div>
                    </div>
                </div>
            </div>

        <!-- å•ã„ã®é¢ -->
        <section class="wa-question-area" id="questionArea">
            <div class="wa-question-loading" id="questionLoading">
                <div class="wa-loading-spinner"></div>
                <div class="wa-loading-text">é›…ãªã‚‹å•ã„ã‚’æº–å‚™ä¸­...</div>
            </div>
            
            <div class="wa-question-content" id="questionContent" style="display: none;">
                <div class="wa-category-badge" id="categoryBadge">é›…ãªã‚‹å­¦å•</div>
                
                <div class="wa-story-section" id="storySection">
                    <div class="wa-story-title">ğŸ“œ ç‰©èª</div>
                    <div class="wa-story-text" id="storyText">é›…ãªã‚‹ç‰©èªãŒã“ã“ã«ç¶¾ãªã•ã‚Œã¾ã™...</div>
                </div>
                
                <div class="wa-question-section">
                    <div class="wa-question-title">â“ å•ã„</div>
                    <div class="wa-question-text" id="questionText">çŸ¥è­˜ã‚’è©¦ã™å•ã„ãŒã“ã“ã«è¡¨ã‚Œã¾ã™</div>
                </div>
                
                <div class="wa-options-container" id="optionsContainer">
                    <div class="wa-option" data-option="0">
                        <div class="wa-option-letter">ç”²</div>
                        <div class="wa-option-text">é¸æŠè‚¢1</div>
                    </div>
                    <div class="wa-option" data-option="1">
                        <div class="wa-option-letter">ä¹™</div>
                        <div class="wa-option-text">é¸æŠè‚¢2</div>
                    </div>
                    <div class="wa-option" data-option="2">
                        <div class="wa-option-letter">ä¸™</div>
                        <div class="wa-option-text">é¸æŠè‚¢3</div>
                    </div>
                    <div class="wa-option" data-option="3">
                        <div class="wa-option-letter">ä¸</div>
                        <div class="wa-option-text">é¸æŠè‚¢4</div>
                    </div>
                </div>
            </div>
        </section>

        <!-- çµæœã®é¢ -->
        <section class="wa-result-area" id="resultArea" style="display: none;">
            <div class="wa-result-content">
                <div class="wa-correct-answer" id="correctAnswer">
                    <div class="wa-result-title">âœ… æ­£è§£</div>
                    <div class="wa-correct-option" id="correctOption">ä¹™. æ­£ã—ãç­”ãˆ</div>
                </div>
                
                <div class="wa-explanation" id="explanation">
                    <div class="wa-explanation-title">ğŸ“– è§£èª¬</div>
                    <div class="wa-explanation-text" id="explanationText">é›…ãªã‚‹è§£èª¬ãŒã“ã“ã«ç¶¾ãªã•ã‚Œã¾ã™</div>
                </div>
                
                <div class="wa-player-results" id="playerResults">
                    <div class="wa-player-result" id="playerResult1">
                        <div class="wa-result-player">æˆ¦å£«ä¸€</div>
                        <div class="wa-result-choice">é¸æŠ: ç”²</div>
                        <div class="wa-result-status correct">æ­£è§£ãªã‚Š!</div>
                        <div class="wa-result-score">+120ç‚¹</div>
                    </div>
                    <div class="wa-player-result" id="playerResult2">
                        <div class="wa-result-player">æˆ¦å£«äºŒ</div>
                        <div class="wa-result-choice">é¸æŠ: ä¸™</div>
                        <div class="wa-result-status incorrect">æƒœã—ãé–“é•ã„</div>
                        <div class="wa-result-score">+0ç‚¹</div>
                    </div>
                </div>
            </div>
        </section>

        <!-- æœ€çµ‚çµæœ -->
        <section class="wa-final-result" id="finalResult" style="display: none;">
            <div class="wa-final-content">
                <div class="wa-winner-announcement" id="winnerAnnouncement">
                    <div class="wa-winner-crown">ğŸ‘‘</div>
                    <div class="wa-winner-text">å‹è€…: é›…ãªã‚‹æˆ¦å£«</div>
                    <div class="wa-winner-score">æœ€çµ‚æ­¦å‹²: 480ç‚¹</div>
                </div>
                
                <div class="wa-final-scores" id="finalScores">
                    <div class="wa-final-score-item">
                        <span class="wa-score-player">æˆ¦å£«ä¸€</span>
                        <span class="wa-score-points">480ç‚¹</span>
                    </div>
                    <div class="wa-final-score-item">
                        <span class="wa-score-player">æˆ¦å£«äºŒ</span>
                        <span class="wa-score-points">320ç‚¹</span>
                    </div>
                </div>
                
                <div class="wa-btn-group" style="margin-top: 2rem;">
                    <button class="wa-btn wa-btn-secondary" onclick="goHome()">
                        <span>ğŸ </span>
                        <span>é›…å­¦ã®é–“ã‚’å‡ºã‚‹</span>
                    </button>
                    <button class="wa-btn wa-btn-primary" onclick="playAgain()">
                        <span>âš”ï¸</span>
                        <span>å†ã³æˆ¦ã„ã‚’æŒ‘ã‚€</span>
                    </button>
                </div>
            </div>
        </section>

        <!-- æ­£è§£æ™‚ã®ç¾ã—ãã“ã¨ -->
        <div class="wa-celebration" id="celebration" style="display: none;">
            <div class="wa-fireworks">
                <div class="wa-firework">ğŸŒ¸</div>
                <div class="wa-firework">ğŸŒº</div>
                <div class="wa-firework">ğŸŒŒ</div>
                <div class="wa-firework">âœ¨</div>
                <div class="wa-firework">ğŸ†</div>
            </div>
            <div class="wa-celebration-text">ğŸŒ¸ æ­£è§£ãªã‚Šï¼ ğŸŒ¸</div>
        </div>
    </main>

    <script src="/socket.io/socket.io.js"></script>
    <script src="js/socket.js"></script>
    <script>
        // URL ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰æƒ…å ±ã‚’å–å¾—
        const urlParams = new URLSearchParams(window.location.search);
        const roomId = urlParams.get('roomId');
        const playerName = urlParams.get('playerName');
        const userRole = urlParams.get('role') || 'guest';
        
        if (!roomId || !playerName) {
            alert('ã‚¯ã‚¤ã‚ºæƒ…å ±ãŒä¸æ­£ã§ã™ã€‚');
            window.location.href = 'index.html';
        }
        
        let socket;
        let currentQuestion = null;
        let selectedOption = null;
        let timeLeft = 30;
        let timerInterval = null;
        let isAnswered = false;
        let gameEnded = false;
        
        // Socket.io æ¥ç¶š
        function initializeSocket() {
            socket = io();
            
            socket.on('connect', () => {
                console.log('ã‚¯ã‚¤ã‚ºãƒãƒˆãƒ«ã«æ¥ç¶šã—ã¾ã—ãŸ');
                // ã™ã§ã«ãƒ«ãƒ¼ãƒ ã«å‚åŠ æ¸ˆã¿ã®ã¯ãš
            });
            
            socket.on('new_question', (questionData) => {
                console.log('æ–°ã—ã„å•é¡Œ:', questionData);
                showNewQuestion(questionData);
            });
            
            socket.on('question_result', (resultData) => {
                console.log('å•é¡Œçµæœ:', resultData);
                showQuestionResult(resultData);
            });
            
            socket.on('quiz_finished', (finalData) => {
                console.log('ã‚¯ã‚¤ã‚ºçµ‚äº†:', finalData);
                showFinalResult(finalData);
            });
            
            socket.on('player_disconnected', (data) => {
                alert(`${data.playerName}ã•ã‚“ãŒåˆ‡æ–­ã•ã‚Œã¾ã—ãŸã€‚`);
                goHome();
            });
        }
        
        function showNewQuestion(questionData) {
            currentQuestion = questionData;
            selectedOption = null;
            isAnswered = false;
            timeLeft = questionData.timeLimit || 30;
            
            // UIæ›´æ–°
            document.getElementById('currentRound').textContent = questionData.round;
            document.getElementById('roundStatus').textContent = `${questionData.round}/5`;
            document.getElementById('categoryBadge').textContent = questionData.category;
            document.getElementById('storyText').textContent = questionData.story;
            document.getElementById('questionText').textContent = questionData.question;
            
            // é¸æŠè‚¢è¨­å®š
            const options = document.querySelectorAll('.wa-option');
            options.forEach((option, index) => {
                option.querySelector('.wa-option-text').textContent = questionData.options[index];
                option.classList.remove('selected', 'correct', 'incorrect', 'disabled');
                option.onclick = () => selectOption(index);
            });
            
            // ç”»é¢åˆ‡ã‚Šæ›¿ãˆ
            document.getElementById('questionLoading').style.display = 'none';
            document.getElementById('questionContent').style.display = 'block';
            document.getElementById('resultArea').style.display = 'none';
            
            // ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹
            startTimer();
        }
        
        function selectOption(optionIndex) {
            if (isAnswered || timeLeft <= 0) return;
            
            selectedOption = optionIndex;
            isAnswered = true;
            
            // é¸æŠè‚¢ã®è¦‹ãŸç›®ã‚’æ›´æ–°
            document.querySelectorAll('.wa-option').forEach((option, index) => {
                option.classList.remove('selected');
                option.classList.add('disabled');
                if (index === optionIndex) {
                    option.classList.add('selected');
                }
            });
            
            // ã‚µãƒ¼ãƒãƒ¼ã«å›ç­”ã‚’é€ä¿¡
            socket.emit('submit_answer', {
                questionIndex: currentQuestion.round - 1,
                selectedOption: optionIndex,
                timeLeft: timeLeft
            });
            
            console.log(`é¸æŠ: ${optionIndex + 1}, æ®‹ã‚Šæ™‚é–“: ${timeLeft}`);
        }
        
        function startTimer() {
            document.getElementById('timer').textContent = timeLeft;
            document.getElementById('timerStatus').textContent = `${timeLeft}s`;
            
            timerInterval = setInterval(() => {
                timeLeft--;
                document.getElementById('timer').textContent = timeLeft;
                document.getElementById('timerStatus').textContent = `${timeLeft}s`;
                
                // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼æ›´æ–°
                const progress = ((currentQuestion?.timeLimit || 30) - timeLeft) / (currentQuestion?.timeLimit || 30) * 100;
                document.getElementById('timerProgress').style.width = `${progress}%`;
                
                // è‰²å¤‰æ›´
                if (timeLeft <= 10) {
                    document.getElementById('timer').classList.add('urgent');
                    document.getElementById('timerProgress').classList.add('urgent');
                }
                
                // æ™‚é–“åˆ‡ã‚Œ
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    if (!isAnswered) {
                        // æœªå›ç­”ã§ã‚‚é€ä¿¡
                        socket.emit('submit_answer', {
                            questionIndex: currentQuestion.round - 1,
                            selectedOption: null,
                            timeLeft: 0
                        });
                        isAnswered = true;
                    }
                }
            }, 1000);
        }
        
        function showQuestionResult(resultData) {
            clearInterval(timerInterval);
            
            // æ­£è§£ã®é¸æŠè‚¢ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
            const correctIndex = resultData.correctAnswer;
            document.querySelectorAll('.option').forEach((option, index) => {
                if (index === correctIndex) {
                    option.classList.add('correct');
                }
                if (selectedOption !== null && index === selectedOption && index !== correctIndex) {
                    option.classList.add('incorrect');
                }
            });
            
            // çµæœè¡¨ç¤º
            setTimeout(() => {
                document.getElementById('questionContent').style.display = 'none';
                document.getElementById('resultArea').style.display = 'block';
                
                // çµæœè©³ç´°
                const correctOptionText = currentQuestion.options[correctIndex];
                const letters = ['A', 'B', 'C', 'D'];
                document.getElementById('correctOption').textContent = `${letters[correctIndex]}. ${correctOptionText}`;
                document.getElementById('explanationText').textContent = resultData.explanation;
                
                // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼çµæœ
                resultData.results.forEach((result, index) => {
                    const resultElement = document.getElementById(`playerResult${index + 1}`);
                    resultElement.querySelector('.result-player').textContent = result.playerName;
                    
                    if (result.selectedOption !== null) {
                        resultElement.querySelector('.result-choice').textContent = `é¸æŠ: ${letters[result.selectedOption]}`;
                    } else {
                        resultElement.querySelector('.result-choice').textContent = 'æœªå›ç­”';
                    }
                    
                    const statusElement = resultElement.querySelector('.result-status');
                    if (result.isCorrect) {
                        statusElement.textContent = 'æ­£è§£!';
                        statusElement.className = 'result-status correct';
                        
                        // æ­£è§£ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
                        if (result.playerName === playerName) {
                            showCelebration();
                        }
                    } else {
                        statusElement.textContent = 'ä¸æ­£è§£';
                        statusElement.className = 'result-status incorrect';
                    }
                    
                    const scoreGain = result.score - (resultData.prevScores?.[result.playerName] || 0);
                    resultElement.querySelector('.result-score').textContent = `+${scoreGain}ç‚¹`;
                    
                    // ã‚¹ã‚³ã‚¢æ›´æ–°
                    if (index === 0) {
                        document.getElementById('player1Name').textContent = result.playerName;
                        document.getElementById('player1Score').textContent = result.score;
                    } else {
                        document.getElementById('player2Name').textContent = result.playerName;
                        document.getElementById('player2Score').textContent = result.score;
                    }
                });
            }, 2000);
        }
        
        function showCelebration() {
            const celebration = document.getElementById('celebration');
            celebration.style.display = 'block';
            
            setTimeout(() => {
                celebration.style.display = 'none';
            }, 3000);
        }
        
        function showFinalResult(finalData) {
            gameEnded = true;
            document.getElementById('gameStatus').textContent = 'FINISHED';
            
            setTimeout(() => {
                document.getElementById('resultArea').style.display = 'none';
                document.getElementById('finalResult').style.display = 'block';
                
                const winner = finalData.winner;
                document.getElementById('winnerAnnouncement').innerHTML = `
                    <div class="winner-crown">ğŸ‘‘</div>
                    <div class="winner-text">å‹è€…: ${winner.playerName}</div>
                    <div class="winner-score">æœ€çµ‚ã‚¹ã‚³ã‚¢: ${winner.score}ç‚¹</div>
                `;
                
                const scoresHtml = finalData.results.map(result => `
                    <div class="final-score-item">
                        <span class="score-player">${result.playerName}</span>
                        <span class="score-points">${result.score}ç‚¹</span>
                    </div>
                `).join('');
                
                document.getElementById('finalScores').innerHTML = scoresHtml;
            }, 3000);
        }
        
        function goHome() {
            if (socket) {
                socket.disconnect();
            }
            window.location.href = 'index.html';
        }
        
        function playAgain() {
            window.location.href = `matching.html?roomId=${encodeURIComponent(roomId + '_new')}&playerName=${encodeURIComponent(playerName)}`;
        }
        
        // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã®åˆæœŸåŒ–
        window.onload = () => {
            initializeSocket();
        };
        
        // ãƒšãƒ¼ã‚¸é›¢è„±æ™‚ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
        window.addEventListener('beforeunload', () => {
            if (socket) {
                socket.disconnect();
            }
        });
        
        // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ
        document.addEventListener('keydown', (e) => {
            if (gameEnded || isAnswered) return;
            
            const keyMap = {
                '1': 0, 'a': 0, 'A': 0,
                '2': 1, 'b': 1, 'B': 1,
                '3': 2, 'c': 2, 'C': 2,
                '4': 3, 'd': 3, 'D': 3
            };
            
            if (keyMap.hasOwnProperty(e.key)) {
                selectOption(keyMap[e.key]);
            }
        });
    </script>
</body>
</html>