<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­¦ç¿’æ–¹å¼é¸æŠ - CSå­¦ç¿’ã‚¯ã‚¤ã‚ºãƒãƒˆãƒ«</title>
    <link rel="stylesheet" href="css/taisho.css">
</head>
<body>
    <!-- å››å­£ã®è£…é£¾è¦ç´  -->
    <div class="seasonal-decoration" id="seasonalDecoration"></div>

    <main class="washi-container wa-fade-in">
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <header class="wa-header">
            <h1 class="wa-title">å­¦ç¿’ã®é“ã‚’é¸ã¶</h1>
            <p class="wa-subtitle">ç¾ã—ãçŸ¥è­˜ã¸ã®äºŒã¤ã®æ‰‰</p>
            <div class="wa-divider"></div>
        </header>

        <!-- ãƒ«ãƒ¼ãƒ æƒ…å ±è¡¨ç¤º -->
        <div class="wa-room-info">
            <div class="wa-info-grid">
                <div class="wa-info-item">
                    <span class="wa-info-icon">ğŸ®</span>
                    <span class="wa-info-label">ãƒ«ãƒ¼ãƒ </span>
                    <span class="wa-info-value" id="roomName">-</span>
                </div>
                <div class="wa-info-item">
                    <span class="wa-info-icon" id="roleIcon">ğŸ‘‘</span>
                    <span class="wa-info-label">å½¹å‰²</span>
                    <span class="wa-info-value" id="roleName">ä¸»å‚¬è€…</span>
                </div>
                <div class="wa-info-item">
                    <span class="wa-info-icon">ğŸ­</span>
                    <span class="wa-info-label">ãŠåå‰</span>
                    <span class="wa-info-value" id="playerName">-</span>
                </div>
                <div class="wa-info-item">
                    <span class="wa-info-icon">ğŸ‘¥</span>
                    <span class="wa-info-label">å‚åŠ è€…</span>
                    <span class="wa-info-value" id="participantCount">2å</span>
                </div>
            </div>
        </div>

        <!-- ãƒ¢ãƒ¼ãƒ‰é¸æŠ -->
        <section class="wa-mode-selection-main">
            <h2 class="wa-section-title">ğŸŒ¸ å­¦ç¿’ã®æ–¹å¼ã‚’ãŠé¸ã³ãã ã•ã„</h2>
            
            <div class="wa-mode-cards-large">
                <!-- å­¦ç¿’ãƒ¢ãƒ¼ãƒ‰ -->
                <div class="wa-mode-card-large" onclick="selectMode('learning')" data-mode="learning">
                    <div class="wa-mode-decoration">
                        <div class="wa-decoration-element">ğŸŒ¸</div>
                        <div class="wa-decoration-element">ğŸ“œ</div>
                        <div class="wa-decoration-element">ğŸ’</div>
                    </div>
                    
                    <div class="wa-mode-icon-large">ğŸ“š</div>
                    <h3 class="wa-mode-title-large">å­¦ç¿’ãƒ¢ãƒ¼ãƒ‰</h3>
                    <p class="wa-mode-subtitle">ç¾ã—ãç‰©èªã§å­¦ã¶CS</p>
                    
                    <div class="wa-mode-description-large">
                        æ‹æ„›ç‰©èªã«åŒ…ã¾ã‚ŒãªãŒã‚‰ã€<br>
                        ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ãƒ¼ã‚µã‚¤ã‚¨ãƒ³ã‚¹ã®ç¥é«„ã‚’<br>
                        å„ªé›…ã«ç¿’å¾—ã„ãŸã—ã¾ã™
                    </div>
                    
                </div>

                <!-- ã‚¯ã‚¤ã‚ºãƒ¢ãƒ¼ãƒ‰ -->
                <div class="wa-mode-card-large" onclick="selectMode('quiz')" data-mode="quiz">
                    <div class="wa-mode-decoration">
                        <div class="wa-decoration-element">âš”ï¸</div>
                        <div class="wa-decoration-element">ğŸ†</div>
                        <div class="wa-decoration-element">âš¡</div>
                    </div>
                    
                    <div class="wa-mode-icon-large">âš”ï¸</div>
                    <h3 class="wa-mode-title-large">ã‚¯ã‚¤ã‚ºãƒ¢ãƒ¼ãƒ‰</h3>
                    <p class="wa-mode-subtitle">è¯éº—ãªã‚‹çŸ¥è­˜ã®å¯¾æˆ¦</p>
                    
                    <div class="wa-mode-description-large">
                        å­¦ã³ã—çŸ¥è­˜ã‚’æ­¦å™¨ã¨ã—ã¦ã€<br>
                        ç·Šå¼µæ„Ÿã‚ãµã‚Œã‚‹ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å¯¾æˆ¦ã§<br>
                        äº’ã„ã®å®ŸåŠ›ã‚’ç«¶ã„åˆã„ã¾ã™
                    </div>
                    
                </div>
            </div>

            <!-- é–‹å§‹ãƒœã‚¿ãƒ³ -->
            <div class="wa-btn-group-large">
                <button class="wa-btn wa-btn-outline" onclick="goBack()">
                    <span>ğŸ”™</span>
                    <span>å‰ã®ç”»é¢ã«æˆ»ã‚‹</span>
                </button>
                <!-- å­¦ç¿’ã®æ‰‰ãƒœã‚¿ãƒ³ã¯è‡ªå‹•é·ç§»ã®ãŸã‚éè¡¨ç¤º -->
                <div id="autoModeMessage" style="display: none; padding: 1rem; color: var(--take); font-size: 1.1rem; text-align: center;">
                    <span id="autoModeIcon">ğŸŒ¸</span>
                    <span id="autoModeText">è‡ªå‹•çš„ã«ãƒ¢ãƒ¼ãƒ‰ã‚’é–‹å§‹ã—ã¦ã„ã¾ã™...</span>
                </div>
            </div>
        </section>

        <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒ¼ -->
        <div class="wa-status">
            <div class="wa-status-item">
                <span class="wa-status-dot connected"></span>
                <span>æ¥ç¶šçŠ¶æ…‹: æº–å‚™å®Œäº†</span>
            </div>
            <div class="wa-status-item">
                <span>ğŸŒ é¸æŠçŠ¶æ…‹: <span id="statusSelection">æœªé¸æŠ</span></span>
            </div>
            <div class="wa-status-item">
                <span>â° å¾…æ©Ÿæ™‚é–“: <span id="waitingTime">00:00</span></span>
            </div>
        </div>
    </main>

    <!-- é¸æŠã‚¬ã‚¤ãƒ€ãƒ³ã‚¹ï¼ˆJSã‹ã‚‰å‚ç…§ï¼‰ -->
    <section class="wa-selection-guidance" id="selectionGuidance" style="display: none;">
        <div class="wa-card">
            <div class="wa-card-title" id="guidanceTitle"></div>
            <div class="wa-card-content">
                <p id="guidanceContent" style="margin: 0;"></p>
            </div>
        </div>
    </section>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰æƒ…å ±ã‚’å–å¾—
        const urlParams = new URLSearchParams(window.location.search);
        const userRole = urlParams.get('role') || 'owner';
        const roomId = urlParams.get('roomId') || '';
        const playerName = urlParams.get('playerName') || '';
        
        let selectedMode = '';
        let socket = null;
        let startTime = Date.now();
        
        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', () => {
            setupPageInfo();
            generateSeasonalElements();
            startWaitingTimer();
            initializeSocket();
            
            // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³è»½æ¸›è¨­å®šã®ç¢ºèª
            if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.getElementById('seasonalDecoration').style.display = 'none';
                document.querySelectorAll('.wa-decoration-element').forEach(el => {
                    el.style.animation = 'none';
                });
            }
        });
        
        // ãƒšãƒ¼ã‚¸æƒ…å ±ã®è¨­å®š
        function setupPageInfo() {
            document.getElementById('roomName').textContent = roomId;
            document.getElementById('playerName').textContent = playerName;
            
            if (userRole === 'owner') {
                document.getElementById('roleIcon').textContent = 'ğŸ‘‘';
                document.getElementById('roleName').textContent = 'ä¸»å‚¬è€…';
            } else {
                document.getElementById('roleIcon').textContent = 'ğŸ‹';
                document.getElementById('roleName').textContent = 'å‚åŠ è€…';
            }
        }
        
        // Socket.ioåˆæœŸåŒ–ï¼ˆæ–°ã—ã„ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã«å¯¾å¿œï¼‰
        function ensureSocket() {
            if (socket) return socket;
            
            socket = io({
                transports: ['websocket', 'polling'],
                timeout: 20000,
                reconnection: true,
                reconnectionAttempts: 3,
                reconnectionDelay: 1000
            });
            
            socket.on('connect', () => {
                console.log('ãƒ¢ãƒ¼ãƒ‰é¸æŠç”»é¢ã§ã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶š:', socket.id);
                
                if (!roomId || !playerName) {
                    console.error('roomIdã¾ãŸã¯playerNameãŒä¸è¶³ã—ã¦ã„ã¾ã™');
                    return;
                }
                
                // ãƒ¢ãƒ¼ãƒ‰é¸æŠç”»é¢ã§ã®å‚åŠ ã‚’é€šçŸ¥
                socket.emit('mode_select_join', {
                    roomId: roomId,
                    playerName: playerName,
                    role: userRole
                });
                
                // æ¥ç¶šçŠ¶æ…‹ã‚’æ›´æ–°
                document.querySelector('.wa-status-dot').className = 'wa-status-dot connected';
                updateConnectionStatus('connected');
            });
            
            socket.on('connect_error', (error) => {
                console.error('Socketæ¥ç¶šã‚¨ãƒ©ãƒ¼:', error);
                document.querySelector('.wa-status-dot').className = 'wa-status-dot error';
                updateConnectionStatus('error');
                showError('ã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã§ãã¾ã›ã‚“ã§ã—ãŸã€‚');
            });
            
            socket.on('disconnect', (reason) => {
                console.log('Socketåˆ‡æ–­:', reason);
                document.querySelector('.wa-status-dot').className = 'wa-status-dot disconnected';
                updateConnectionStatus('disconnected');
            });
            
            // ãƒ¢ãƒ¼ãƒ‰é¸æŠç”»é¢ã§ã®æ¥ç¶šå®Œäº†
            socket.on('mode_select_connected', (data) => {
                console.log('ãƒ¢ãƒ¼ãƒ‰é¸æŠç”»é¢ã§ã®æ¥ç¶šãŒå®Œäº†ã—ã¾ã—ãŸ:', data);
                const playerCount = data.players ? data.players.length : 0;
                document.getElementById('participantCount').textContent = `${playerCount}å`;
            });
            
            // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®å†æ¥ç¶šé€šçŸ¥
            socket.on('player_reconnected', (data) => {
                console.log(`${data.playerName} (${data.role}) ãŒå†æ¥ç¶šã—ã¾ã—ãŸ`);
                document.getElementById('participantCount').textContent = '2å';
            });
            
            // ãƒ«ãƒ¼ãƒ ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã®è‡ªå‹•å¾©æ—§å‡¦ç†
            socket.on('room_not_found', () => {
                console.log('ãƒ«ãƒ¼ãƒ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚è‡ªå‹•å¾©æ—§ã‚’è©¦è¡Œã—ã¾ã™...');
                
                // è‡ªå‹•å¾©æ—§ã‚’1å›ã ã‘è©¦è¡Œ
                if (!socket._autoRecoveryAttempted) {
                    socket._autoRecoveryAttempted = true;
                    
                    setTimeout(() => {
                        console.log('ãƒ«ãƒ¼ãƒ å¾©æ—§ã‚’è©¦è¡Œä¸­...');
                        socket.emit('mode_select_join', {
                            roomId: roomId,
                            playerName: playerName,
                            role: userRole,
                            recovery: true  // å¾©æ—§ãƒ•ãƒ©ã‚°
                        });
                    }, 1000);
                } else {
                    // å¾©æ—§ã«å¤±æ•—ã—ãŸå ´åˆã®ã¿ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
                    showError('æ¥ç¶šã«å•é¡ŒãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ãƒ­ãƒ“ãƒ¼ã«æˆ»ã£ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚\n\nåŸå› :\nâ€¢ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã®ä¸€æ™‚çš„ãªå•é¡Œ\nâ€¢ ã‚µãƒ¼ãƒãƒ¼ã¨ã®åŒæœŸã‚¨ãƒ©ãƒ¼', true);
                }
            });
            
            // å­¦ç¿’ãƒ¢ãƒ¼ãƒ‰é¸æŠæ™‚ã®é·ç§»
            socket.on('redirect_to_learning', (data) => {
                console.log('å­¦ç¿’ç”»é¢ã¸ã®é·ç§»æŒ‡ç¤ºã‚’å—ä¿¡:', data);
                showModeRedirectMessage('learning', data.message);
                setTimeout(() => {
                    proceedToSelectedMode('learning');
                }, 1500);
            });
            
            // ã‚¯ã‚¤ã‚ºãƒ¢ãƒ¼ãƒ‰é¸æŠæ™‚ã®é·ç§»
            socket.on('redirect_to_matching', (data) => {
                console.log('ãƒãƒƒãƒãƒ³ã‚°ç”»é¢ã¸ã®é·ç§»æŒ‡ç¤ºã‚’å—ä¿¡:', data);
                showModeRedirectMessage('quiz', data.message);
                setTimeout(() => {
                    proceedToSelectedMode('quiz');
                }, 1500);
            });
            
            return socket;
        }
        
        function initializeSocket() {
            ensureSocket();
        }
        
        // ãƒ¢ãƒ¼ãƒ‰é¸æŠ
        function selectMode(mode) {
            if (userRole === 'guest') {
                // Guestã¯ä¸»å‚¬è€…ã®é¸æŠã‚’å¾…ã¤
                showGuestWaitingMessage();
                return;
            }
            
            selectedMode = mode;
            updateSelectedMode(mode, false);
            
            // Ownerã®å ´åˆã€è‡ªå‹•çš„ã«ãƒ¢ãƒ¼ãƒ‰ã‚’é–‹å§‹
            if (userRole === 'owner') {
                setTimeout(() => {
                    startSelectedMode();
                }, 1500); // 1.5ç§’å¾Œã«è‡ªå‹•é–‹å§‹
            }
        }
        
        function updateSelectedMode(mode, isForced = false) {
            // å…¨ã‚«ãƒ¼ãƒ‰ã®é¸æŠçŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
            document.querySelectorAll('.wa-mode-card-large').forEach(card => {
                card.classList.remove('selected');
            });
            
            // é¸æŠã•ã‚ŒãŸã‚«ãƒ¼ãƒ‰ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
            document.querySelector(`[data-mode="${mode}"]`).classList.add('selected');
            
            // ã‚¬ã‚¤ãƒ€ãƒ³ã‚¹è¡¨ç¤º
            showModeGuidance(mode, isForced);
            
            // è‡ªå‹•ãƒ¢ãƒ¼ãƒ‰é–‹å§‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®çŠ¶æ…‹æ›´æ–°
            const autoModeMessage = document.getElementById('autoModeMessage');
            const autoModeIcon = document.getElementById('autoModeIcon');
            const autoModeText = document.getElementById('autoModeText');
            const statusSelection = document.getElementById('statusSelection');
            
            if (userRole === 'owner') {
                // Ownerã®å ´åˆã¯è‡ªå‹•ãƒ¢ãƒ¼ãƒ‰é–‹å§‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
                autoModeMessage.style.display = 'block';
                
                if (mode === 'learning') {
                    autoModeIcon.textContent = 'ğŸŒ¸';
                    autoModeText.textContent = 'å­¦ç¿’ãƒ¢ãƒ¼ãƒ‰ã‚’é–‹å§‹ã—ã¦ã„ã¾ã™...';
                    statusSelection.textContent = 'å­¦ç¿’ãƒ¢ãƒ¼ãƒ‰';
                    statusSelection.style.color = 'var(--take)';
                } else if (mode === 'quiz') {
                    autoModeIcon.textContent = 'âš”ï¸';
                    autoModeText.textContent = 'ã‚¯ã‚¤ã‚ºãƒ¢ãƒ¼ãƒ‰ã‚’é–‹å§‹ã—ã¦ã„ã¾ã™...';
                    statusSelection.textContent = 'ã‚¯ã‚¤ã‚ºãƒ¢ãƒ¼ãƒ‰';
                    statusSelection.style.color = 'var(--enjhi)';
                }
            }
        }
        
        function showModeGuidance(mode, isForced) {
            const guidance = document.getElementById('selectionGuidance');
            const guidanceTitle = document.getElementById('guidanceTitle');
            const guidanceContent = document.getElementById('guidanceContent');
            
            guidance.style.display = 'block';
            
            if (mode === 'learning') {
                guidanceTitle.textContent = 'ğŸŒ¸ å­¦ç¿’ãƒ¢ãƒ¼ãƒ‰ã«ã¤ã„ã¦';
                if (isForced) {
                    guidanceContent.textContent = 
                        'ä¸»å‚¬è€…ãŒå­¦ç¿’ãƒ¢ãƒ¼ãƒ‰ã‚’é¸æŠã—ã¾ã—ãŸã€‚ç¾ã—ã„ç‰©èªã‚’å…±ã«èª­ã¿é€²ã‚ã€çŸ¥è­˜ã‚’æ·±ã‚ã¦ã¾ã„ã‚Šã¾ã—ã‚‡ã†ã€‚';
                } else {
                    guidanceContent.textContent = 
                        'å­¦ç¿’ãƒ¢ãƒ¼ãƒ‰ã§ã¯ã€ä¸»å‚¬è€…ã®æ“ä½œã«åˆã‚ã›ã¦å‚åŠ è€…ã®ç”»é¢ã‚‚åŒæœŸã•ã‚Œã¾ã™ã€‚ç¾ã—ã„ç‰©èªã‚’å…±ã«èª­ã¿é€²ã‚ã€çŸ¥è­˜ã‚’æ·±ã‚ã¦ã¾ã„ã‚Šã¾ã—ã‚‡ã†ã€‚';
                }
            } else if (mode === 'quiz') {
                guidanceTitle.textContent = 'âš”ï¸ ã‚¯ã‚¤ã‚ºãƒ¢ãƒ¼ãƒ‰ã«ã¤ã„ã¦';
                if (isForced) {
                    guidanceContent.textContent = 
                        'ä¸»å‚¬è€…ãŒã‚¯ã‚¤ã‚ºãƒ¢ãƒ¼ãƒ‰ã‚’é¸æŠã—ã¾ã—ãŸã€‚å­¦ã‚“ã çŸ¥è­˜ã‚’æ­¦å™¨ã«ã€è¯éº—ãªã‚‹å¯¾æˆ¦ã«æŒ‘ã¿ã¾ã—ã‚‡ã†ã€‚';
                } else {
                    guidanceContent.textContent = 
                        'ã‚¯ã‚¤ã‚ºãƒ¢ãƒ¼ãƒ‰ã§ã¯ã€ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§å¯¾æˆ¦ã‚’è¡Œã„ã¾ã™ã€‚åˆ¶é™æ™‚é–“å†…ã«æ­£è§£ã‚’ç›®æŒ‡ã—ã€äº’ã„ã®å®ŸåŠ›ã‚’ç«¶ã„åˆã„ã¾ã—ã‚‡ã†ã€‚';
                }
            }
        }
        
        function showGuestWaitingMessage() {
            // GuestãŒç›´æ¥ãƒ¢ãƒ¼ãƒ‰ã‚’é¸æŠã—ã‚ˆã†ã¨ã—ãŸå ´åˆã®æ¡ˆå†…
            const modal = document.createElement('div');
            modal.className = 'wa-modal active';
            modal.innerHTML = `
                <div class="wa-modal-content">
                    <h3 style="color: var(--ai); margin-bottom: 1rem;">ğŸ‹ å‚åŠ è€…æ§˜ã¸ã®ã”æ¡ˆå†…</h3>
                    <p style="margin-bottom: 1.5rem;">
                        å­¦ç¿’æ–¹å¼ã®é¸æŠã¯ä¸»å‚¬è€…æ§˜ãŒè¡Œã„ã¾ã™ã€‚<br>
                        ä¸»å‚¬è€…æ§˜ã®é¸æŠã‚’ãŠå¾…ã¡ãã ã•ã„ã€‚é¸æŠã•ã‚Œã‚‹ã¨è‡ªå‹•çš„ã«é©åˆ‡ãªç”»é¢ã¸ç§»å‹•ã„ãŸã—ã¾ã™ã€‚
                    </p>
                    <div style="text-align: center; margin: 1rem 0;">
                        <div class="wa-waiting-animation">
                            <div class="wa-waiting-dot"></div>
                            <div class="wa-waiting-dot"></div>
                            <div class="wa-waiting-dot"></div>
                        </div>
                    </div>
                    <button class="wa-btn wa-btn-primary" onclick="this.closest('.wa-modal').remove()">
                        æ‰¿çŸ¥ã„ãŸã—ã¾ã—ãŸ
                    </button>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        // é¸æŠã•ã‚ŒãŸãƒ¢ãƒ¼ãƒ‰é–‹å§‹
        function startSelectedMode() {
            if (!selectedMode) {
                alert('ã¾ãšå­¦ç¿’æ–¹å¼ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            
            if (userRole !== 'owner') {
                showError('ä¸»å‚¬è€…ã®ã¿ãŒãƒ¢ãƒ¼ãƒ‰ã‚’é¸æŠã§ãã¾ã™ã€‚');
                return;
            }
            
            console.log(`é¸æŠã•ã‚ŒãŸãƒ¢ãƒ¼ãƒ‰: ${selectedMode}`);

            // ã‚µãƒ¼ãƒãƒ¼ã«é¸æŠã‚’é€šçŸ¥
            if (socket && socket.connected) {
                if (selectedMode === 'learning') {
                    socket.emit('select_learning_mode', { roomId: roomId });
                } else if (selectedMode === 'quiz') {
                    socket.emit('select_quiz_mode', { roomId: roomId });
                }
            } else {
                showError('ã‚µãƒ¼ãƒãƒ¼ã¨ã®æ¥ç¶šãŒç¢ºç«‹ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
            }
        }
        
        function proceedToSelectedMode(mode, data = {}) {
            const params = new URLSearchParams({
                role: userRole,
                roomId: roomId,
                playerName: playerName
            });
            
            if (mode === 'learning') {
                window.location.href = `learning.html?${params.toString()}`;
            } else if (mode === 'quiz') {
                window.location.href = `matching.html?${params.toString()}`;
            }
        }
        
        // æ¥ç¶šçŠ¶æ…‹æ›´æ–°
        function updateConnectionStatus(status) {
            const statusText = document.querySelector('.wa-status .wa-status-item span:last-child');
            if (statusText) {
                switch (status) {
                    case 'connecting':
                        statusText.textContent = 'æ¥ç¶šçŠ¶æ…‹: æ¥ç¶šä¸­...';
                        break;
                    case 'connected':
                        statusText.textContent = 'æ¥ç¶šçŠ¶æ…‹: æº–å‚™å®Œäº†';
                        break;
                    case 'error':
                        statusText.textContent = 'æ¥ç¶šçŠ¶æ…‹: æ¥ç¶šã‚¨ãƒ©ãƒ¼';
                        break;
                    case 'disconnected':
                        statusText.textContent = 'æ¥ç¶šçŠ¶æ…‹: åˆ‡æ–­ã•ã‚Œã¾ã—ãŸ';
                        break;
                }
            }
        }

        // ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
        function showError(message, isDetailedError = false) {
            const modal = document.createElement('div');
            modal.className = 'wa-modal active';
            
            // è©³ç´°ã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯æ”¹è¡Œã‚’é©åˆ‡ã«å‡¦ç†
            const formattedMessage = isDetailedError ? 
                message.replace(/\n/g, '<br>') : message;
            
            modal.innerHTML = `
                <div class="wa-modal-content">
                    <h3 style="color: var(--enjhi); margin-bottom: 1rem;">âš ï¸ ã‚¨ãƒ©ãƒ¼</h3>
                    <div style="margin-bottom: 1.5rem; text-align: left; line-height: 1.6;">${formattedMessage}</div>
                    <div style="display: flex; gap: 1rem; justify-content: center;">
                        <button class="wa-btn wa-btn-primary" onclick="this.closest('.wa-modal').remove(); goBack();">
                            ãƒ­ãƒ“ãƒ¼ã«æˆ»ã‚‹
                        </button>
                        <button class="wa-btn wa-btn-secondary" onclick="this.closest('.wa-modal').remove();">
                            å†è©¦è¡Œ
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // ãƒ¢ãƒ¼ãƒ‰é·ç§»ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
        function showModeRedirectMessage(mode, message) {
            const modal = document.createElement('div');
            modal.className = 'wa-modal active';
            const modeIcon = mode === 'learning' ? 'ğŸ“š' : 'âš”ï¸';
            const modeTitle = mode === 'learning' ? 'å­¦ç¿’ãƒ¢ãƒ¼ãƒ‰' : 'ã‚¯ã‚¤ã‚ºãƒ¢ãƒ¼ãƒ‰';
            
            modal.innerHTML = `
                <div class="wa-modal-content">
                    <h3 style="color: var(--take); margin-bottom: 1rem;">${modeIcon} ${modeTitle}é–‹å§‹</h3>
                    <p style="margin-bottom: 1.5rem;">${message}</p>
                    <div class="wa-loading">
                        <div class="wa-loading-spinner"></div>
                        <p>ç”»é¢ã‚’é·ç§»ã—ã¦ã„ã¾ã™...</p>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // å¾…æ©Ÿæ™‚é–“ã‚¿ã‚¤ãƒãƒ¼
        function startWaitingTimer() {
            setInterval(() => {
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                const minutes = Math.floor(elapsed / 60).toString().padStart(2, '0');
                const seconds = (elapsed % 60).toString().padStart(2, '0');
                document.getElementById('waitingTime').textContent = `${minutes}:${seconds}`;
            }, 1000);
        }
        
        // å­£ç¯€è£…é£¾ã®ç”Ÿæˆ
        function generateSeasonalElements() {
            const container = document.getElementById('seasonalDecoration');
            const elements = [
                { class: 'sakura-petal', count: 4 },
                { class: 'momiji-leaf', count: 2 }
            ];
            
            elements.forEach(({ class: className, count }) => {
                for (let i = 0; i < count; i++) {
                    const element = document.createElement('div');
                    element.className = className;
                    element.style.left = Math.random() * 100 + '%';
                    element.style.animationDelay = Math.random() * 8 + 's';
                    element.style.animationDuration = (6 + Math.random() * 4) + 's';
                    container.appendChild(element);
                }
            });
        }
        
        function goBack() {
            if (socket && socket.connected) {
                console.log('Socketåˆ‡æ–­ä¸­...');
                try {
                    socket.disconnect();
                } catch (error) {
                    console.error('Socketåˆ‡æ–­ã‚¨ãƒ©ãƒ¼:', error);
                }
                socket = null;
            }
            // åˆ‡æ–­å‡¦ç†ã®å®Œäº†ã‚’å°‘ã—å¾…ã£ã¦ã‹ã‚‰é·ç§»
            setTimeout(() => {
                window.location.href = `lobby.html?role=${userRole}`;
            }, 100);
        }
        
        // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ
        document.addEventListener('keydown', (e) => {
            switch (e.key) {
                case '1':
                    if (userRole === 'owner') selectMode('learning');
                    break;
                case '2':
                    if (userRole === 'owner') selectMode('quiz');
                    break;
                case 'Enter':
                    if (selectedMode) {
                        startSelectedMode();
                    }
                    break;
                case 'Escape':
                    goBack();
                    break;
            }
        });
        
        // ãƒšãƒ¼ã‚¸é›¢è„±æ™‚ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
        window.addEventListener('beforeunload', () => {
            if (socket && socket.connected) {
                try {
                    socket.disconnect();
                } catch (error) {
                    console.error('ãƒšãƒ¼ã‚¸é›¢è„±æ™‚ã®Socketåˆ‡æ–­ã‚¨ãƒ©ãƒ¼:', error);
                }
                socket = null;
            }
        });
    </script>

    <style>
        .wa-section-title {
            font-family: var(--font-accent);
            font-size: 1.8rem;
            color: var(--enjhi);
            text-align: center;
            margin-bottom: var(--spacing-xl);
            text-shadow: 1px 1px 0px rgba(178, 45, 53, 0.1);
        }

        .wa-room-info {
            background: var(--gradient-sakura);
            border: 2px solid var(--enjhi);
            border-radius: var(--border-radius-large);
            padding: var(--spacing-lg);
            margin-bottom: var(--spacing-xxl);
        }

        .wa-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--spacing-md);
        }

        .wa-info-item {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-sm);
            background: rgba(255, 255, 255, 0.3);
            border-radius: var(--border-radius);
        }

        .wa-info-icon {
            font-size: 1.5rem;
            width: 24px;
            text-align: center;
        }

        .wa-info-label {
            font-family: var(--font-ui);
            font-weight: 600;
            color: var(--sumi);
            min-width: 50px;
        }

        .wa-info-value {
            font-family: var(--font-main);
            color: var(--enjhi);
            font-weight: 500;
        }

        .wa-mode-cards-large {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: var(--spacing-xxl);
            margin: var(--spacing-xxl) 0;
        }

        .wa-mode-card-large {
            background: var(--gradient-washi);
            border: 3px solid var(--ai);
            border-radius: var(--border-radius-large);
            padding: var(--spacing-xxl);
            cursor: pointer;
            transition: all 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            position: relative;
            overflow: hidden;
            min-height: 500px;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        .wa-mode-card-large::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(178, 45, 53, 0.1) 0%, transparent 70%);
            transform: scale(0);
            transition: transform 0.8s ease;
        }

        .wa-mode-card-large:hover::before {
            transform: scale(1);
        }

        .wa-mode-card-large:hover {
            transform: translateY(-10px) scale(1.03);
            border-color: var(--enjhi);
            box-shadow: 
                var(--shadow-strong),
                0 0 40px rgba(178, 45, 53, 0.3);
        }

        .wa-mode-card-large.selected {
            background: var(--gradient-sakura);
            border-color: var(--enjhi);
            border-width: 4px;
            transform: translateY(-8px) scale(1.02);
            box-shadow: 
                var(--shadow-strong),
                0 0 30px rgba(178, 45, 53, 0.4);
        }

        .wa-mode-decoration {
            position: absolute;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .wa-decoration-element {
            position: absolute;
            font-size: 2rem;
            opacity: 0.1;
            animation: decorationFloat 6s ease-in-out infinite;
        }

        .wa-decoration-element:nth-child(1) {
            top: 10%;
            right: 15%;
            animation-delay: 0s;
        }

        .wa-decoration-element:nth-child(2) {
            bottom: 20%;
            left: 10%;
            animation-delay: 2s;
        }

        .wa-decoration-element:nth-child(3) {
            top: 60%;
            right: 10%;
            animation-delay: 4s;
        }

        @keyframes decorationFloat {
            0%, 100% { transform: translateY(0) rotate(0deg); opacity: 0.1; }
            50% { transform: translateY(-10px) rotate(180deg); opacity: 0.3; }
        }

        .wa-mode-icon-large {
            font-size: 5rem;
            margin-bottom: var(--spacing-lg);
            animation: iconPulse 3s ease-in-out infinite;
        }

        @keyframes iconPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .wa-mode-title-large {
            font-family: var(--font-accent);
            font-size: 2rem;
            font-weight: 800;
            color: var(--enjhi);
            margin-bottom: var(--spacing-sm);
            text-shadow: 2px 2px 0px rgba(178, 45, 53, 0.1);
        }

        .wa-mode-subtitle {
            font-family: var(--font-main);
            font-size: 1.1rem;
            color: var(--ai);
            margin-bottom: var(--spacing-lg);
            font-style: italic;
        }

        .wa-mode-description-large {
            font-family: var(--font-main);
            font-size: 1rem;
            line-height: 1.8;
            color: var(--sumi);
            margin-bottom: var(--spacing-lg);
            text-align: center;
        }

        .wa-mode-details {
            width: 100%;
            margin-bottom: var(--spacing-lg);
        }

        .wa-mode-details h4 {
            font-family: var(--font-ui);
            color: var(--enjhi);
            margin-bottom: var(--spacing-md);
            text-align: center;
        }

        .wa-subject-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: var(--spacing-xs);
        }

        .wa-subject-item {
            background: rgba(22, 94, 131, 0.1);
            color: var(--ai);
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: var(--border-radius);
            font-size: 0.85rem;
            text-align: center;
            border: 1px solid rgba(22, 94, 131, 0.2);
        }

        .wa-battle-info {
            display: flex;
            justify-content: space-around;
            gap: var(--spacing-md);
        }

        .wa-battle-rule {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--spacing-xs);
        }

        .wa-rule-number {
            font-size: 2rem;
            font-weight: 800;
            color: var(--enjhi);
            line-height: 1;
        }

        .wa-rule-text {
            font-size: 0.9rem;
            color: var(--sumi);
        }

        .wa-mode-features-large {
            width: 100%;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: var(--spacing-sm);
            margin-top: auto;
        }

        .wa-feature-large {
            background: rgba(47, 82, 51, 0.1);
            color: var(--take);
            padding: var(--spacing-sm);
            border-radius: var(--border-radius);
            font-size: 0.85rem;
            text-align: center;
            border: 1px solid rgba(47, 82, 51, 0.2);
            font-weight: 500;
        }

        .wa-selection-guidance {
            margin: var(--spacing-xl) 0;
        }

        .wa-btn-group-large {
            display: flex;
            gap: var(--spacing-lg);
            justify-content: center;
            margin: var(--spacing-xxl) 0;
        }

        .wa-btn-large {
            padding: var(--spacing-lg) var(--spacing-xxl);
            font-size: 1.1rem;
        }

        .wa-notices {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: var(--spacing-lg);
            margin: var(--spacing-xxl) 0;
        }

        .wa-notice-card {
            background: var(--gradient-washi);
            border: 2px solid var(--take);
            border-radius: var(--border-radius);
            padding: var(--spacing-lg);
        }

        .wa-notice-card h4 {
            color: var(--take);
            margin-bottom: var(--spacing-md);
            font-family: var(--font-ui);
        }

        .wa-notice-card ul {
            padding-left: var(--spacing-lg);
            list-style-type: none;
        }

        .wa-notice-card li {
            position: relative;
            margin-bottom: var(--spacing-sm);
            color: var(--sumi);
            line-height: 1.6;
        }

        .wa-notice-card li::before {
            content: 'ğŸŒ¸';
            position: absolute;
            left: -1.5rem;
            top: 0;
        }

        .wa-status-dot.connected {
            background: var(--take);
            animation: statusPulse 2s infinite;
        }
        
        .wa-status-dot.error {
            background: var(--enjhi);
            animation: none;
        }
        
        .wa-status-dot.disconnected {
            background: #999;
            animation: none;
        }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ«ã¨ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° */
        .wa-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .wa-modal.active {
            display: flex;
        }

        .wa-modal-content {
            background: var(--washi);
            border: 3px solid var(--enjhi);
            border-radius: var(--border-radius-large);
            padding: var(--spacing-xl);
            max-width: 500px;
            width: 90%;
            text-align: center;
            box-shadow: var(--shadow-strong);
        }

        .wa-loading {
            margin-top: var(--spacing-lg);
        }

        .wa-loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--ai);
            border-top: 4px solid var(--enjhi);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto var(--spacing-md) auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .wa-loading p {
            color: var(--sumi);
            font-style: italic;
        }
        
        /* å¾…æ©Ÿã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆå…±é€šï¼‰ */
        .wa-waiting-animation {
            display: flex;
            justify-content: center;
            gap: var(--spacing-xs);
            margin: var(--spacing-sm) 0;
        }

        .wa-waiting-dot {
            width: 8px;
            height: 8px;
            background: var(--enjhi);
            border-radius: 50%;
            animation: wa-waiting-pulse 1.4s ease-in-out infinite both;
        }

        .wa-waiting-dot:nth-child(1) { animation-delay: -0.32s; }
        .wa-waiting-dot:nth-child(2) { animation-delay: -0.16s; }
        .wa-waiting-dot:nth-child(3) { animation-delay: 0s; }

        @keyframes wa-waiting-pulse {
            0%, 80%, 100% {
                transform: scale(0);
                opacity: 0.5;
            }
            40% {
                transform: scale(1);
                opacity: 1;
            }
        }

        @media (max-width: 768px) {
            .wa-mode-cards-large {
                grid-template-columns: 1fr;
                gap: var(--spacing-xl);
            }
            
            .wa-mode-card-large {
                min-height: 400px;
                padding: var(--spacing-xl);
            }
            
            .wa-mode-icon-large {
                font-size: 4rem;
            }
            
            .wa-mode-title-large {
                font-size: 1.8rem;
            }
            
            .wa-info-grid {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            }
            
            .wa-btn-group-large {
                flex-direction: column;
            }
            
            .wa-notices {
                grid-template-columns: 1fr;
            }
            
            .wa-battle-info {
                flex-direction: column;
                align-items: center;
            }

            .wa-modal-content {
                width: 95%;
                padding: var(--spacing-lg);
            }
        }
    </style>
</body>
</html>
