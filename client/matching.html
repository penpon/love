<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é›…ãªã‚‹å¯¾æˆ¦ã®é–“ - CSå­¦ç¿’ã‚¯ã‚¤ã‚ºãƒãƒˆãƒ«</title>
    <link rel="stylesheet" href="css/taisho.css">
</head>
<body>
    <!-- å››å­£ã®è£…é£¾è¦ç´  -->
    <div class="seasonal-decoration" id="seasonalDecoration"></div>

    <main class="washi-container wa-fade-in">
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <header class="wa-header">
            <h1 class="wa-title">é›…ãªã‚‹å¯¾æˆ¦ã®é–“</h1>
            <p class="wa-subtitle">CSé›…å­¦ã‚¯ã‚¤ã‚ºãƒãƒˆãƒ« - å¿ƒã¨çŸ¥è­˜ã‚’è³­ã—ãŸè¯éº—ãªã‚‹æˆ¦ã„</p>
            <div class="wa-divider"></div>
        </header>

        <!-- ãƒ«ãƒ¼ãƒ æƒ…å ±è¡¨ç¤º -->
        <section class="wa-room-info">
            <div class="wa-card">
                <div class="wa-card-title">ğŸ›ï¸ é›…å­¦ã®é–“</div>
                <div class="wa-card-content">
                    <div class="wa-info-row">
                        <span class="wa-info-label">é–“ã®å:</span>
                        <span class="wa-info-value" id="roomIdDisplay"></span>
                    </div>
                    <div class="wa-info-row">
                        <span class="wa-info-label">ã‚ãªãŸã®é›…å·:</span>
                        <span class="wa-info-value" id="playerNameDisplay"></span>
                    </div>
                    <div class="wa-info-row">
                        <span class="wa-info-label">å½¹å‰²:</span>
                        <span class="wa-info-value" id="roleDisplay">æœªè¨­å®š</span>
                    </div>
                </div>
            </div>
        </section>

        <!-- ãƒãƒƒãƒãƒ³ã‚°çŠ¶æ…‹ -->
        <section class="wa-matching-status" id="matchingStatus">
            <div class="wa-loading-animation">
                <div class="wa-spinner"></div>
                <div class="wa-loading-text">é›…ãªã‚‹å¯¾æˆ¦ç›¸æ‰‹ã‚’æ¢ã—ã¦ãŠã‚Šã¾ã™...</div>
                <div class="wa-loading-dots">
                    <span class="wa-dot"></span>
                    <span class="wa-dot"></span>
                    <span class="wa-dot"></span>
                </div>
            </div>
        </section>

        <!-- å¯¾æˆ¦è€…ä¸€è¦§ -->
        <section class="wa-players-list" id="playersList" style="display: none;">
            <h3 class="wa-section-title">âš”ï¸ é›…ãªã‚‹æˆ¦å£«ãŸã¡</h3>
            <div class="wa-player-cards">
                <div class="wa-player-card" id="player1">
                    <div class="wa-player-avatar">ğŸŒ¸</div>
                    <div class="wa-player-info">
                        <div class="wa-player-name">å¾…æ©Ÿä¸­...</div>
                        <div class="wa-player-status">æº–å‚™ä¸­</div>
                        <div class="wa-player-role" id="player1Role"></div>
                    </div>
                </div>
                
                <div class="wa-vs-divider">
                    <span class="wa-vs-text">VS</span>
                    <div class="wa-heart-separator">ğŸŒŒ</div>
                </div>
                
                <div class="wa-player-card" id="player2">
                    <div class="wa-player-avatar">ğŸŒº</div>
                    <div class="wa-player-info">
                        <div class="wa-player-name">å¾…æ©Ÿä¸­...</div>
                        <div class="wa-player-status">æº–å‚™ä¸­</div>
                        <div class="wa-player-role" id="player2Role"></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- æº–å‚™ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <section class="wa-ready-section" id="readySection" style="display: none;">
            <div class="wa-card">
                <div class="wa-card-title">âš¡ é›…å­¦å¯¾æˆ¦ã®è¦å‰‡</div>
                <div class="wa-card-content">
                    <div class="wa-battle-rules">
                        <div class="wa-rule">ğŸ“œ å…¨5å•ã®å››é¸ä¸€å•</div>
                        <div class="wa-rule">ğŸŒ¸ 1å•30ç§’ã®æ™‚ã®åˆ¶é™</div>
                        <div class="wa-rule">ğŸ… æ­£è§£ã§åèª‰ã‚’ç²å¾—</div>
                        <div class="wa-rule">âœ¨ è¿…é€Ÿãªã‚‹ç­”ãˆã§ç‰¹åˆ¥åŠ ç‚¹</div>
                        <div class="wa-rule">ğŸ† æœ€é«˜å¾—ç‚¹è€…ãŒå‹åˆ©ã®æ „å† </div>
                    </div>
                </div>
            </div>
            
            <div class="wa-btn-group" style="margin-top: 2rem;">
                <button class="wa-btn wa-btn-primary" id="readyBtn" onclick="playerReady()">
                    <span>âš”ï¸</span>
                    <span>æº–å‚™ã‚ˆã‚ã—</span>
                </button>
            </div>
        </section>

        <!-- ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
        <div class="wa-countdown-overlay" id="countdownOverlay" style="display: none;">
            <div class="wa-countdown-content">
                <div class="wa-countdown-title">âš”ï¸ é›…ãªã‚‹å¯¾æˆ¦é–‹å§‹</div>
                <div class="wa-countdown-number" id="countdownNumber">3</div>
                <div class="wa-countdown-message">å¿ƒã®æº–å‚™ã¯ã„ã‹ãŒã§ã—ã‚‡ã†ã‹</div>
            </div>
        </div>

        <!-- æ¥ç¶šçŠ¶æ…‹ -->
        <div class="wa-connection-status">
            <div class="wa-status-indicator" id="connectionStatus">
                <span class="wa-status-dot success"></span>
                <span class="wa-status-text">é›…ãªã‚‹é–“ã«æ¥ç¶šä¸­...</span>
            </div>
        </div>

        <!-- æˆ»ã‚‹ãƒœã‚¿ãƒ³ -->
        <div class="wa-btn-group" style="margin-top: 2rem;">
            <button class="wa-btn wa-btn-secondary" onclick="goBack()">
                <span>ğŸ </span>
                <span>é›…å­¦ã®é–“ã‚’å‡ºã‚‹</span>
            </button>
        </div>
    </main>


    <script src="/socket.io/socket.io.js"></script>
    <script src="js/socket.js"></script>
    <script>
        // URL ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰æƒ…å ±ã‚’å–å¾—
        const urlParams = new URLSearchParams(window.location.search);
        const roomId = urlParams.get('roomId');
        const playerName = urlParams.get('playerName');
        const userRole = urlParams.get('role') || 'guest';
        
        if (!roomId || !playerName) {
            alert('ãƒ«ãƒ¼ãƒ æƒ…å ±ãŒä¸æ­£ã§ã™ã€‚ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã«æˆ»ã‚Šã¾ã™ã€‚');
            window.location.href = 'index.html';
        }
        
        // è¡¨ç¤ºã‚’æ›´æ–°
        document.getElementById('roomIdDisplay').textContent = roomId;
        document.getElementById('playerNameDisplay').textContent = playerName;
        
        // å½¹å‰²è¡¨ç¤º
        const roleDisplay = document.getElementById('roleDisplay');
        if (userRole === 'owner') {
            roleDisplay.textContent = 'ğŸ‘‘ ä¸»å‚¬è€…';
        } else {
            roleDisplay.textContent = 'ğŸ‹ å‚åŠ è€…';
        }
        
        let socket;
        let isReady = false;
        let matchFound = false;
        
        // Socket.io æ¥ç¶š
        function initializeSocket() {
            socket = io();
            
            socket.on('connect', () => {
                console.log('ã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã—ã¾ã—ãŸ');
                document.getElementById('connectionStatus').innerHTML = 
                    '<span class="wa-status-dot success"></span><span class="wa-status-text">æº–å‚™å®Œäº†</span>';
                
                // ãƒ«ãƒ¼ãƒ ã«å‚åŠ 
                socket.emit('join_room', { roomId, playerName, role: userRole, mode: 'quiz' });
            });
            
            socket.on('disconnect', () => {
                console.log('ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰åˆ‡æ–­ã•ã‚Œã¾ã—ãŸ');
                document.getElementById('connectionStatus').innerHTML = 
                    '<span class="wa-status-dot error"></span><span class="wa-status-text">æ¥ç¶šãŒåˆ‡æ–­ã•ã‚Œã¾ã—ãŸ</span>';
            });
            
            socket.on('room_full', () => {
                alert('ã“ã®ãƒ«ãƒ¼ãƒ ã¯æº€å®¤ã§ã™ã€‚åˆ¥ã®ãƒ«ãƒ¼ãƒ IDã‚’ãŠè©¦ã—ãã ã•ã„ã€‚');
                window.location.href = 'index.html';
            });
            
            socket.on('room_status', (data) => {
                console.log('ãƒ«ãƒ¼ãƒ çŠ¶æ³æ›´æ–°:', data);
                updateRoomStatus(data);
            });
            
            socket.on('match_found', (data) => {
                console.log('ãƒãƒƒãƒãƒ³ã‚°æˆåŠŸ:', data);
                matchFound = true;
                showMatchFound(data);
            });
            
            socket.on('player_disconnected', (data) => {
                alert(`${data.playerName}ã•ã‚“ãŒåˆ‡æ–­ã•ã‚Œã¾ã—ãŸã€‚`);
                location.reload();
            });
            
            // ã‚¯ã‚¤ã‚ºé–‹å§‹
            socket.on('new_question', (data) => {
                console.log('ã‚¯ã‚¤ã‚ºé–‹å§‹:', data);
                // ã‚¯ã‚¤ã‚ºç”»é¢ã«é·ç§»
                window.location.href = `quiz.html?roomId=${encodeURIComponent(roomId)}&playerName=${encodeURIComponent(playerName)}&role=${encodeURIComponent(userRole)}`;
            });
        }
        
        function updateRoomStatus(data) {
            const players = data.players;
            const playerCount = players.length;
            
            if (playerCount === 2) {
                // 2äººæƒã£ãŸå ´åˆ
                document.getElementById('matchingStatus').style.display = 'none';
                document.getElementById('playersList').style.display = 'block';
                document.getElementById('readySection').style.display = 'block';
                
                // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æƒ…å ±ã‚’è¡¨ç¤º
                const player1Card = document.getElementById('player1');
                const player2Card = document.getElementById('player2');
                
                player1Card.querySelector('.wa-player-name').textContent = players[0].name;
                player1Card.querySelector('.wa-player-status').textContent = players[0].ready ? 'æº–å‚™å®Œäº†' : 'æº–å‚™ä¸­';
                player1Card.classList.toggle('ready', players[0].ready);
                
                player2Card.querySelector('.wa-player-name').textContent = players[1].name;
                player2Card.querySelector('.wa-player-status').textContent = players[1].ready ? 'æº–å‚™å®Œäº†' : 'æº–å‚™ä¸­';
                player2Card.classList.toggle('ready', players[1].ready);
                
                // å½¹å‰²è¡¨ç¤º
                const player1Role = document.getElementById('player1Role');
                const player2Role = document.getElementById('player2Role');
                
                player1Role.textContent = players[0].role === 'owner' ? 'ğŸ‘‘ ä¸»å‚¬' : 'ğŸ‹ å‚åŠ ';
                player2Role.textContent = players[1].role === 'owner' ? 'ğŸ‘‘ ä¸»å‚¬' : 'ğŸ‹ å‚åŠ ';
                
                // è‡ªåˆ†ã®ã‚«ãƒ¼ãƒ‰ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
                if (players[0].name === playerName) {
                    player1Card.classList.add('self');
                } else {
                    player2Card.classList.add('self');
                }
            } else {
                // å¾…æ©Ÿä¸­
                document.getElementById('matchingStatus').style.display = 'block';
                document.getElementById('playersList').style.display = 'none';
                document.getElementById('readySection').style.display = 'none';
            }
        }
        
        function showMatchFound(data) {
            // ãƒãƒƒãƒãƒ³ã‚°æˆåŠŸã®ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
            document.getElementById('matchingStatus').innerHTML = 
                '<div class="wa-match-found"><div class="wa-match-icon">ğŸŒ¸</div><div class="wa-match-text">é›…ãªã‚‹å‡ºä¼šã„æˆã‚ŠãŸã‚Šï¼</div></div>';
        }
        
        function playerReady() {
            if (!isReady) {
                isReady = true;
                socket.emit('player_ready');
                
                const readyBtn = document.getElementById('readyBtn');
                readyBtn.innerHTML = '<span>âœ…</span><span>æº–å‚™æ•´ã„ã¾ã—ãŸ</span>';
                readyBtn.classList.add('ready');
                readyBtn.disabled = true;
                
                // ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³é–‹å§‹ï¼ˆä¸¡æ–¹æº–å‚™å®Œäº†ã®å ´åˆï¼‰
                setTimeout(() => {
                    if (document.querySelectorAll('.wa-player-card.ready').length === 2) {
                        startCountdown();
                    }
                }, 1000);
            }
        }
        
        function startCountdown() {
            document.getElementById('countdownOverlay').style.display = 'flex';
            let count = 3;
            
            const countdownInterval = setInterval(() => {
                document.getElementById('countdownNumber').textContent = count;
                
                if (count <= 0) {
                    clearInterval(countdownInterval);
                    document.getElementById('countdownOverlay').style.display = 'none';
                } else {
                    count--;
                }
            }, 1000);
        }
        
        function goBack() {
            if (socket) {
                socket.disconnect();
            }
            window.location.href = 'index.html';
        }
        
        // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã®åˆæœŸåŒ–
        window.onload = () => {
            initializeSocket();
            
            // å››å­£è£…é£¾ã®åˆæœŸåŒ–
            generateSeasonalElements('spring');
            setInterval(() => changeSeason(), 45000);
        };
        
        // å››å­£è£…é£¾é–¢æ•°ï¼ˆindex.htmlã‹ã‚‰æµç”¨ï¼‰
        const seasons = ['spring', 'summer', 'autumn', 'winter'];
        let currentSeasonIndex = 0;
        
        function changeSeason() {
            const seasonElement = document.getElementById('seasonalDecoration');
            currentSeasonIndex = (currentSeasonIndex + 1) % seasons.length;
            const season = seasons[currentSeasonIndex];
            seasonElement.className = `seasonal-decoration season-${season}`;
            generateSeasonalElements(season);
        }
        
        function generateSeasonalElements(season) {
            const container = document.getElementById('seasonalDecoration');
            container.innerHTML = '';
            
            const elementCount = 4; // ãƒãƒƒãƒãƒ³ã‚°ç”»é¢ã§ã¯å°‘ãªã‚ã«
            
            for (let i = 0; i < elementCount; i++) {
                const element = document.createElement('div');
                
                switch (season) {
                    case 'spring':
                        element.className = 'sakura-petal';
                        element.style.left = Math.random() * 100 + '%';
                        element.style.animationDelay = Math.random() * 8 + 's';
                        element.style.animationDuration = (6 + Math.random() * 4) + 's';
                        break;
                        
                    case 'summer':
                        element.className = 'summer-leaf';
                        element.style.cssText = `
                            position: absolute;
                            width: 6px;
                            height: 6px;
                            background: var(--tsuyu);
                            border-radius: 50% 0 50% 0;
                            left: ${Math.random() * 100}%;
                            animation: summerSway ${4 + Math.random() * 3}s ease-in-out infinite;
                            animation-delay: ${Math.random() * 4}s;
                            opacity: 0.2;
                        `;
                        break;
                        
                    case 'autumn':
                        element.className = 'momiji-leaf';
                        element.style.left = Math.random() * 100 + '%';
                        element.style.animationDelay = Math.random() * 10 + 's';
                        element.style.animationDuration = (8 + Math.random() * 4) + 's';
                        break;
                        
                    case 'winter':
                        element.className = 'snow-flake';
                        element.innerHTML = 'â„';
                        element.style.cssText = `
                            position: absolute;
                            color: var(--yuki);
                            font-size: ${4 + Math.random() * 4}px;
                            left: ${Math.random() * 100}%;
                            animation: snowFall ${6 + Math.random() * 6}s linear infinite;
                            animation-delay: ${Math.random() * 6}s;
                            opacity: 0.4;
                        `;
                        break;
                }
                
                container.appendChild(element);
            }
        }
        
        // ãƒšãƒ¼ã‚¸é›¢è„±æ™‚ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
        window.addEventListener('beforeunload', () => {
            if (socket) {
                socket.disconnect();
            }
        });
    </script>
</body>
</html>