<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>学習方式選択 - CS学習クイズバトル</title>
    <link rel="stylesheet" href="css/taisho.css">
</head>
<body>
    <!-- 四季の装飾要素 -->
    <div class="seasonal-decoration" id="seasonalDecoration"></div>

    <main class="washi-container wa-fade-in">
        <!-- ヘッダー -->
        <header class="wa-header">
            <h1 class="wa-title">学習の道を選ぶ</h1>
            <p class="wa-subtitle">美しき知識への二つの扉</p>
            <div class="wa-divider"></div>
        </header>

        <!-- ルーム情報表示 -->
        <div class="wa-room-info">
            <div class="wa-info-grid">
                <div class="wa-info-item">
                    <span class="wa-info-icon">🏮</span>
                    <span class="wa-info-label">ルーム</span>
                    <span class="wa-info-value" id="roomName">-</span>
                </div>
                <div class="wa-info-item">
                    <span class="wa-info-icon" id="roleIcon">👑</span>
                    <span class="wa-info-label">役割</span>
                    <span class="wa-info-value" id="roleName">主催者</span>
                </div>
                <div class="wa-info-item">
                    <span class="wa-info-icon">🎭</span>
                    <span class="wa-info-label">お名前</span>
                    <span class="wa-info-value" id="playerName">-</span>
                </div>
                <div class="wa-info-item">
                    <span class="wa-info-icon">👥</span>
                    <span class="wa-info-label">参加者</span>
                    <span class="wa-info-value" id="participantCount">2名</span>
                </div>
            </div>
        </div>

        <!-- モード選択 -->
        <section class="wa-mode-selection-main">
            <h2 class="wa-section-title">🌸 学習の方式をお選びください</h2>
            
            <div class="wa-mode-cards-large">
                <!-- 学習モード -->
                <div class="wa-mode-card-large" onclick="selectMode('learning')" data-mode="learning">
                    <div class="wa-mode-decoration">
                        <div class="wa-decoration-element">🌸</div>
                        <div class="wa-decoration-element">📜</div>
                        <div class="wa-decoration-element">💝</div>
                    </div>
                    
                    <div class="wa-mode-icon-large">📚</div>
                    <h3 class="wa-mode-title-large">学習モード</h3>
                    <p class="wa-mode-subtitle">美しき物語で学ぶCS</p>
                    
                    <div class="wa-mode-description-large">
                        恋愛物語に包まれながら、<br>
                        コンピューターサイエンスの神髄を<br>
                        優雅に習得いたします
                    </div>
                    
                </div>

                <!-- クイズモード -->
                <div class="wa-mode-card-large" onclick="selectMode('quiz')" data-mode="quiz">
                    <div class="wa-mode-decoration">
                        <div class="wa-decoration-element">⚔️</div>
                        <div class="wa-decoration-element">🏆</div>
                        <div class="wa-decoration-element">⚡</div>
                    </div>
                    
                    <div class="wa-mode-icon-large">⚔️</div>
                    <h3 class="wa-mode-title-large">クイズモード</h3>
                    <p class="wa-mode-subtitle">華麗なる知識の対戦</p>
                    
                    <div class="wa-mode-description-large">
                        学びし知識を武器として、<br>
                        緊張感あふれるリアルタイム対戦で<br>
                        互いの実力を競い合います
                    </div>
                    
                </div>
            </div>

            <!-- 開始ボタン -->
            <div class="wa-btn-group-large">
                <button class="wa-btn wa-btn-outline" onclick="goBack()">
                    <span>🔙</span>
                    <span>前の画面に戻る</span>
                </button>
                <!-- 学習の扉ボタンは自動遷移のため非表示 -->
                <div id="autoModeMessage" style="display: none; padding: 1rem; color: var(--take); font-size: 1.1rem; text-align: center;">
                    <span id="autoModeIcon">🌸</span>
                    <span id="autoModeText">自動的にモードを開始しています...</span>
                </div>
            </div>
        </section>

        <!-- ステータスバー -->
        <div class="wa-status">
            <div class="wa-status-item">
                <span class="wa-status-dot connected"></span>
                <span>接続状態: 準備完了</span>
            </div>
            <div class="wa-status-item">
                <span>🎌 選択状態: <span id="statusSelection">未選択</span></span>
            </div>
            <div class="wa-status-item">
                <span>⏰ 待機時間: <span id="waitingTime">00:00</span></span>
            </div>
        </div>
    </main>

    <!-- 選択ガイダンス（JSから参照） -->
    <section class="wa-selection-guidance" id="selectionGuidance" style="display: none;">
        <div class="wa-card">
            <div class="wa-card-title" id="guidanceTitle"></div>
            <div class="wa-card-content">
                <p id="guidanceContent" style="margin: 0;"></p>
            </div>
        </div>
    </section>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        // URLパラメータから情報を取得
        const urlParams = new URLSearchParams(window.location.search);
        const userRole = urlParams.get('role') || 'owner';
        const roomId = urlParams.get('roomId') || '';
        const playerName = urlParams.get('playerName') || '';
        
        let selectedMode = '';
        let socket = null;
        let startTime = Date.now();
        
        // 初期化
        document.addEventListener('DOMContentLoaded', () => {
            setupPageInfo();
            generateSeasonalElements();
            startWaitingTimer();
            initializeSocket();
            
            // アニメーション軽減設定の確認
            if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.getElementById('seasonalDecoration').style.display = 'none';
                document.querySelectorAll('.wa-decoration-element').forEach(el => {
                    el.style.animation = 'none';
                });
            }
        });
        
        // ページ情報の設定
        function setupPageInfo() {
            document.getElementById('roomName').textContent = roomId;
            document.getElementById('playerName').textContent = playerName;
            
            if (userRole === 'owner') {
                document.getElementById('roleIcon').textContent = '👑';
                document.getElementById('roleName').textContent = '主催者';
            } else {
                document.getElementById('roleIcon').textContent = '🎋';
                document.getElementById('roleName').textContent = '参加者';
            }
        }
        
        // Socket.io初期化（新しいイベントハンドラーに対応）
        function ensureSocket() {
            if (socket) return socket;
            
            socket = io({
                transports: ['websocket', 'polling'],
                timeout: 20000,
                reconnection: true,
                reconnectionAttempts: 3,
                reconnectionDelay: 1000
            });
            
            socket.on('connect', () => {
                console.log('モード選択画面でサーバーに接続:', socket.id);
                
                if (!roomId || !playerName) {
                    console.error('roomIdまたはplayerNameが不足しています');
                    return;
                }
                
                // モード選択画面での参加を通知
                socket.emit('mode_select_join', {
                    roomId: roomId,
                    playerName: playerName,
                    role: userRole
                });
                
                // 接続状態を更新
                document.querySelector('.wa-status-dot').className = 'wa-status-dot connected';
                updateConnectionStatus('connected');
            });
            
            socket.on('connect_error', (error) => {
                console.error('Socket接続エラー:', error);
                document.querySelector('.wa-status-dot').className = 'wa-status-dot error';
                updateConnectionStatus('error');
                showError('サーバーに接続できませんでした。');
            });
            
            socket.on('disconnect', (reason) => {
                console.log('Socket切断:', reason);
                document.querySelector('.wa-status-dot').className = 'wa-status-dot disconnected';
                updateConnectionStatus('disconnected');
            });
            
            // モード選択画面での接続完了
            socket.on('mode_select_connected', (data) => {
                console.log('モード選択画面での接続が完了しました:', data);
                const playerCount = data.players ? data.players.length : 0;
                document.getElementById('participantCount').textContent = `${playerCount}名`;
            });
            
            // プレイヤーの再接続通知
            socket.on('player_reconnected', (data) => {
                console.log(`${data.playerName} (${data.role}) が再接続しました`);
                document.getElementById('participantCount').textContent = '2名';
            });
            
            // ルームが見つからない場合の自動復旧処理
            socket.on('room_not_found', () => {
                console.log('ルームが見つかりません。自動復旧を試行します...');
                
                // 自動復旧を1回だけ試行
                if (!socket._autoRecoveryAttempted) {
                    socket._autoRecoveryAttempted = true;
                    
                    setTimeout(() => {
                        console.log('ルーム復旧を試行中...');
                        socket.emit('mode_select_join', {
                            roomId: roomId,
                            playerName: playerName,
                            role: userRole,
                            recovery: true  // 復旧フラグ
                        });
                    }, 1000);
                } else {
                    // 復旧に失敗した場合のみエラー表示
                    showError('接続に問題が発生しました。ロビーに戻って再度お試しください。\n\n原因:\n• ネットワークの一時的な問題\n• サーバーとの同期エラー', true);
                }
            });
            
            // 学習モード選択時の遷移
            socket.on('redirect_to_learning', (data) => {
                console.log('学習画面への遷移指示を受信:', data);
                showModeRedirectMessage('learning', data.message);
                setTimeout(() => {
                    proceedToSelectedMode('learning');
                }, 1500);
            });
            
            // クイズモード選択時の遷移
            socket.on('redirect_to_matching', (data) => {
                console.log('マッチング画面への遷移指示を受信:', data);
                showModeRedirectMessage('quiz', data.message);
                setTimeout(() => {
                    proceedToSelectedMode('quiz');
                }, 1500);
            });
            
            return socket;
        }
        
        function initializeSocket() {
            ensureSocket();
        }
        
        // モード選択
        function selectMode(mode) {
            if (userRole === 'guest') {
                // Guestは主催者の選択を待つ
                showGuestWaitingMessage();
                return;
            }
            
            selectedMode = mode;
            updateSelectedMode(mode, false);
            
            // Ownerの場合、自動的にモードを開始
            if (userRole === 'owner') {
                setTimeout(() => {
                    startSelectedMode();
                }, 1500); // 1.5秒後に自動開始
            }
        }
        
        function updateSelectedMode(mode, isForced = false) {
            // 全カードの選択状態をリセット
            document.querySelectorAll('.wa-mode-card-large').forEach(card => {
                card.classList.remove('selected');
            });
            
            // 選択されたカードをハイライト
            document.querySelector(`[data-mode="${mode}"]`).classList.add('selected');
            
            // ガイダンス表示
            showModeGuidance(mode, isForced);
            
            // 自動モード開始メッセージの状態更新
            const autoModeMessage = document.getElementById('autoModeMessage');
            const autoModeIcon = document.getElementById('autoModeIcon');
            const autoModeText = document.getElementById('autoModeText');
            const statusSelection = document.getElementById('statusSelection');
            
            if (userRole === 'owner') {
                // Ownerの場合は自動モード開始メッセージを表示
                autoModeMessage.style.display = 'block';
                
                if (mode === 'learning') {
                    autoModeIcon.textContent = '🌸';
                    autoModeText.textContent = '学習モードを開始しています...';
                    statusSelection.textContent = '学習モード';
                    statusSelection.style.color = 'var(--take)';
                } else if (mode === 'quiz') {
                    autoModeIcon.textContent = '⚔️';
                    autoModeText.textContent = 'クイズモードを開始しています...';
                    statusSelection.textContent = 'クイズモード';
                    statusSelection.style.color = 'var(--enjhi)';
                }
            }
        }
        
        function showModeGuidance(mode, isForced) {
            const guidance = document.getElementById('selectionGuidance');
            const guidanceTitle = document.getElementById('guidanceTitle');
            const guidanceContent = document.getElementById('guidanceContent');
            
            guidance.style.display = 'block';
            
            if (mode === 'learning') {
                guidanceTitle.textContent = '🌸 学習モードについて';
                if (isForced) {
                    guidanceContent.textContent = 
                        '主催者が学習モードを選択しました。美しい物語を共に読み進め、知識を深めてまいりましょう。';
                } else {
                    guidanceContent.textContent = 
                        '学習モードでは、主催者の操作に合わせて参加者の画面も同期されます。美しい物語を共に読み進め、知識を深めてまいりましょう。';
                }
            } else if (mode === 'quiz') {
                guidanceTitle.textContent = '⚔️ クイズモードについて';
                if (isForced) {
                    guidanceContent.textContent = 
                        '主催者がクイズモードを選択しました。学んだ知識を武器に、華麗なる対戦に挑みましょう。';
                } else {
                    guidanceContent.textContent = 
                        'クイズモードでは、リアルタイムで対戦を行います。制限時間内に正解を目指し、互いの実力を競い合いましょう。';
                }
            }
        }
        
        function showGuestWaitingMessage() {
            // Guestが直接モードを選択しようとした場合の案内
            const modal = document.createElement('div');
            modal.className = 'wa-modal active';
            modal.innerHTML = `
                <div class="wa-modal-content">
                    <h3 style="color: var(--ai); margin-bottom: 1rem;">🎋 参加者様へのご案内</h3>
                    <p style="margin-bottom: 1.5rem;">
                        学習方式の選択は主催者様が行います。<br>
                        主催者様の選択をお待ちください。選択されると自動的に適切な画面へ移動いたします。
                    </p>
                    <div style="text-align: center; margin: 1rem 0;">
                        <div class="wa-waiting-animation">
                            <div class="wa-waiting-dot"></div>
                            <div class="wa-waiting-dot"></div>
                            <div class="wa-waiting-dot"></div>
                        </div>
                    </div>
                    <button class="wa-btn wa-btn-primary" onclick="this.closest('.wa-modal').remove()">
                        承知いたしました
                    </button>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        // 選択されたモード開始
        function startSelectedMode() {
            if (!selectedMode) {
                alert('まず学習方式を選択してください。');
                return;
            }
            
            if (userRole !== 'owner') {
                showError('主催者のみがモードを選択できます。');
                return;
            }
            
            console.log(`選択されたモード: ${selectedMode}`);

            // サーバーに選択を通知
            if (socket && socket.connected) {
                if (selectedMode === 'learning') {
                    socket.emit('select_learning_mode', { roomId: roomId });
                } else if (selectedMode === 'quiz') {
                    socket.emit('select_quiz_mode', { roomId: roomId });
                }
            } else {
                showError('サーバーとの接続が確立されていません。');
            }
        }
        
        function proceedToSelectedMode(mode, data = {}) {
            const params = new URLSearchParams({
                role: userRole,
                roomId: roomId,
                playerName: playerName
            });
            
            if (mode === 'learning') {
                window.location.href = `learning.html?${params.toString()}`;
            } else if (mode === 'quiz') {
                window.location.href = `matching.html?${params.toString()}`;
            }
        }
        
        // 接続状態更新
        function updateConnectionStatus(status) {
            const statusText = document.querySelector('.wa-status .wa-status-item span:last-child');
            if (statusText) {
                switch (status) {
                    case 'connecting':
                        statusText.textContent = '接続状態: 接続中...';
                        break;
                    case 'connected':
                        statusText.textContent = '接続状態: 準備完了';
                        break;
                    case 'error':
                        statusText.textContent = '接続状態: 接続エラー';
                        break;
                    case 'disconnected':
                        statusText.textContent = '接続状態: 切断されました';
                        break;
                }
            }
        }

        // エラー表示
        function showError(message, isDetailedError = false) {
            const modal = document.createElement('div');
            modal.className = 'wa-modal active';
            
            // 詳細エラーの場合は改行を適切に処理
            const formattedMessage = isDetailedError ? 
                message.replace(/\n/g, '<br>') : message;
            
            modal.innerHTML = `
                <div class="wa-modal-content">
                    <h3 style="color: var(--enjhi); margin-bottom: 1rem;">⚠️ エラー</h3>
                    <div style="margin-bottom: 1.5rem; text-align: left; line-height: 1.6;">${formattedMessage}</div>
                    <div style="display: flex; gap: 1rem; justify-content: center;">
                        <button class="wa-btn wa-btn-primary" onclick="this.closest('.wa-modal').remove(); goBack();">
                            ロビーに戻る
                        </button>
                        <button class="wa-btn wa-btn-secondary" onclick="this.closest('.wa-modal').remove();">
                            再試行
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // モード遷移メッセージ表示
        function showModeRedirectMessage(mode, message) {
            const modal = document.createElement('div');
            modal.className = 'wa-modal active';
            const modeIcon = mode === 'learning' ? '📚' : '⚔️';
            const modeTitle = mode === 'learning' ? '学習モード' : 'クイズモード';
            
            modal.innerHTML = `
                <div class="wa-modal-content">
                    <h3 style="color: var(--take); margin-bottom: 1rem;">${modeIcon} ${modeTitle}開始</h3>
                    <p style="margin-bottom: 1.5rem;">${message}</p>
                    <div class="wa-loading">
                        <div class="wa-loading-spinner"></div>
                        <p>画面を遷移しています...</p>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // 待機時間タイマー
        function startWaitingTimer() {
            setInterval(() => {
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                const minutes = Math.floor(elapsed / 60).toString().padStart(2, '0');
                const seconds = (elapsed % 60).toString().padStart(2, '0');
                document.getElementById('waitingTime').textContent = `${minutes}:${seconds}`;
            }, 1000);
        }
        
        // 季節装飾の生成
        function generateSeasonalElements() {
            const container = document.getElementById('seasonalDecoration');
            const elements = [
                { class: 'sakura-petal', count: 4 },
                { class: 'momiji-leaf', count: 2 }
            ];
            
            elements.forEach(({ class: className, count }) => {
                for (let i = 0; i < count; i++) {
                    const element = document.createElement('div');
                    element.className = className;
                    element.style.left = Math.random() * 100 + '%';
                    element.style.animationDelay = Math.random() * 8 + 's';
                    element.style.animationDuration = (6 + Math.random() * 4) + 's';
                    container.appendChild(element);
                }
            });
        }
        
        function goBack() {
            if (socket && socket.connected) {
                console.log('Socket切断中...');
                try {
                    socket.disconnect();
                } catch (error) {
                    console.error('Socket切断エラー:', error);
                }
                socket = null;
            }
            // 切断処理の完了を少し待ってから遷移
            setTimeout(() => {
                window.location.href = `lobby.html?role=${userRole}`;
            }, 100);
        }
        
        // キーボードショートカット
        document.addEventListener('keydown', (e) => {
            switch (e.key) {
                case '1':
                    if (userRole === 'owner') selectMode('learning');
                    break;
                case '2':
                    if (userRole === 'owner') selectMode('quiz');
                    break;
                case 'Enter':
                    if (selectedMode) {
                        startSelectedMode();
                    }
                    break;
                case 'Escape':
                    goBack();
                    break;
            }
        });
        
        // ページ離脱時のクリーンアップ
        window.addEventListener('beforeunload', () => {
            if (socket && socket.connected) {
                try {
                    socket.disconnect();
                } catch (error) {
                    console.error('ページ離脱時のSocket切断エラー:', error);
                }
                socket = null;
            }
        });
    </script>

    <style>
        .wa-section-title {
            font-family: var(--font-accent);
            font-size: 1.8rem;
            color: var(--enjhi);
            text-align: center;
            margin-bottom: var(--spacing-xl);
            text-shadow: 1px 1px 0px rgba(178, 45, 53, 0.1);
        }

        .wa-room-info {
            background: var(--gradient-sakura);
            border: 2px solid var(--enjhi);
            border-radius: var(--border-radius-large);
            padding: var(--spacing-lg);
            margin-bottom: var(--spacing-xxl);
        }

        .wa-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--spacing-md);
        }

        .wa-info-item {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-sm);
            background: rgba(255, 255, 255, 0.3);
            border-radius: var(--border-radius);
        }

        .wa-info-icon {
            font-size: 1.5rem;
            width: 24px;
            text-align: center;
        }

        .wa-info-label {
            font-family: var(--font-ui);
            font-weight: 600;
            color: var(--sumi);
            min-width: 50px;
        }

        .wa-info-value {
            font-family: var(--font-main);
            color: var(--enjhi);
            font-weight: 500;
        }

        .wa-mode-cards-large {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: var(--spacing-xxl);
            margin: var(--spacing-xxl) 0;
        }

        .wa-mode-card-large {
            background: var(--gradient-washi);
            border: 3px solid var(--ai);
            border-radius: var(--border-radius-large);
            padding: var(--spacing-xxl);
            cursor: pointer;
            transition: all 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            position: relative;
            overflow: hidden;
            min-height: 500px;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        .wa-mode-card-large::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(178, 45, 53, 0.1) 0%, transparent 70%);
            transform: scale(0);
            transition: transform 0.8s ease;
        }

        .wa-mode-card-large:hover::before {
            transform: scale(1);
        }

        .wa-mode-card-large:hover {
            transform: translateY(-10px) scale(1.03);
            border-color: var(--enjhi);
            box-shadow: 
                var(--shadow-strong),
                0 0 40px rgba(178, 45, 53, 0.3);
        }

        .wa-mode-card-large.selected {
            background: var(--gradient-sakura);
            border-color: var(--enjhi);
            border-width: 4px;
            transform: translateY(-8px) scale(1.02);
            box-shadow: 
                var(--shadow-strong),
                0 0 30px rgba(178, 45, 53, 0.4);
        }

        .wa-mode-decoration {
            position: absolute;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .wa-decoration-element {
            position: absolute;
            font-size: 2rem;
            opacity: 0.1;
            animation: decorationFloat 6s ease-in-out infinite;
        }

        .wa-decoration-element:nth-child(1) {
            top: 10%;
            right: 15%;
            animation-delay: 0s;
        }

        .wa-decoration-element:nth-child(2) {
            bottom: 20%;
            left: 10%;
            animation-delay: 2s;
        }

        .wa-decoration-element:nth-child(3) {
            top: 60%;
            right: 10%;
            animation-delay: 4s;
        }

        @keyframes decorationFloat {
            0%, 100% { transform: translateY(0) rotate(0deg); opacity: 0.1; }
            50% { transform: translateY(-10px) rotate(180deg); opacity: 0.3; }
        }

        .wa-mode-icon-large {
            font-size: 5rem;
            margin-bottom: var(--spacing-lg);
            animation: iconPulse 3s ease-in-out infinite;
        }

        @keyframes iconPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .wa-mode-title-large {
            font-family: var(--font-accent);
            font-size: 2rem;
            font-weight: 800;
            color: var(--enjhi);
            margin-bottom: var(--spacing-sm);
            text-shadow: 2px 2px 0px rgba(178, 45, 53, 0.1);
        }

        .wa-mode-subtitle {
            font-family: var(--font-main);
            font-size: 1.1rem;
            color: var(--ai);
            margin-bottom: var(--spacing-lg);
            font-style: italic;
        }

        .wa-mode-description-large {
            font-family: var(--font-main);
            font-size: 1rem;
            line-height: 1.8;
            color: var(--sumi);
            margin-bottom: var(--spacing-lg);
            text-align: center;
        }

        .wa-mode-details {
            width: 100%;
            margin-bottom: var(--spacing-lg);
        }

        .wa-mode-details h4 {
            font-family: var(--font-ui);
            color: var(--enjhi);
            margin-bottom: var(--spacing-md);
            text-align: center;
        }

        .wa-subject-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: var(--spacing-xs);
        }

        .wa-subject-item {
            background: rgba(22, 94, 131, 0.1);
            color: var(--ai);
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: var(--border-radius);
            font-size: 0.85rem;
            text-align: center;
            border: 1px solid rgba(22, 94, 131, 0.2);
        }

        .wa-battle-info {
            display: flex;
            justify-content: space-around;
            gap: var(--spacing-md);
        }

        .wa-battle-rule {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--spacing-xs);
        }

        .wa-rule-number {
            font-size: 2rem;
            font-weight: 800;
            color: var(--enjhi);
            line-height: 1;
        }

        .wa-rule-text {
            font-size: 0.9rem;
            color: var(--sumi);
        }

        .wa-mode-features-large {
            width: 100%;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: var(--spacing-sm);
            margin-top: auto;
        }

        .wa-feature-large {
            background: rgba(47, 82, 51, 0.1);
            color: var(--take);
            padding: var(--spacing-sm);
            border-radius: var(--border-radius);
            font-size: 0.85rem;
            text-align: center;
            border: 1px solid rgba(47, 82, 51, 0.2);
            font-weight: 500;
        }

        .wa-selection-guidance {
            margin: var(--spacing-xl) 0;
        }

        .wa-btn-group-large {
            display: flex;
            gap: var(--spacing-lg);
            justify-content: center;
            margin: var(--spacing-xxl) 0;
        }

        .wa-btn-large {
            padding: var(--spacing-lg) var(--spacing-xxl);
            font-size: 1.1rem;
        }

        .wa-notices {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: var(--spacing-lg);
            margin: var(--spacing-xxl) 0;
        }

        .wa-notice-card {
            background: var(--gradient-washi);
            border: 2px solid var(--take);
            border-radius: var(--border-radius);
            padding: var(--spacing-lg);
        }

        .wa-notice-card h4 {
            color: var(--take);
            margin-bottom: var(--spacing-md);
            font-family: var(--font-ui);
        }

        .wa-notice-card ul {
            padding-left: var(--spacing-lg);
            list-style-type: none;
        }

        .wa-notice-card li {
            position: relative;
            margin-bottom: var(--spacing-sm);
            color: var(--sumi);
            line-height: 1.6;
        }

        .wa-notice-card li::before {
            content: '🌸';
            position: absolute;
            left: -1.5rem;
            top: 0;
        }

        .wa-status-dot.connected {
            background: var(--take);
            animation: statusPulse 2s infinite;
        }
        
        .wa-status-dot.error {
            background: var(--enjhi);
            animation: none;
        }
        
        .wa-status-dot.disconnected {
            background: #999;
            animation: none;
        }

        /* モーダルとローディング */
        .wa-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .wa-modal.active {
            display: flex;
        }

        .wa-modal-content {
            background: var(--washi);
            border: 3px solid var(--enjhi);
            border-radius: var(--border-radius-large);
            padding: var(--spacing-xl);
            max-width: 500px;
            width: 90%;
            text-align: center;
            box-shadow: var(--shadow-strong);
        }

        .wa-loading {
            margin-top: var(--spacing-lg);
        }

        .wa-loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--ai);
            border-top: 4px solid var(--enjhi);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto var(--spacing-md) auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .wa-loading p {
            color: var(--sumi);
            font-style: italic;
        }
        
        /* 待機アニメーション（共通） */
        .wa-waiting-animation {
            display: flex;
            justify-content: center;
            gap: var(--spacing-xs);
            margin: var(--spacing-sm) 0;
        }

        .wa-waiting-dot {
            width: 8px;
            height: 8px;
            background: var(--enjhi);
            border-radius: 50%;
            animation: wa-waiting-pulse 1.4s ease-in-out infinite both;
        }

        .wa-waiting-dot:nth-child(1) { animation-delay: -0.32s; }
        .wa-waiting-dot:nth-child(2) { animation-delay: -0.16s; }
        .wa-waiting-dot:nth-child(3) { animation-delay: 0s; }

        @keyframes wa-waiting-pulse {
            0%, 80%, 100% {
                transform: scale(0);
                opacity: 0.5;
            }
            40% {
                transform: scale(1);
                opacity: 1;
            }
        }

        @media (max-width: 768px) {
            .wa-mode-cards-large {
                grid-template-columns: 1fr;
                gap: var(--spacing-xl);
            }
            
            .wa-mode-card-large {
                min-height: 400px;
                padding: var(--spacing-xl);
            }
            
            .wa-mode-icon-large {
                font-size: 4rem;
            }
            
            .wa-mode-title-large {
                font-size: 1.8rem;
            }
            
            .wa-info-grid {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            }
            
            .wa-btn-group-large {
                flex-direction: column;
            }
            
            .wa-notices {
                grid-template-columns: 1fr;
            }
            
            .wa-battle-info {
                flex-direction: column;
                align-items: center;
            }

            .wa-modal-content {
                width: 95%;
                padding: var(--spacing-lg);
            }
        }
    </style>
</body>
</html>
