<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>学習の間 - CS学習クイズバトル</title>
    <link rel="stylesheet" href="css/taisho.css">
    <script src="/socket.io/socket.io.js"></script>
    <script src="js/socket.js"></script>
    <script src="js/toast.js"></script>
</head>
<body>
    <!-- 四季の装飾要素 -->
    <div class="seasonal-decoration" id="seasonalDecoration"></div>

    <main class="washi-container wa-fade-in">
        <!-- ヘッダー -->
        <header class="wa-header">
            <h1 class="wa-title">学習の間</h1>
            <p class="wa-subtitle">CS雅学の間 - 大正ロマンで学ぶコンピューターサイエンス</p>
            <div class="wa-divider"></div>
        </header>

        <!-- 役割表示とステータス -->
        <div class="wa-role-status" style="margin-bottom: 2rem;">
            <div class="wa-card">
                <div class="wa-card-content" style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <span class="wa-role-badge" id="roleDisplay">未設定</span>
                        <span class="wa-player-name" id="playerNameDisplay">未設定</span>
                    </div>
                    <div>
                        <span class="wa-room-info">🏛️ <span id="roomIdDisplay">未設定</span></span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Guest専用同期状態表示 -->
        <div class="wa-guest-sync-panel" id="guestSyncPanel" style="display: none; margin-bottom: 2rem;">
            <div class="wa-card wa-sync-card">
                <div class="wa-card-content">
                    <div class="wa-sync-header">
                        <span class="wa-sync-icon">🌸</span>
                        <h3 class="wa-sync-title">主催者様と同期中</h3>
                        <div class="wa-sync-status-dot" id="syncStatusDot"></div>
                    </div>
                    <p class="wa-sync-description">
                        あなたは参加者として、主催者様の操作に優雅に同期いたします。<br>
                        美しい学習の調べをお楽しみください。
                    </p>
                    <div class="wa-sync-info">
                        <span class="wa-sync-status-text" id="syncStatusText">接続待機中</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- ナビゲーション -->
        <nav class="wa-learning-nav">
            <!-- 分野選択タブは不要のため削除。初期選択は numbers -->
            <div class="wa-nav-item active" data-category="numbers">
                <span class="wa-nav-icon">🔢</span>
                <span class="wa-nav-text">数値・データ</span>
            </div>
            <div class="wa-nav-item" data-category="hardware">
                <span class="wa-nav-icon">💾</span>
                <span class="wa-nav-text">ハードウェア</span>
            </div>
            <div class="wa-nav-item" data-category="algorithms">
                <span class="wa-nav-icon">🔄</span>
                <span class="wa-nav-text">アルゴリズム</span>
            </div>
            <div class="wa-nav-item" data-category="web">
                <span class="wa-nav-icon">🌐</span>
                <span class="wa-nav-text">Web技術</span>
            </div>
            <div class="wa-nav-item" data-category="network">
                <span class="wa-nav-icon">🔗</span>
                <span class="wa-nav-text">ネットワーク</span>
            </div>
            <div class="wa-nav-item" data-category="security">
                <span class="wa-nav-icon">🔐</span>
                <span class="wa-nav-text">セキュリティ</span>
            </div>
        </nav>

        <!-- デザインC: 巻物タイムライン（カテゴリ直下の物語選択UI） -->
        <section class="wa-fade-in" id="story-selector" aria-label="物語選択">
            <style>
                /* 巻物タイムライン UI（学習画面内に限定適用） */
                #story-selector .c-nav { display:flex; gap: var(--spacing-sm); flex-wrap: wrap; justify-content: center; margin-bottom: var(--spacing-lg); }
                #story-selector .c-scroll { background: var(--gradient-washi); border:2px solid var(--ai); border-radius: var(--border-radius-large); padding: var(--spacing-xl); position: relative; overflow: hidden; }
                #story-selector .c-scroll::before, #story-selector .c-scroll::after { content:''; position:absolute; left: 0; right: 0; height: 12px; background: repeating-linear-gradient(90deg, rgba(178,45,53,.15) 0 12px, transparent 12px 24px); }
                #story-selector .c-scroll::before { top:0; } #story-selector .c-scroll::after { bottom:0; }
                #story-selector .c-timeline { position: relative; margin: var(--spacing-xl) auto; max-width: 980px; }
                #story-selector .c-timeline::before { content:''; position:absolute; left: 20px; top:0; bottom:0; width: 4px; background: linear-gradient(180deg, var(--enjhi), var(--yamabuki)); border-radius: 2px; }
                #story-selector .c-node{ position:relative; display:grid; grid-template-columns: 60px 1fr; gap: var(--spacing-md); margin-bottom: var(--spacing-xl); align-items: start; }
                #story-selector .c-pin{ width: 18px; height: 18px; border-radius: 50%; background: var(--enjhi); border: 3px solid var(--washi); box-shadow: var(--shadow-soft); position: relative; left: 12px; top: 6px; }
                #story-selector .c-card{ background: var(--gradient-sakura); border:2px solid var(--enjhi); border-radius: var(--border-radius); padding: var(--spacing-lg); box-shadow: var(--shadow-soft); cursor: pointer; transition: transform .2s ease; }
                #story-selector .c-card:hover{ transform: translateY(-3px); }
                #story-selector .c-title{ font-family: var(--font-accent); color: var(--enjhi); font-weight: 800; }
                #story-selector .c-sub{ color: var(--ai); font-size: .95rem; margin-top: 6px; }
                #story-selector .c-meta{ display:flex; gap:6px; flex-wrap:wrap; margin-top: 8px; }
                #story-selector .c-chip{ background: rgba(22,94,131,.08); color: var(--ai); border:1px solid rgba(22,94,131,.2); border-radius: 999px; padding: 2px 8px; font-size: .8rem; }
                #story-selector .c-hidden{ display:none; }
            </style>

            <!-- カテゴリ内タブは不要のため非表示 -->

            <!-- 巻物タイムライン本体（最大15話） -->
            <div class="c-scroll">
                <div id="tl-numbers" class="c-timeline"></div>
                <div id="tl-hardware" class="c-timeline c-hidden"></div>
                <div id="tl-algorithms" class="c-timeline c-hidden"></div>
                <div id="tl-web" class="c-timeline c-hidden"></div>
                <div id="tl-network" class="c-timeline c-hidden"></div>
                <div id="tl-security" class="c-timeline c-hidden"></div>
            </div>

            <script>
                // ルーム/役割情報（URLから取得）
                const __params = new URLSearchParams(window.location.search);
                const roomId = __params.get('roomId') || '';
                const playerName = __params.get('playerName') || '';
                const userRole = __params.get('role') || 'guest';
                const initialCategoryParam = __params.get('category') || 'numbers';
                // 役割・ルーム表示の更新とGuest同期パネル
                document.addEventListener('DOMContentLoaded', () => {
                    const rid = document.getElementById('roomIdDisplay');
                    const pname = document.getElementById('playerNameDisplay');
                    const rbadge = document.getElementById('roleDisplay');
                    if (rid && roomId) rid.textContent = roomId;
                    if (pname && playerName) pname.textContent = playerName;
                    if (rbadge) {
                        if (userRole === 'owner') {
                            rbadge.textContent = '👑 主催者';
                            rbadge.className = 'wa-role-badge owner';
                            const panel = document.getElementById('guestSyncPanel');
                            if (panel) panel.style.display = 'none';
                        } else {
                            rbadge.textContent = '🎋 参加者';
                            rbadge.className = 'wa-role-badge guest';
                            const panel = document.getElementById('guestSyncPanel');
                            if (panel) panel.style.display = 'block';
                        }
                    }
                });

                // 季節装飾（末尾スクリプト削除に伴いここで管理）
                const seasons = ['spring', 'summer', 'autumn', 'winter'];
                let currentSeasonIndex = 0;
                function changeSeason() {
                    const seasonElement = document.getElementById('seasonalDecoration');
                    if (!seasonElement) return;
                    currentSeasonIndex = (currentSeasonIndex + 1) % seasons.length;
                    const season = seasons[currentSeasonIndex];
                    seasonElement.className = `seasonal-decoration season-${season}`;
                    generateSeasonalElements(season);
                }
                function generateSeasonalElements(season = 'spring') {
                    const container = document.getElementById('seasonalDecoration');
                    if (!container) return;
                    container.innerHTML = '';
                    const elementCount = 6;
                    for (let i = 0; i < elementCount; i++) {
                        const element = document.createElement('div');
                        switch (season) {
                            case 'spring':
                                element.className = 'sakura-petal';
                                element.style.left = Math.random() * 100 + '%';
                                element.style.animationDelay = Math.random() * 8 + 's';
                                element.style.animationDuration = (6 + Math.random() * 4) + 's';
                                break;
                            case 'summer':
                                element.className = 'summer-leaf';
                                element.style.cssText = `
                                    position: absolute; width: 8px; height: 8px; background: var(--tsuyu);
                                    border-radius: 50% 0 50% 0; left: ${Math.random() * 100}%;
                                    animation: summerSway ${4 + Math.random() * 3}s ease-in-out infinite;
                                    animation-delay: ${Math.random() * 4}s; opacity: 0.3;`;
                                break;
                            case 'autumn':
                                element.className = 'momiji-leaf';
                                element.style.left = Math.random() * 100 + '%';
                                element.style.animationDelay = Math.random() * 10 + 's';
                                element.style.animationDuration = (8 + Math.random() * 4) + 's';
                                break;
                            case 'winter':
                                element.className = 'snow-flake';
                                element.innerHTML = '❄';
                                element.style.cssText = `
                                    position: absolute; color: var(--yuki);
                                    font-size: ${6 + Math.random() * 6}px; left: ${Math.random() * 100}%;
                                    animation: snowFall ${6 + Math.random() * 6}s linear infinite;
                                    animation-delay: ${Math.random() * 6}s; opacity: 0.6;`;
                                break;
                        }
                        container.appendChild(element);
                    }
                }
                document.addEventListener('DOMContentLoaded', () => {
                    generateSeasonalElements('spring');
                    setInterval(() => changeSeason(), 45000);
                });
                // タイムライン表示用のラベル（フォールバック）
                const TL_DATA_FALLBACK = {
                    hardware: ['機械式計算機の恋','真空管の灯り','トランジスタの鼓動','メモリの記憶','ストレージの約束','CPUの三拍子','パイプラインの舞','キャッシュの囁き','命令セットの詩','クロックと愛'],
                    algorithms: ['探索は君を探して','ソートのダンス','貪欲法の誘惑','動的計画の手紙','グラフの恋路','木と森の物語','再帰の輪舞'],
                    web: ['HTMLの恋文','CSSの彩り','JavaScriptの告白','HTTPの手紙','Cookieの思い出','RESTの誓い','SPAのきらめき'],
                    network: ['TCPの握手','UDPの走り書き','DNSの名付け','ルーティングの旅','VPNの密会'],
                    security: ['暗号の指輪','公開鍵の約束','ハッシュの封印','ゼロトラストの誓い','XSSの影','CSRFの罠']
                };

                // 物語データキャッシュ（カテゴリ -> JSON）
                const STORIES = { numbers: null, hardware: null, algorithms: null, web: null, network: null, security: null };

                // タイムライン描画
                // items: [{ title, ep, icon, summary }]
                function renderTimeline(rootId, items, catKey){
                    const root = document.getElementById(rootId);
                    if (!root) return;
                    root.innerHTML = '';
                    items.forEach((it, i)=>{
                        const node = document.createElement('div');
                        node.className = 'c-node';
                        node.innerHTML = `
                            <div class='c-pin'></div>
                            <div class='c-card wa-pulse' data-story-title="${it.title}" data-cat="${catKey}" data-ep="${it.ep}">
                                <div class='c-title'>${(it.icon && !/^\d+$/.test(it.icon)) ? `<span style="margin-right:6px;">${it.icon}</span>` : ''}${it.title}</div>
                                <div class='c-sub'>${it.summary || '短いあらすじがここに入ります。'}</div>
                            </div>`;
                        root.appendChild(node);
                    });
                }

                // カテゴリ: numbers を manifest.json 優先で読み込み、無ければ従来JSONにフォールバック
                async function loadNumbers() {
                    const manifestUrl = '/data/stories/numbers/manifest.json';
                    try {
                        // manifest 試行
                        let manifest = null;
                        try {
                            const r = await fetch(manifestUrl);
                            if (r.ok) {
                                manifest = await r.json();
                            }
                        } catch (_) {}

                        if (manifest && Array.isArray(manifest.chapters)) {
                            STORIES.numbers = manifest;
                            const items = (manifest.chapters || []).map(ch => ({
                                ep: ch.id,
                                title: `第${ch.id}話：${ch.title}`,
                                icon: ch.icon || '',
                                summary: ch.summary || ''
                            }));
                            renderTimeline('tl-numbers', items, 'numbers');
                            return;
                        }

                        // 旧JSONフォールバック
                        const res = await fetch('/data/stories/01_numbers.json');
                        if (!res.ok) throw new Error('numbers JSON not found');
                        const json = await res.json();
                        STORIES.numbers = json;
                        const items = (json.chapters || []).map(ch => ({
                            ep: ch.id,
                            title: `第${ch.id}話：${ch.title}`,
                            icon: ch.icon || '',
                            summary: ch.summary || ''
                        }));
                        renderTimeline('tl-numbers', items, 'numbers');
                    } catch (e) {
                        // フォールバック（簡易3話）
                        const fallback = [
                            { ep: 1, title: '第1話：二進法の恋文', icon: '01', summary: '' },
                            { ep: 2, title: '第2話：データ型の恋愛関係', icon: '02', summary: '' },
                            { ep: 3, title: '第3話：進数変換の愛', icon: '03', summary: '' }
                        ];
                        renderTimeline('tl-numbers', fallback, 'numbers');
                    }
                }

                // アルゴリズムは manifest 優先で読み込む
                async function loadAlgorithms() {
                    const manifestUrl = '/data/stories/algorithms/manifest.json';
                    try {
                        let manifest = null;
                        try {
                            const r = await fetch(manifestUrl);
                            if (r.ok) manifest = await r.json();
                        } catch (_) {}

                        if (manifest && Array.isArray(manifest.chapters)) {
                            STORIES.algorithms = manifest;
                            const items = (manifest.chapters || []).map(ch => ({
                                ep: ch.id,
                                title: `第${ch.id}話：${ch.title}`,
                                icon: ch.icon || '',
                                summary: ch.summary || ''
                            }));
                            renderTimeline('tl-algorithms', items, 'algorithms');
                            return;
                        }
                        await loadCategory('algorithms', '/data/stories/03_algorithms.json');
                    } catch (e) {
                        const items = (TL_DATA_FALLBACK['algorithms'] || []).map((title, idx) => ({ ep: idx+1, title, icon: '', summary: '' }));
                        renderTimeline('tl-algorithms', items, 'algorithms');
                    }
                }

                // Webは manifest 優先で読み込む
                async function loadWeb() {
                    const manifestUrl = '/data/stories/web/manifest.json';
                    try {
                        let manifest = null;
                        try {
                            const r = await fetch(manifestUrl);
                            if (r.ok) manifest = await r.json();
                        } catch (_) {}

                        if (manifest && Array.isArray(manifest.chapters)) {
                            STORIES.web = manifest;
                            const items = (manifest.chapters || []).map(ch => ({
                                ep: ch.id,
                                title: `第${ch.id}話：${ch.title}`,
                                icon: ch.icon || '',
                                summary: ch.summary || ''
                            }));
                            renderTimeline('tl-web', items, 'web');
                            return;
                        }
                        await loadCategory('web', '/data/stories/04_web.json');
                    } catch (e) {
                        const items = (TL_DATA_FALLBACK['web'] || []).map((title, idx) => ({ ep: idx+1, title, icon: '', summary: '' }));
                        renderTimeline('tl-web', items, 'web');
                    }
                }

                // ネットワークは manifest 優先で読み込む
                async function loadNetwork() {
                    const manifestUrl = '/data/stories/network/manifest.json';
                    try {
                        let manifest = null;
                        try {
                            const r = await fetch(manifestUrl);
                            if (r.ok) manifest = await r.json();
                        } catch (_) {}

                        if (manifest && Array.isArray(manifest.chapters)) {
                            STORIES.network = manifest;
                            const items = (manifest.chapters || []).map(ch => ({
                                ep: ch.id,
                                title: `第${ch.id}話：${ch.title}`,
                                icon: ch.icon || '',
                                summary: ch.summary || ''
                            }));
                            renderTimeline('tl-network', items, 'network');
                            return;
                        }
                        await loadCategory('network', '/data/stories/05_network.json');
                    } catch (e) {
                        const items = (TL_DATA_FALLBACK['network'] || []).map((title, idx) => ({ ep: idx+1, title, icon: '', summary: '' }));
                        renderTimeline('tl-network', items, 'network');
                    }
                }

                // セキュリティは manifest 優先で読み込む
                async function loadSecurity() {
                    const manifestUrl = '/data/stories/security/manifest.json';
                    try {
                        let manifest = null;
                        try {
                            const r = await fetch(manifestUrl);
                            if (r.ok) manifest = await r.json();
                        } catch (_) {}

                        if (manifest && Array.isArray(manifest.chapters)) {
                            STORIES.security = manifest;
                            const items = (manifest.chapters || []).map(ch => ({
                                ep: ch.id,
                                title: `第${ch.id}話：${ch.title}`,
                                icon: ch.icon || '',
                                summary: ch.summary || ''
                            }));
                            renderTimeline('tl-security', items, 'security');
                            return;
                        }
                        await loadCategory('security', '/data/stories/06_security.json');
                    } catch (e) {
                        const items = (TL_DATA_FALLBACK['security'] || []).map((title, idx) => ({ ep: idx+1, title, icon: '', summary: '' }));
                        renderTimeline('tl-security', items, 'security');
                    }
                }

                // 他カテゴリのJSONを読み込み描画
                async function loadCategory(cat, path) {
                    try {
                        const res = await fetch(path);
                        if (!res.ok) throw new Error('not found: '+path);
                        const json = await res.json();
                        STORIES[cat] = json;
                        const items = (json.chapters || []).map(ch => ({
                            ep: ch.id,
                            title: `第${ch.id}話：${ch.title}`,
                            icon: ch.icon || '',
                            summary: ch.summary || ''
                        }));
                        renderTimeline('tl-'+cat, items, cat);
                    } catch (e) {
                        const items = (TL_DATA_FALLBACK[cat] || []).map((title, idx) => ({ ep: idx+1, title, icon: '', summary: '' }));
                        renderTimeline('tl-'+cat, items, cat);
                    }
                }

                // ハードウェアは manifest 優先で読み込む
                async function loadHardware() {
                    const manifestUrl = '/data/stories/hardware/manifest.json';
                    try {
                        let manifest = null;
                        try {
                            const r = await fetch(manifestUrl);
                            if (r.ok) {
                                manifest = await r.json();
                            }
                        } catch (_) {}

                        if (manifest && Array.isArray(manifest.chapters)) {
                            STORIES.hardware = manifest;
                            const items = (manifest.chapters || []).map(ch => ({
                                ep: ch.id,
                                title: `第${ch.id}話：${ch.title}`,
                                icon: ch.icon || '',
                                summary: ch.summary || ''
                            }));
                            renderTimeline('tl-hardware', items, 'hardware');
                            return;
                        }

                        // 旧JSONフォールバック
                        await loadCategory('hardware', '/data/stories/02_hardware.json');
                    } catch (e) {
                        const items = (TL_DATA_FALLBACK['hardware'] || []).map((title, idx) => ({ ep: idx+1, title, icon: '', summary: '' }));
                        renderTimeline('tl-hardware', items, 'hardware');
                    }
                }

                

                // カテゴリ内タブは撤廃（トップナビと同期表示に一本化）

                // 物語選択時の遷移（既存セクションへ移動）
                document.getElementById('story-selector').addEventListener('click', (e)=>{
                    const card = e.target.closest('.c-card');
                    if (!card) return;
                    const cat = card.getAttribute('data-cat');
                    const title = card.getAttribute('data-story-title');
                    const ep = parseInt(card.getAttribute('data-ep'), 10) || 1;

                    // 2ページ構成に変更: 物語本文ページへ遷移
                    // クエリ: category, chapter を付与
                    const params = new URLSearchParams({ category: cat, chapter: String(ep) });
                    try {
                        if (typeof roomId !== 'undefined' && roomId) params.set('roomId', roomId);
                        if (typeof playerName !== 'undefined' && playerName) params.set('playerName', playerName);
                        if (typeof userRole !== 'undefined' && userRole) params.set('role', userRole);
                        // Ownerの場合は先に同期イベントを送出（Guestの追従遅延を最小化）
                        if (userRole === 'owner' && roomId) {
                            try {
                                const sock = window.__learningSocket || (window.__learningSocket = io());
                                sock.emit('learning_story_change', { roomId, category: cat, chapterId: ep });
                            } catch (e) {}
                        }
                        if (typeof showSakuraToast === 'function') {
                            showSakuraToast(`「第${ep}話」へ移動します…`, 900, '物語へ移動', '📖');
                        }
                    } catch (e) { /* no-op */ }
                    setTimeout(() => { window.location.href = `learning-story.html?${params.toString()}`; }, 900);
                });

                // Guest同期: Ownerが変更したら反映
                (function setupGuestSync(){
                    try {
                        const sock = window.__learningSocket || (window.__learningSocket = io());

                        // ルーム参加（Owner/Guestともに参加させ、スナップショット/通知を受け取る）
                        if (roomId) {
                            sock.emit('join_room', { roomId, playerName, role: userRole, mode: 'learning' });
                        }

                        // Guest: Ownerの変更を反映（物語が選ばれたら本文ページへ）
                        sock.on('learning_story_changed', ({ category, chapterId }) => {
                            try {
                                const params = new URLSearchParams({ category, chapter: String(chapterId || 1) });
                                if (roomId) params.set('roomId', roomId);
                                if (playerName) params.set('playerName', playerName);
                                if (userRole) params.set('role', userRole);
                                // Guest側: 桜トーストを表示してから遷移
                                if (typeof showSakuraToast === 'function') {
                                    const chLabel = chapterId ? `第${chapterId}話` : '';
                                    showSakuraToast(`主催者が「${chLabel}」を開きました。追従しています…`, 1000, '物語へ移動', '🌸');
                                }
                                setTimeout(() => { window.location.href = `learning-story.html?${params.toString()}`; }, 1000);
                                return;
                            } catch (e) { /* フォールバック: 旧内表示 */ }

                            // フォールバック（万一遷移できない場合）
                            const subId = category;
                            document.querySelectorAll('.wa-content-section').forEach(s=>s.classList.remove('active'));
                            const el = document.getElementById(subId);
                            if (el) el.classList.add('active');
                        });

                        // Guest: カテゴリ変更の反映（タイムラインとナビを同期表示）
                        sock.on('learning_category_changed', ({ category }) => {
                            if (!category) return;
                            setActiveCategoryUI(category);
                            if (typeof showSakuraToast === 'function') {
                                const map = {numbers:'数値・データ',hardware:'ハードウェア',algorithms:'アルゴリズム',web:'Web技術',network:'ネットワーク',security:'セキュリティ'};
                                const label = map[category] || category;
                                showSakuraToast(`主催者が「${label}」を表示しました。`, 900, '表示切替', '🌸');
                            }
                        });

                        // Guest: 参加時のスナップショットを反映
                        sock.on('learning_story_snapshot', ({ currentCategory, selectedStory }) => {
                            // 物語が選択済みなら本文ページへ同期遷移
                            const chId = selectedStory?.[currentCategory];
                            if (currentCategory && currentCategory !== 'menu' && chId) {
                                try {
                                    const params = new URLSearchParams({ category: currentCategory, chapter: String(chId) });
                                    if (roomId) params.set('roomId', roomId);
                                    if (playerName) params.set('playerName', playerName);
                                    if (userRole) params.set('role', userRole);
                                    window.location.href = `learning-story.html?${params.toString()}`;
                                    return;
                                } catch (e) { /* no-op */ }
                            }

                            // 未選択時はカテゴリタイムラインだけ同期表示
                            if (!currentCategory || currentCategory === 'menu') currentCategory = 'numbers';
                            setActiveCategoryUI(currentCategory);
                        });
                    } catch (e) { /* 無視 */ }
                })();

                // カテゴリ選択UI制御：ナビのactiveとタイムラインの表示切替
                function setActiveCategoryUI(cat) {
                    // ナビのactive切替
                    document.querySelectorAll('.wa-learning-nav .wa-nav-item').forEach(el => {
                        el.classList.toggle('active', el.getAttribute('data-category') === cat);
                    });
                    // タイムライン表示切替
                    document.querySelectorAll('#story-selector .c-timeline').forEach(el => el.classList.add('c-hidden'));
                    const tl = document.getElementById('tl-' + cat) || document.getElementById('tl-numbers');
                    if (tl) tl.classList.remove('c-hidden');
                }

                // Owner操作: カテゴリ選択時に同期送出
                function selectCategory(cat) {
                    setActiveCategoryUI(cat);
                    try {
                        if (userRole === 'owner' && roomId) {
                            const sock = window.__learningSocket || (window.__learningSocket = io());
                            sock.emit('learning_category_change', { roomId, category: cat });
                        }
                    } catch (e) { /* no-op */ }
                }

                // ナビクリック設定（Guestは操作不可＝無視、Ownerのみ反映）
                document.querySelectorAll('.wa-learning-nav .wa-nav-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const cat = item.getAttribute('data-category');
                        if (userRole !== 'owner') return; // Guestは操作しない
                        selectCategory(cat);
                        if (typeof showSakuraToast === 'function') {
                            const map = {numbers:'数値・データ',hardware:'ハードウェア',algorithms:'アルゴリズム',web:'Web技術',network:'ネットワーク',security:'セキュリティ'};
                            const label = map[cat] || cat;
                            showSakuraToast(`「${label}」を表示します…`, 800, '表示切替', '🌸');
                        }
                    });
                });

                // 初期ロード
                (async function initStorySelector(){
                    await Promise.all([
                        loadNumbers(),
                        loadHardware(),
                        loadAlgorithms(),
                        loadWeb(),
                        loadNetwork(),
                        loadSecurity()
                    ]);
                    // 初期カテゴリ表示の反映（URLパラメータ優先）
                    setActiveCategoryUI(initialCategoryParam);
                    // Ownerなら初期カテゴリをサーバーへ同期（スナップショット整合）
                    try {
                        if (userRole === 'owner' && roomId) {
                            const sock = window.__learningSocket || (window.__learningSocket = io());
                            sock.emit('learning_category_change', { roomId, category: initialCategoryParam });
                        }
                    } catch (e) { /* no-op */ }
                })();
            </script>
        </section>

        <!-- メインコンテンツ（旧・内蔵本文セクション。2ページ化に伴い無効化） -->
        <!--
        <section class="wa-learning-main">

            <!-- 各分野のストーリー表示 -->
            <div class="wa-content-section" id="numbers">
                <div class="wa-story-content">
                    <div class="wa-story-header">
                        <h2 class="wa-story-title">🔢 数値とデータの基礎</h2>
                        <div class="wa-story-subtitle">第一章：二進法の恋文</div>
                        <div class="wa-divider"></div>
                    </div>

                    <div class="wa-story-layout">
                        <div class="wa-story-main">
                            <div class="wa-story-body">
                                <div class="wa-story-scroll" id="numbersStoryScroll">
                                    <div class="wa-story-section">
                                        <div class="wa-typewriter-text" id="numbersStory">
                                            戦場の片隅で、通信兵の青年・拓海は恋人・桜への手紙を綴っていた。<br><br>

                                            「愛しい桜へ、この戦いが終わったら必ず君のもとへ帰る」<br><br>

                                            しかし敵に解読されぬよう、彼は数学で学んだ二進法で暗号化することにした。<br>
                                            01001001 00100000 01001100 01101111 01110110 01100101 00100000 01011001 01101111 01110101<br>
                                            (I Love You)<br><br>

                                            桜もまた、この暗号を解読できる唯一の人。二人の愛は0と1で結ばれていた。<br><br>

                                            コンピュータもまた、すべてを0と1で表現する。この最小単位をビット(bit)と呼び、8ビットで1バイト(byte)となる。<br><br>

                                            拓海の恋文「I Love You」は、<br>
                                            - I = 01001001 (8ビット = 1バイト)<br>
                                            - (スペース) = 00100000<br>
                                            - L = 01001100<br>
                                            - o = 01101111<br>
                                            - v = 01110110<br>
                                            - e = 01100101<br><br>

                                            このように、文字は数値に対応し、その数値が二進法で表現される。<br>
                                            これが文字コード(ASCII)の仕組みである。<br><br>

                                            <div class="wa-poem-section">
                                                <div class="wa-poem-title">📜 恋の短歌</div>
                                                <div class="wa-poem-text">
                                                    零と一<br>
                                                    恋文綴る　兵士かな<br>
                                                    バイトに込めし<br>
                                                    永遠の愛<br>
                                                </div>
                                            </div><br>

                                            戦争が終わり、二人は再会した。桜は拓海に言った。<br>
                                            「あなたの暗号、全部解読したのよ」<br><br>

                                            そして桜は微笑んで続けた。<br>
                                            「01001001 00100000 01001100 01101111 01110110 01100101 00100000 01011001 01101111 01110101 00100000 01010100 01101111 01101111」<br>
                                            (I Love You Too)<br><br>

                                            二人の愛は、デジタル時代の今もなお、0と1の中に息づいている。
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="wa-story-sidebar">
                            <div class="wa-key-concepts">
                                <h3 class="wa-concepts-title">🔑 重要概念</h3>
                                <div class="wa-concept-list">
                                    <div class="wa-concept-item">
                                        <strong>ビット(bit)</strong>: 0または1の1桁の情報単位
                                    </div>
                                    <div class="wa-concept-item">
                                        <strong>バイト(byte)</strong>: 8ビットで構成される情報単位
                                    </div>
                                    <div class="wa-concept-item">
                                        <strong>二進法</strong>: 0と1だけで数を表現する方法
                                    </div>
                                    <div class="wa-concept-item">
                                        <strong>ASCII</strong>: 文字と数値を対応づける文字コード
                                    </div>
                                    <div class="wa-concept-item">
                                        <strong>文字コード</strong>: 文字をコンピュータが理解できる数値に変換する規則
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ハードウェア分野 -->
            <div class="wa-content-section" id="hardware">
                <div class="wa-story-content">
                    <div class="wa-story-header">
                        <h2 class="wa-story-title">💾 ハードウェア</h2>
                        <div class="wa-story-subtitle">第二章：機械式計算機の恋</div>
                        <div class="wa-divider"></div>
                    </div>

                    <div class="wa-story-layout">
                        <div class="wa-story-main">
                            <div class="wa-story-body">
                                <div class="wa-story-scroll" id="hardwareStoryScroll">
                                    <div class="wa-story-section">
                                        <div class="wa-typewriter-text" id="hardwareStory">
                                            1943年、戦時下の研究所。数学者の美奈子は、巨大な機械式計算機と向き合っていた。<br><br>

                                            この計算機は、弾道計算のために作られたもの。真空管が数千本も並び、部屋全体を占拠していた。<br><br>

                                            美奈子の恋人・正太郎は前線にいる。彼女は毎日、この計算機で正太郎の部隊の生存確率を計算し続けた。<br><br>

                                            機械式計算機の心臓部は演算装置。現代でいうCPU(Central Processing Unit)の原型だった。<br>
                                            この装置は、「フェッチ→デコード→実行」という基本サイクルで動作していた。<br><br>

                                            <div class="diagram-section">
                                                <strong>CPUの基本サイクル:</strong><br>
                                                1. フェッチ(Fetch): 命令をメモリから取得<br>
                                                2. デコード(Decode): 命令の意味を解読<br>
                                                3. 実行(Execute): 命令を実際に実行<br>
                                            </div><br>

                                            計算機には記憶装置も必要だった。当時は磁気ドラムが主流で、現代のハードディスクの祖先だった。<br>
                                            作業用の高速記憶装置は水銀遅延線メモリ。これが現代のRAM(Random Access Memory)の前身である。<br><br>

                                            ある日、正太郎から手紙が届いた。<br>
                                            「君の計算のおかげで、僕たちは的確な作戦を立てられている。君は僕たちの頭脳だ」<br><br>

                                            <div class="wa-poem-section">
                                                <div class="wa-poem-title">📜 機械の短歌</div>
                                                <div class="wa-poem-text">
                                                    真空管<br>
                                                    光りて巡る　想いかな<br>
                                                    CPUの胸に<br>
                                                    恋を処理せん<br>
                                                </div>
                                            </div><br>

                                            戦争が終わり、美奈子と正太郎は結婚した。<br>
                                            二人の結婚式の日、美奈子は言った。<br><br>

                                            「私たちの愛も、コンピュータと同じ。<br>
                                            入力は『出会い』、処理は『思いやり』、出力は『幸せ』よ」<br><br>

                                            そして現代、スマートフォンの中には数十億個のトランジスタが働いている。<br>
                                            美奈子の機械式計算機から始まった技術革新は、今も私たちの愛を結び続けている。
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="wa-story-sidebar">
                            <div class="wa-key-concepts">
                                <h3 class="wa-concepts-title">🔑 重要概念</h3>
                                <div class="wa-concept-list">
                                    <div class="wa-concept-item">
                                        <strong>CPU</strong>: コンピュータの中央処理装置、計算と制御を行う
                                    </div>
                                    <div class="wa-concept-item">
                                        <strong>フェッチ・デコード・実行サイクル</strong>: CPUの基本的な動作パターン
                                    </div>
                                    <div class="wa-concept-item">
                                        <strong>RAM</strong>: ランダムアクセスメモリ、一時的なデータ保存
                                    </div>
                                    <div class="wa-concept-item">
                                        <strong>ハードディスク</strong>: 永続的なデータ保存装置
                                    </div>
                                    <div class="wa-concept-item">
                                        <strong>トランジスタ</strong>: デジタル信号の制御を行う基本素子
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 2進数・16進数の概念 -->
            <div class="wa-content-section" id="binary">
                <div class="wa-story-content">
                    <div class="wa-story-header">
                        <h2 class="wa-story-title">💻 2進数・16進数の概念</h2>
                        <div class="wa-story-subtitle">第三章：暗号解読師の恋</div>
                        <div class="wa-divider"></div>
                    </div>

                    <div class="wa-story-layout">
                        <div class="wa-story-main">
                            <div class="wa-story-body">
                                <div class="wa-story-scroll" id="binaryStoryScroll">
                                    <div class="wa-story-section">
                                        <div class="wa-typewriter-text" id="binaryStory">
                                            1944年、英国の暗号解読所。若き数学者・章太郎は、ドイツ軍の暗号と格闘していた。<br><br>

                                            その日、彼の元に届いた暗号は、これまでとは違っていた。<br>
                                            "101101110011 110000111001 100101110000"<br><br>

                                            これは2進数で書かれている。章太郎はすぐに気づいた。<br>
                                            これは敵の暗号ではなく、恋人・花子からのメッセージだった。<br><br>

                                            2進数から10進数に変換してみる。<br>
                                            - 101101110011 = 2931<br>
                                            - 110000111001 = 3129<br>
                                            - 100101110000 = 2416<br><br>

                                            しかし、数字だけでは意味が分からない。章太郎は16進数でも試してみた。<br>
                                            - 2931 → B73 (16進数)<br>
                                            - 3129 → C39<br>
                                            - 2416 → 970<br><br>

                                            その時、章太郎はASCIIコード表を見ていた。<br>
                                            - B = 66 + 7 = 73 → 'I'<br>
                                            - C = 67 + 3 = 32 + 9 = ' L'<br>
                                            - 970 → 'ove'<br><br>

                                            "I Love" - 花子からの愛の告白だった。<br><br>

                                            <div class="wa-poem-section">
                                                <div class="wa-poem-title">📜 進数の短歌</div>
                                                <div class="wa-poem-text">
                                                    二進法<br>
                                                    十六進法　心を読み<br>
                                                    暗号解き<br>
                                                    愛を知りけり<br>
                                                </div>
                                            </div><br>

                                            戦後、二人は結婚した。章太郎はコンピュータの開発者となり、<br>
                                            花子はプログラマーとなった。二人の恋が、デジタル技術の未来を切り開いた。
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="wa-story-sidebar">
                            <div class="wa-key-concepts">
                                <h3 class="wa-concepts-title">🔑 重要概念</h3>
                                <div class="wa-concept-list">
                                    <div class="wa-concept-item">
                                        <strong>2進数</strong>: 0と1だけで数を表現する方法、コンピュータの基本
                                    </div>
                                    <div class="wa-concept-item">
                                        <strong>16進数</strong>: 0-9とA-Fで数を表現、プログラミングで使用
                                    </div>
                                    <div class="wa-concept-item">
                                        <strong>進数変換</strong>: 異なる進数間の数値変換技術
                                    </div>
                                    <div class="wa-concept-item">
                                        <strong>桁上がり</strong>: 下位から上位への数値繰り上がり
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 文字コード（UTF-8） -->
            <div class="wa-content-section" id="encoding">
                <div class="wa-story-content">
                    <div class="wa-story-header">
                        <h2 class="wa-story-title">🌏 文字コード（UTF-8）</h2>
                        <div class="wa-story-subtitle">第四章：国際恋文の文字化け</div>
                        <div class="wa-divider"></div>
                    </div>

                    <div class="wa-story-layout">
                        <div class="wa-story-main">
                            <div class="wa-story-body">
                                <div class="wa-story-scroll" id="encodingStoryScroll">
                                    <div class="wa-story-section">
                                        <div class="wa-typewriter-text" id="encodingStory">
                                            1950年、大学で学ぶ日本人留学生・美幸。彼女はアメリカ人の恋人・ジョンと手紙で遠距離恋愛をしていた。<br><br>

                                            ある日、ジョンから届いた手紙が奇妙だった。<br>
                                            "I ��� you, my ���"<br><br>

                                            美幸の日本語の部分が、すべて文字化けしていた。<br>
                                            これは文字コードの問題だった。<br><br>

                                            当時のASCIIコードは、英数字しか扱えない。<br>
                                            - ASCII: 7ビット（128文字）<br>
                                            - 日本語: ひらがな・カタカナ・漢字で数千文字<br><br>

                                            美幸は研究した。日本では各社が独自の文字コードを開発。<br>
                                            - Shift_JIS: マイクロソフトが開発<br>
                                            - EUC-JP: Unix系で使用<br>
                                            - ISO-2022-JP: メールで使用<br><br>

                                            しかし、これらは互いに互換性がない。<br>
                                            異なるシステム間でテキストを交換すると文字化けが発生する。<br><br>

                                            そこで颯爽としたのがUTF-8。<br>
                                            - 世界中のあらゆる文字を一つのコードで表現<br>
                                            - 可変長エンコーディング<br>
                                            - ASCIIとの下位互換性<br><br>

                                            <div class="wa-poem-section">
                                                <div class="wa-poem-title">📜 文字の短歌</div>
                                                <div class="wa-poem-text">
                                                    世界を結ぶ<br>
                                                    UTF-8　恋文を<br>
                                                    文字化けせず<br>
                                                    想いを伝えん<br>
                                                </div>
                                            </div><br>

                                            現代のWebやメールではUTF-8が標準となった。<br>
                                            美幸とジョンの恋文も、今では日本語も英語も美しく表示される。
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="wa-story-sidebar">
                            <div class="wa-key-concepts">
                                <h3 class="wa-concepts-title">🔑 重要概念</h3>
                                <div class="wa-concept-list">
                                    <div class="wa-concept-item">
                                        <strong>文字コード</strong>: 文字をコンピュータで扱うための数値対応表
                                    </div>
                                    <div class="wa-concept-item">
                                        <strong>UTF-8</strong>: 世界中の文字を一つのコードで表現する方式
                                    </div>
                                    <div class="wa-concept-item">
                                        <strong>文字化け</strong>: 文字コードの違いによって正しく表示されない現象
                                    </div>
                                    <div class="wa-concept-item">
                                        <strong>エンコーディング</strong>: 文字をバイト列に変換する方式
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- データサイズの概念 -->
            <div class="wa-content-section" id="datasize">
                <div class="wa-story-content">
                    <div class="wa-story-header">
                        <h2 class="wa-story-title">📊 データサイズの概念</h2>
                        <div class="wa-story-subtitle">第五章：写真データで綴る思い出の重さ</div>
                        <div class="wa-divider"></div>
                    </div>

                    <div class="wa-story-layout">
                        <div class="wa-story-main">
                            <div class="wa-story-body">
                                <div class="wa-story-scroll" id="datasizeStoryScroll">
                                    <div class="wa-story-section">
                                        <div class="wa-typewriter-text" id="datasizeStory">
                                            1990年、コンピュータが家庭に普及し始めた時代。大学生の由美は、交換日記で出会ったアメリカ人のマイクと遠距離恋愛中。<br><br>

                                            彼女のコンピュータのハードディスクは10MB（メガバイト）しかない。<br>
                                            マイクとの写真を一枚保存するだけで、貴重な容量を消費してしまう。<br><br>

                                            情報の単位を理解しよう。<br>
                                            - 1ビット = 0または1の情報<br>
                                            - 1バイト = 8ビット<br>
                                            - 1KB = 1,024バイト<br>
                                            - 1MB = 1,024KB = 1,048,576バイト<br>
                                            - 1GB = 1,024MB<br><br>

                                            当時のデジタルカメラでは、一枚の写真が約1MB。<br>
                                            ハードディスクに10枚しか保存できない。<br><br>

                                            由美は考えた。フロッピーディスクは1.44MB。<br>
                                            マイクとの写真を送るには、メールで送信するしかない。<br><br>

                                            しかし、当時のメールシステムは数百キロバイトまでしか送信できない。<br>
                                            1MBの写真は送れないのだ。<br><br>

                                            <div class="wa-poem-section">
                                                <div class="wa-poem-title">📜 データの短歌</div>
                                                <div class="wa-poem-text">
                                                    メガバイト<br>
                                                    ひとつひとつの　思い出<br>
                                                    送りたきけれど<br>
                                                    容量足らず<br>
                                                </div>
                                            </div><br>

                                            今ではギガバイト、テラバイトの時代。<br>
                                            由美とマイクは結婚し、クラウドストレージで何万枚もの思い出を保存している。
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="wa-story-sidebar">
                            <div class="wa-key-concepts">
                                <h3 class="wa-concepts-title">🔑 重要概念</h3>
                                <div class="wa-concept-list">
                                    <div class="wa-concept-item">
                                        <strong>バイト</strong>: コンピュータの基本データ単位（8ビット）
                                    </div>
                                    <div class="wa-concept-item">
                                        <strong>KB（キロバイト）</strong>: 1,024バイト、テキストファイルのサイズ
                                    </div>
                                    <div class="wa-concept-item">
                                        <strong>MB（メガバイト）</strong>: 1,024KB、画像ファイルのサイズ
                                    </div>
                                    <div class="wa-concept-item">
                                        <strong>GB（ギガバイト）</strong>: 1,024MB、ハードディスクの容量
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 浮動小数点数 -->
            <div class="wa-content-section" id="floating">
                <div class="wa-story-content">
                    <div class="wa-story-header">
                        <h2 class="wa-story-title">🗺️ 浮動小数点数</h2>
                        <div class="wa-story-subtitle">第六章：測量技師の精密な愛の計算</div>
                        <div class="wa-divider"></div>
                    </div>

                    <div class="wa-story-layout">
                        <div class="wa-story-main">
                            <div class="wa-story-body">
                                <div class="wa-story-scroll" id="floatingStoryScroll">
                                    <div class="wa-story-section">
                                        <div class="wa-typewriter-text" id="floatingStory">
                                            1955年、地理測量所の技師・一郎は、恋人・章子との結婚式のために教会までの正確な距離を計算していた。<br><br>

                                            GPSがない時代、測量は手作業。三角法で計算すると...<br>
                                            教会までの直線距離: 3.14159265358979...キロメートル<br><br>

                                            この無限小数をコンピュータでどう表現する？<br>
                                            整数とは違い、小数には「浮動小数点」という方式が必要だ。<br><br>

                                            浮動小数点の仕組み：<br>
                                            - 符号ビット: 正負の符号<br>
                                            - 指数部: 小数点の位置<br>
                                            - 仮数部: 実際の数値データ<br><br>

                                            例: 3.14159 → 1.14159 × 2¹ (2進数で)<br><br>

                                            しかし、浮動小数点には落とし穴がある。<br>
                                            0.1 + 0.2 = 0.30000000000000004<br>
                                            これは2進数では0.1を正確に表現できないからだ。<br><br>

                                            一郎は精密な計算のため、固定小数点や有理数演算を使うことにした。<br><br>

                                            <div class="wa-poem-section">
                                                <div class="wa-poem-title">📜 数値の短歌</div>
                                                <div class="wa-poem-text">
                                                    無限を<br>
                                                    有限で表し　数々かな<br>
                                                    浮動小数<br>
                                                    愛も計算<br>
                                                </div>
                                            </div><br>

                                            結婚式の日、一郎は章子に言った。<br>
                                            「君への愛は浮動小数点じゃ表現できない。無限大だから」
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="wa-story-sidebar">
                            <div class="wa-key-concepts">
                                <h3 class="wa-concepts-title">🔑 重要概念</h3>
                                <div class="wa-concept-list">
                                    <div class="wa-concept-item">
                                        <strong>浮動小数点</strong>: コンピュータで小数を表現する方式
                                    </div>
                                    <div class="wa-concept-item">
                                        <strong>IEEE 754</strong>: 浮動小数点数の國際標準
                                    </div>
                                    <div class="wa-concept-item">
                                        <strong>丸め誤差</strong>: 有限のビットで無限小数を表現することで発生する誤差
                                    </div>
                                    <div class="wa-concept-item">
                                        <strong>仮数部・指数部</strong>: 浮動小数点数の構成要素
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- データ圧縮 -->
            <div class="wa-content-section" id="compression">
                <div class="wa-story-content">
                    <div class="wa-story-header">
                        <h2 class="wa-story-title">📦 データ圧縮</h2>
                        <div class="wa-story-subtitle">第七章：限られた通信で伝える想い</div>
                        <div class="wa-divider"></div>
                    </div>

                    <div class="wa-story-layout">
                        <div class="wa-story-main">
                            <div class="wa-story-body">
                                <div class="wa-story-scroll" id="compressionStoryScroll">
                                    <div class="wa-story-section">
                                        <div class="wa-typewriter-text" id="compressionStory">
                                            1969年、アポロ11号の時代。無線通信技師の八郎は、地球から月の基地で働く恋人・かおりへメッセージを送っていた。<br><br>

                                            しかし、地球から月までの通信は極めて限られている。<br>
                                            1日に送れるデータ量はわずか10KB。<br><br>

                                            八郎のメッセージは長い。<br>
                                            「かおりへ。今日も君を思っています。この遠い宇宙の中で、君への愛だけが私の心を支えています。」<br><br>

                                            このテキストをそのまま送ると1200バイト。しかし、圧縮すれば...<br><br>

                                            データ圧縮の原理：<br>
                                            1. 繰り返しの検出: 「君へ」が3回出現<br>
                                            2. 辞書化: 「君へ」→ 「#1」で置き換え<br>
                                            3. LZ77アルゴリズム: 過去に出現した文字列を参照<br><br>

                                            結果、800バイトまで圧縮できた。<br>
                                            縮率: 33%、400バイトの節約。<br><br>

                                            しかし、圧縮にはリスクもある。<br>
                                            非可逆圧縮だと、情報が永久に失われる。<br>
                                            JPEG写真のように、圧縮するたびに画質が劣化する。<br><br>

                                            <div class="wa-poem-section">
                                                <div class="wa-poem-title">📜 圧縮の短歌</div>
                                                <div class="wa-poem-text">
                                                    想いをこめ<br>
                                                    数少な文字で　伝えたき<br>
                                                    圧縮アルゴ<br>
                                                    愛を節約せん<br>
                                                </div>
                                            </div><br>

                                            アポロ計画が成功し、かおりは地球に帰還した。<br>
                                            八郎は言った。「圧縮した情報の中に、僕の全ての愛が詰まっていたんだ」
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="wa-story-sidebar">
                            <div class="wa-key-concepts">
                                <h3 class="wa-concepts-title">🔑 重要概念</h3>
                                <div class="wa-concept-list">
                                    <div class="wa-concept-item">
                                        <strong>データ圧縮</strong>: データサイズを小さくする技術
                                    </div>
                                    <div class="wa-concept-item">
                                        <strong>可逆圧縮</strong>: 情報を失わずに圧縮する方式（ZIPなど）
                                    </div>
                                    <div class="wa-concept-item">
                                        <strong>非可逆圧縮</strong>: 情報を捨てて圧縮する方式（JPEGなど）
                                    </div>
                                    <div class="wa-concept-item">
                                        <strong>LZ系アルゴリズム</strong>: 繰り返しパターンを利用した圧縮手法
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- その他の分野 -->
            <div class="wa-content-section" id="algorithms">
                <div class="wa-coming-soon">
                    <div class="wa-coming-soon-icon">🚧</div>
                    <div class="wa-coming-soon-text">アルゴリズム分野の物語は準備中です</div>
                    <div class="wa-coming-soon-subtitle">効率的な愛の伝達方法をお楽しみに...</div>
                </div>
            </div>

            <div class="wa-content-section" id="web">
                <div class="wa-coming-soon">
                    <div class="wa-coming-soon-icon">🚧</div>
                    <div class="wa-coming-soon-text">Web技術分野の物語は準備中です</div>
                    <div class="wa-coming-soon-subtitle">遠距離恋愛を支えるWebの物語をお楽しみに...</div>
                </div>
            </div>

            <div class="wa-content-section" id="network">
                <div class="wa-coming-soon">
                    <div class="wa-coming-soon-icon">🚧</div>
                    <div class="wa-coming-soon-text">ネットワーク分野の物語は準備中です</div>
                    <div class="wa-coming-soon-subtitle">戦時通信網の恋愛物語をお楽しみに...</div>
                </div>
            </div>

            <div class="wa-content-section" id="security">
                <div class="wa-coming-soon">
                    <div class="wa-coming-soon-icon">🚧</div>
                    <div class="wa-coming-soon-text">セキュリティ分野の物語は準備中です</div>
                    <div class="wa-coming-soon-subtitle">暗号化された愛の手紙の物語をお楽しみに...</div>
                </div>
            </div>
        </section>
        -->

        <!-- アクションボタン -->
        <div class="wa-btn-group" style="margin-top: 3rem;">
            <button class="wa-btn wa-btn-primary" onclick="goToQuiz()">
                <span>⚔️</span>
                <span>雅なるクイズ対戦へ</span>
            </button>
            <button class="wa-btn wa-btn-secondary" onclick="goHome()">
                <span>🏠</span>
                <span>学習の間を出る</span>
            </button>
        </div>
    </main>

    <style>
        /* Guest専用同期パネルのスタイル */
        .wa-guest-sync-panel {
            animation: wa-slide-in 0.6s ease-out;
        }
        
        .wa-sync-card {
            background: linear-gradient(135deg, #f8f4ff 0%, #fff0f8 100%);
            border: 2px solid var(--take);
            border-radius: var(--border-radius-large);
            padding: var(--spacing-lg);
        }
        
        .wa-sync-header {
            display: flex;
            align-items: center;
            margin-bottom: var(--spacing-md);
            gap: var(--spacing-sm);
        }
        
        .wa-sync-icon {
            font-size: 1.8rem;
        }
        
        .wa-sync-title {
            color: var(--enjhi);
            font-family: var(--font-accent);
            font-size: 1.4rem;
            margin: 0;
            flex-grow: 1;
        }
        
        .wa-sync-status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--take);
            animation: wa-pulse 2s infinite;
        }
        
        .wa-sync-status-dot.wa-sync-success {
            background: var(--take);
        }
        
        .wa-sync-status-dot.wa-sync-error {
            background: var(--enjhi);
            animation: none;
        }
        
        .wa-sync-description {
            color: var(--sumi);
            line-height: 1.6;
            margin-bottom: var(--spacing-md);
        }
        
        .wa-sync-info {
            padding: var(--spacing-sm) 0;
            border-top: 1px solid rgba(178, 45, 53, 0.2);
        }
        
        .wa-sync-status-text {
            color: var(--take);
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        /* 無効化されたナビゲーション */
        .wa-nav-item.wa-nav-disabled {
            opacity: 0.4;
            cursor: not-allowed;
            background: rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }
        
        .wa-nav-item.wa-nav-disabled:hover {
            transform: none;
            background: rgba(0, 0, 0, 0.05);
        }
        
        /* Guest通知のスタイル */
        .wa-guest-notice {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            background: var(--gradient-sakura);
            border: 2px solid var(--enjhi);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-strong);
            max-width: 350px;
            animation: wa-notice-slide-in 0.4s ease-out;
        }
        
        .wa-notice-content {
            display: flex;
            align-items: flex-start;
            padding: var(--spacing-lg);
            gap: var(--spacing-md);
        }
        
        .wa-notice-icon {
            font-size: 2rem;
            flex-shrink: 0;
        }
        
        .wa-notice-text h4 {
            color: var(--enjhi);
            font-family: var(--font-accent);
            margin: 0 0 var(--spacing-xs) 0;
            font-size: 1.1rem;
        }
        
        .wa-notice-text p {
            color: var(--sumi);
            margin: 0;
            line-height: 1.5;
            font-size: 0.9rem;
        }
        
        .wa-notice-close {
            background: none;
            border: none;
            color: var(--enjhi);
            font-size: 1.4rem;
            font-weight: bold;
            cursor: pointer;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }
        
        .wa-notice-close:hover {
            background: rgba(178, 45, 53, 0.1);
        }
        
        /* アニメーション */
        @keyframes wa-notice-slide-in {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .wa-fade-out {
            animation: wa-notice-slide-out 0.3s ease-in forwards;
        }
        
        @keyframes wa-notice-slide-out {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
        
        @keyframes wa-slide-in {
            from {
                transform: translateY(-20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        @keyframes wa-pulse {
            0%, 100% {
                opacity: 1;
                transform: scale(1);
            }
            50% {
                opacity: 0.7;
                transform: scale(1.2);
            }
        }
        
        /* レスポンシブ対応 */
        @media (max-width: 768px) {
            .wa-guest-notice {
                left: 10px;
                right: 10px;
                top: 10px;
                max-width: none;
            }
            
            .wa-sync-card {
                padding: var(--spacing-md);
            }
            
            .wa-sync-title {
                font-size: 1.2rem;
            }
        }
    </style>
    <!-- 統合済み: 末尾の重複スクリプトは削除しました（上部スクリプトで同期・装飾を一元管理） -->
</body>
</html>