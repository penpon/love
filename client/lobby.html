<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ«ãƒ¼ãƒ æƒ…å ±å…¥åŠ› - CSå­¦ç¿’ã‚¯ã‚¤ã‚ºãƒãƒˆãƒ«</title>
    <link rel="stylesheet" href="css/taisho.css">
</head>
<body>
    <!-- å››å­£ã®è£…é£¾è¦ç´  -->
    <div class="seasonal-decoration" id="seasonalDecoration"></div>

    <main class="washi-container wa-fade-in">
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <header class="wa-header">
            <h1 class="wa-title">å­¦ç¿’ã®åº§æ•·ã¸ã‚ˆã†ã“ã</h1>
            <p class="wa-subtitle" id="roleSubtitle">ä¸»å‚¬è€…ã¨ã—ã¦ãƒ«ãƒ¼ãƒ ã‚’è¨­å–¶</p>
            <div class="wa-divider"></div>
        </header>

        <!-- å½¹å‰²è¡¨ç¤ºãƒãƒƒã‚¸ -->
        <div class="wa-role-badge" id="roleBadge">
            <span class="wa-role-icon" id="roleIcon">ğŸ‘‘</span>
            <span class="wa-role-text" id="roleText">ä¸»å‚¬è€… (Owner)</span>
        </div>

        <!-- ãƒ«ãƒ¼ãƒ è¨­å®šãƒ•ã‚©ãƒ¼ãƒ  -->
        <section class="wa-room-setup">
            <div class="wa-form">
                <h2 class="wa-form-title">ğŸ›ï¸ ãƒ«ãƒ¼ãƒ æƒ…å ±</h2>

                <div class="wa-form-group">
                    <label class="wa-form-label" for="roomId">
                        <span class="wa-label-icon">ğŸ®</span>
                        ãƒ«ãƒ¼ãƒ å
                    </label>
                    <input 
                        type="text" 
                        id="roomId" 
                        class="wa-form-input" 
                        placeholder="ä¾‹: å¤§æ­£æµªæ¼«å­¦ç¿’å®¤" 
                        maxlength="20"
                        autocomplete="off"
                    >
                    <div class="wa-form-hint">
                        è‹±æ•°å­—ãƒ»ã²ã‚‰ãŒãªãƒ»ã‚«ã‚¿ã‚«ãƒŠãƒ»æ¼¢å­—ãŒä½¿ç”¨ã§ãã¾ã™ï¼ˆ4-20æ–‡å­—ï¼‰
                    </div>
                </div>

                <div class="wa-form-group">
                    <label class="wa-form-label" for="playerName">
                        <span class="wa-label-icon">ğŸ­</span>
                        ãŠåå‰
                    </label>
                    <input 
                        type="text" 
                        id="playerName" 
                        class="wa-form-input" 
                        placeholder="ä¾‹: æ‹ã™ã‚‹å­¦ç¿’è€…" 
                        maxlength="15"
                        autocomplete="name"
                    >
                    <div class="wa-form-hint">
                        å­¦ç¿’ä»²é–“ã«è¡¨ç¤ºã•ã‚Œã‚‹ãŠåå‰ã§ã™ï¼ˆ2-15æ–‡å­—ï¼‰
                    </div>
                </div>


                <!-- æ¥ç¶šãƒœã‚¿ãƒ³ -->
                <div class="wa-btn-group">
                    <button class="wa-btn wa-btn-outline" onclick="goBack()">
                        <span>ğŸ”™</span>
                        <span>æˆ»ã‚‹</span>
                    </button>
                    <button class="wa-btn wa-btn-primary" id="connectBtn" onclick="connectToRoom()">
                        <span id="connectIcon">ğŸ®</span>
                        <span id="connectText">å­¦ç¿’ã®é–“ã«å…¥å®¤</span>
                    </button>
                </div>
            </div>
        </section>

        <!-- æ¥ç¶šçŠ¶æ³è¡¨ç¤º -->
        <div class="wa-connection-status" id="connectionStatus" style="display: none;">
            <div class="wa-card">
                <div class="wa-card-title">
                    <span id="statusIcon">ğŸ”„</span>
                    <span id="statusTitle">æ¥ç¶šä¸­...</span>
                </div>
                <div class="wa-card-content">
                    <div class="wa-progress">
                        <div class="wa-progress-bar" id="progressBar" style="width: 0%"></div>
                    </div>
                    <p id="statusMessage">ã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã—ã¦ã„ã¾ã™...</p>
                    
                    <!-- å‚åŠ è€…å¾…ã¡ï¼ˆOwnerå°‚ç”¨ï¼‰ -->
                    <div class="wa-waiting-guest" id="waitingGuest" style="display: none;">
                        <h4>ğŸ‘¥ å‚åŠ è€…ã‚’ãŠå¾…ã¡ã—ã¦ã„ã¾ã™</h4>
                        <p>ä»–ã®æ–¹ãŒã“ã®ãƒ«ãƒ¼ãƒ ã«å‚åŠ ã™ã‚‹ã¾ã§ãŠå¾…ã¡ãã ã•ã„</p>
                        <div class="wa-room-info">
                            <strong>ãƒ«ãƒ¼ãƒ å: </strong><span id="displayRoomId"></span>
                        </div>
                        <div class="wa-guest-instructions">
                            <h5>ğŸ“¢ å‚åŠ æ–¹æ³•ã‚’ãŠä¼ãˆãã ã•ã„</h5>
                            <ol>
                                <li>ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã§ã€Œå‚åŠ è€… (Guest)ã€ã‚’é¸æŠ</li>
                                <li>ãƒ«ãƒ¼ãƒ åã«ã€Œ<strong id="shareRoomId"></strong>ã€ã‚’å…¥åŠ›</li>
                                <li>ãŠåå‰ã‚’å…¥åŠ›ã—ã¦å…¥å®¤</li>
                            </ol>
                        </div>
                    </div>

                    <!-- å‚åŠ è€…è¡¨ç¤º -->
                    <div class="wa-participants" id="participants" style="display: none;">
                        <h4>ğŸ‘¤ å‚åŠ è€…</h4>
                        <div class="wa-participant-list">
                            <div class="wa-participant-item">
                                <span class="wa-participant-role">ä¸»å‚¬è€…</span>
                                <span class="wa-participant-name" id="ownerName">-</span>
                                <span class="wa-participant-status" id="ownerStatus">æº–å‚™å®Œäº†</span>
                            </div>
                            <div class="wa-participant-item">
                                <span class="wa-participant-role">å‚åŠ è€…</span>
                                <span class="wa-participant-name" id="guestName">å¾…æ©Ÿä¸­...</span>
                                <span class="wa-participant-status" id="guestStatus">æœªæ¥ç¶š</span>
                            </div>
                        </div>
                    </div>

                    <!-- ç¶šè¡Œãƒœã‚¿ãƒ³ -->
                    <div class="wa-btn-group" id="proceedBtnGroup" style="display: none; margin-top: 2rem;">
                        <button class="wa-btn wa-btn-secondary wa-pulse" id="proceedButton" onclick="proceedToModeSelect()">
                            <span id="proceedIcon">âœ¨</span>
                            <span id="proceedText">ãƒ¢ãƒ¼ãƒ‰é¸æŠã¸é€²ã‚€</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ã‚¨ãƒ©ãƒ¼è¡¨ç¤º -->
        <div class="wa-error-display" id="errorDisplay" style="display: none;">
            <div class="wa-alert wa-alert-error">
                <h4>âš ï¸ æ¥ç¶šã‚¨ãƒ©ãƒ¼</h4>
                <p id="errorMessage"></p>
                <button class="wa-btn wa-btn-outline" onclick="retryConnection()">
                    <span>ğŸ”„</span>
                    <span>å†è©¦è¡Œ</span>
                </button>
            </div>
        </div>

        <!-- ãƒ˜ãƒ«ãƒ—æƒ…å ± -->
        <div class="wa-help-section">
            <div class="wa-card">
                <div class="wa-card-title">ğŸ’¡ ã”åˆ©ç”¨æ–¹æ³•</div>
                <div class="wa-card-content">
                    <div class="wa-help-grid">
                        <div class="wa-help-item">
                            <strong>ğŸ‘‘ ä¸»å‚¬è€…ã®æ–¹</strong>
                            <p>æ–°ã—ã„ãƒ«ãƒ¼ãƒ åã¨ãŠåå‰ã‚’å…¥åŠ›ã—ã¦ãƒ«ãƒ¼ãƒ ã‚’ä½œæˆã—ã¾ã™ã€‚å‚åŠ è€…ã®å…¥å®¤ã‚’ãŠå¾…ã¡ã—ã¾ã™ã€‚</p>
                        </div>
                        <div class="wa-help-item">
                            <strong>ğŸ‹ å‚åŠ è€…ã®æ–¹</strong>
                            <p>ä¸»å‚¬è€…ãŒä½œæˆã—ãŸãƒ«ãƒ¼ãƒ åã¨ãŠåå‰ã‚’å…¥åŠ›ã—ã¦ãƒ«ãƒ¼ãƒ ã«å‚åŠ ã—ã¾ã™ã€‚è‡ªå‹•çš„ã«ä¸»å‚¬è€…ã¨æ¥ç¶šã•ã‚Œã¾ã™ã€‚</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒ¼ -->
        <div class="wa-status">
            <div class="wa-status-item">
                <span class="wa-status-dot" id="connectionDot"></span>
                <span id="connectionText">æœªæ¥ç¶š</span>
            </div>
            <div class="wa-status-item">
                <span>ğŸ­ å½¹å‰²: <span id="statusRole">-</span></span>
            </div>
            <div class="wa-status-item">
                <span>ğŸ® ãƒ«ãƒ¼ãƒ : <span id="statusRoom">æœªè¨­å®š</span></span>
            </div>
        </div>
    </main>

    <script src="/socket.io/socket.io.js"></script>
    <script src="js/socket.js"></script>
    <script>
        // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰å½¹å‰²ã‚’å–å¾—
        const urlParams = new URLSearchParams(window.location.search);
        const userRole = urlParams.get('role') || 'owner';
        
        let socket = null;
        let isConnecting = false;
        let roomConnected = false;
        
        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', () => {
            setupRoleUI();
            setupFormValidation();
            generateSeasonalElements('spring');
            
            // è‡ªå‹•å­£ç¯€å¤‰æ›´ï¼ˆ30ç§’ã”ã¨ï¼‰
            setInterval(changeSeason, 30000);
            
            // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹è¨­å®š
            setTimeout(() => {
                document.getElementById('roomId').focus();
            }, 500);
        });
        
        // å½¹å‰²ã«å¿œã˜ãŸUIè¨­å®š
        function setupRoleUI() {
            const roleIcon = document.getElementById('roleIcon');
            const roleText = document.getElementById('roleText');
            const roleSubtitle = document.getElementById('roleSubtitle');
            const statusRole = document.getElementById('statusRole');
            const connectBtn = document.getElementById('connectBtn');
            const connectText = document.getElementById('connectText');
            
            if (userRole === 'owner') {
                roleIcon.textContent = 'ğŸ‘‘';
                roleText.textContent = 'ä¸»å‚¬è€… (Owner)';
                roleSubtitle.textContent = 'ä¸»å‚¬è€…ã¨ã—ã¦ãƒ«ãƒ¼ãƒ ã‚’è¨­å–¶';
                statusRole.textContent = 'ä¸»å‚¬è€…';
                connectText.textContent = 'ãƒ«ãƒ¼ãƒ ã‚’é–‹è¨­';
            } else {
                roleIcon.textContent = 'ğŸ‹';
                roleText.textContent = 'å‚åŠ è€… (Guest)';
                roleSubtitle.textContent = 'å‚åŠ è€…ã¨ã—ã¦å­¦ç¿’ã«åŠ ã‚ã‚‹';
                statusRole.textContent = 'å‚åŠ è€…';
                connectText.textContent = 'ãƒ«ãƒ¼ãƒ ã«å‚åŠ ';
                
                // Guestå°‚ç”¨ã®ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼
                document.getElementById('roomId').placeholder = 'ä¸»å‚¬è€…ã‹ã‚‰æ•™ãˆã¦ã‚‚ã‚‰ã£ãŸãƒ«ãƒ¼ãƒ å';
            }
        }
        
        // ãƒ•ã‚©ãƒ¼ãƒ æ¤œè¨¼
        function setupFormValidation() {
            const roomIdInput = document.getElementById('roomId');
            const playerNameInput = document.getElementById('playerName');
            const connectBtn = document.getElementById('connectBtn');
            
            function validateForm() {
                const roomId = roomIdInput.value.trim();
                const playerName = playerNameInput.value.trim();
                
                const isValid = roomId.length >= 4 && 
                               roomId.length <= 20 &&
                               playerName.length >= 2 && 
                               playerName.length <= 15;
                
                connectBtn.disabled = !isValid;
                
                // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
                updateFieldStatus(roomIdInput, roomId.length >= 4 && roomId.length <= 20);
                updateFieldStatus(playerNameInput, playerName.length >= 2 && playerName.length <= 15);
            }
            
            roomIdInput.addEventListener('input', validateForm);
            playerNameInput.addEventListener('input', validateForm);
            
            validateForm();
        }
        
        function updateFieldStatus(field, isValid) {
            if (field.value.length > 0) {
                if (isValid) {
                    field.style.borderColor = 'var(--take)';
                    field.style.backgroundColor = 'rgba(74, 122, 78, 0.1)';
                } else {
                    field.style.borderColor = 'var(--enjhi)';
                    field.style.backgroundColor = 'rgba(178, 45, 53, 0.05)';
                }
            } else {
                field.style.borderColor = 'var(--ai)';
                field.style.backgroundColor = 'var(--washi)';
            }
        }
        
        // ãƒ«ãƒ¼ãƒ æ¥ç¶š
        function connectToRoom() {
            if (isConnecting) {
                showError('ç¾åœ¨æ¥ç¶šå‡¦ç†ä¸­ã§ã™ã€‚ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚');
                return;
            }
            
            if (roomConnected) {
                showError('æ—¢ã«ãƒ«ãƒ¼ãƒ ã«æ¥ç¶šã•ã‚Œã¦ã„ã¾ã™ã€‚');
                return;
            }
            
            const roomId = document.getElementById('roomId').value.trim();
            const playerName = document.getElementById('playerName').value.trim();
            const connectBtn = document.getElementById('connectBtn');
            
            // ãƒ•ã‚©ãƒ¼ãƒ æ¤œè¨¼
            if (!roomId) {
                showError('ãƒ«ãƒ¼ãƒ åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                return;
            } else if (roomId.length < 4) {
                showError(`ãƒ«ãƒ¼ãƒ åãŒçŸ­ã™ãã¾ã™ã€‚ç¾åœ¨${roomId.length}æ–‡å­—ï¼ˆ4æ–‡å­—ä»¥ä¸Šå¿…è¦ï¼‰`);
                return;
            } else if (roomId.length > 20) {
                showError(`ãƒ«ãƒ¼ãƒ åãŒé•·ã™ãã¾ã™ã€‚ç¾åœ¨${roomId.length}æ–‡å­—ï¼ˆ20æ–‡å­—ä»¥å†…ï¼‰`);
                return;
            }
            
            if (!playerName) {
                showError('ãŠåå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                return;
            } else if (playerName.length < 2) {
                showError(`ãŠåå‰ãŒçŸ­ã™ãã¾ã™ã€‚ç¾åœ¨${playerName.length}æ–‡å­—ï¼ˆ2æ–‡å­—ä»¥ä¸Šå¿…è¦ï¼‰`);
                return;
            } else if (playerName.length > 15) {
                showError(`ãŠåå‰ãŒé•·ã™ãã¾ã™ã€‚ç¾åœ¨${playerName.length}æ–‡å­—ï¼ˆ15æ–‡å­—ä»¥å†…ï¼‰`);
                return;
            }
            
            // æ¥ç¶šé–‹å§‹
            isConnecting = true;
            connectBtn.disabled = true;
            
            // ãƒœã‚¿ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’æ›´æ–°
            const connectText = document.getElementById('connectText');
            const connectIcon = document.getElementById('connectIcon');
            connectText.textContent = 'æ¥ç¶šä¸­...';
            connectIcon.textContent = 'ğŸ”„';
            
            showConnectionStatus();
            updateProgress(20, 'ã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šä¸­...');
            
            // æ—¢å­˜ã®æ¥ç¶šã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
            if (socket) {
                console.log('æ—¢å­˜ã®Socketæ¥ç¶šã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã—ã¾ã™');
                socket.removeAllListeners();
                socket.disconnect();
                socket = null;
            }
            
            // æ–°ã—ã„Socket.ioæ¥ç¶šã‚’ä½œæˆ
            socket = io({
                forceNew: true,
                transports: ['websocket', 'polling']
            });
            
            socket.on('connect', () => {
                console.log('ã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã—ã¾ã—ãŸ');
                updateProgress(40, 'ãƒ«ãƒ¼ãƒ æƒ…å ±ã‚’é€ä¿¡ä¸­...');
                
                socket.emit('join_room', {
                    roomId: roomId,
                    playerName: playerName,
                    role: userRole
                });
            });
            
            socket.on('connect_error', (error) => {
                console.error('æ¥ç¶šã‚¨ãƒ©ãƒ¼:', error);
                let errorMessage = 'ã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã§ãã¾ã›ã‚“ã§ã—ãŸã€‚';
                
                if (error.type === 'TransportError') {
                    errorMessage += 'é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
                } else if (error.message) {
                    errorMessage += `ã‚¨ãƒ©ãƒ¼: ${error.message}`;
                } else {
                    errorMessage += 'ã—ã°ã‚‰ãå¾…ã£ã¦ã‹ã‚‰å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚';
                }
                
                showError(errorMessage);
            });
            
            socket.on('room_full', () => {
                showError('ã“ã®ãƒ«ãƒ¼ãƒ ã¯æº€å®¤ã§ã™ã€‚åˆ¥ã®ãƒ«ãƒ¼ãƒ åã‚’ãŠè©¦ã—ãã ã•ã„ã€‚');
                isConnecting = false;
            });
            
            socket.on('room_status', (data) => {
                console.log('ãƒ«ãƒ¼ãƒ çŠ¶æ³:', data);
                updateProgress(80, 'ãƒ«ãƒ¼ãƒ çŠ¶æ³ã‚’ç¢ºèªä¸­...');
                
                setTimeout(() => {
                    updateRoomStatus(data);
                    isConnecting = false;
                    roomConnected = true;
                    updateProgress(100, 'æº–å‚™å®Œäº†ï¼');
                }, 1000);
            });
            
            socket.on('match_found', (data) => {
                console.log('ãƒãƒƒãƒãƒ³ã‚°å®Œäº†:', data);
                showParticipants(data);
            });
            
            socket.on('player_disconnected', (data) => {
                showError(`${data.playerName}ã•ã‚“ãŒåˆ‡æ–­ã•ã‚Œã¾ã—ãŸã€‚`);
                resetConnection();
            });
            
            socket.on('room_closed_by_owner', (data) => {
                console.log('ä¸»å‚¬è€…ã«ã‚ˆã£ã¦ãƒ«ãƒ¼ãƒ ãŒé–‰ã˜ã‚‰ã‚Œã¾ã—ãŸ:', data);
                showError(`${data.message}\nä¸»å‚¬è€…: ${data.ownerName} ã•ã‚“ãŒæ–°ã—ã„ãƒ«ãƒ¼ãƒ  "${data.newRoomId}" ã‚’ä½œæˆã—ã¾ã—ãŸã€‚`);
                resetConnection();
            });
            
            // Guestç”¨: Owner ãŒãƒ¢ãƒ¼ãƒ‰é¸æŠç”»é¢ã«é·ç§»ã—ãŸéš›ã®é€šçŸ¥ã®ã¿ï¼ˆé·ç§»ã¯ã—ãªã„ï¼‰
            socket.on('owner_proceeded_to_mode_select', (data) => {
                console.log(`Owner ${data.ownerName} ãŒãƒ¢ãƒ¼ãƒ‰é¸æŠç”»é¢ã«é·ç§»ã—ã¾ã—ãŸ`, data);
                
                // Guestã®å ´åˆã¯ä¸»å‚¬è€…ã®æ“ä½œå¾…ã¡ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
                if (userRole === 'guest') {
                    showGuestWaitingForOwner();
                }
            });
            
            // Guestç”¨: å­¦ç¿’ãƒ¢ãƒ¼ãƒ‰é¸æŠæ™‚ã®ç›´æ¥é·ç§»
            socket.on('redirect_to_learning', (data) => {
                console.log('å­¦ç¿’ãƒ¢ãƒ¼ãƒ‰ãŒé¸æŠã•ã‚Œã¾ã—ãŸ:', data);
                
                if (userRole === 'guest') {
                    const roomId = document.getElementById('roomId').value;
                    const playerName = document.getElementById('playerName').value;
                    
                    console.log('Guestã¨ã—ã¦å­¦ç¿’ç”»é¢ã«ç›´æ¥é·ç§»ã—ã¾ã™');
                    
                    // çŸ­ã„é…å»¶ã®å¾Œã€å­¦ç¿’ç”»é¢ã¸é·ç§»
                    setTimeout(() => {
                        window.location.href = `learning.html?role=${userRole}&roomId=${encodeURIComponent(roomId)}&playerName=${encodeURIComponent(playerName)}`;
                    }, 1000);
                }
            });
            
            // Guestç”¨: ã‚¯ã‚¤ã‚ºãƒ¢ãƒ¼ãƒ‰é¸æŠæ™‚ã®ç›´æ¥é·ç§»
            socket.on('redirect_to_matching', (data) => {
                console.log('ã‚¯ã‚¤ã‚ºãƒ¢ãƒ¼ãƒ‰ãŒé¸æŠã•ã‚Œã¾ã—ãŸ:', data);
                
                if (userRole === 'guest') {
                    const roomId = document.getElementById('roomId').value;
                    const playerName = document.getElementById('playerName').value;
                    
                    console.log('Guestã¨ã—ã¦ãƒãƒƒãƒãƒ³ã‚°ç”»é¢ã«ç›´æ¥é·ç§»ã—ã¾ã™');
                    
                    // çŸ­ã„é…å»¶ã®å¾Œã€ãƒãƒƒãƒãƒ³ã‚°ç”»é¢ã¸é·ç§»
                    setTimeout(() => {
                        window.location.href = `matching.html?role=${userRole}&roomId=${encodeURIComponent(roomId)}&playerName=${encodeURIComponent(playerName)}`;
                    }, 1000);
                }
            });
            
            socket.on('disconnect', () => {
                console.log('ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰åˆ‡æ–­ã•ã‚Œã¾ã—ãŸ');
                showError('ã‚µãƒ¼ãƒãƒ¼ã¨ã®æ¥ç¶šãŒåˆ‡æ–­ã•ã‚Œã¾ã—ãŸã€‚');
                resetConnection();
            });
        }
        
        function updateProgress(percent, message) {
            const progressBar = document.getElementById('progressBar');
            const statusMessage = document.getElementById('statusMessage');
            
            progressBar.style.width = percent + '%';
            statusMessage.textContent = message;
            
            if (percent === 100) {
                setTimeout(() => {
                    document.getElementById('statusIcon').textContent = 'âœ…';
                    document.getElementById('statusTitle').textContent = 'æº–å‚™å®Œäº†';
                }, 500);
            }
        }
        
        function updateRoomStatus(data) {
            const participants = data.players || [];
            const connectionDot = document.getElementById('connectionDot');
            const connectionText = document.getElementById('connectionText');
            const statusRoom = document.getElementById('statusRoom');
            
            connectionDot.style.backgroundColor = 'var(--take)';
            connectionText.textContent = 'æº–å‚™å®Œäº†';
            statusRoom.textContent = document.getElementById('roomId').value;
            
            // æ¥ç¶šå®Œäº†å¾Œã®ãƒœã‚¿ãƒ³çŠ¶æ…‹ã‚’æ›´æ–°
            updateConnectionButton();
            
            // ãƒœã‚¿ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’å½¹å‰²ã«å¿œã˜ã¦æ›´æ–°
            updateProceedButtonText();
            
            if (userRole === 'owner') {
                if (participants.length < 2) {
                    showWaitingForGuest();
                } else {
                    showParticipants({ players: participants });
                }
            } else {
                showParticipants({ players: participants });
            }
            
            // ãƒœã‚¿ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’æ›´æ–°
            updateProceedButtonText();
        }
        
        // æ¥ç¶šå®Œäº†å¾Œã®ãƒœã‚¿ãƒ³çŠ¶æ…‹ã‚’æ›´æ–°
        function updateConnectionButton() {
            const connectBtn = document.getElementById('connectBtn');
            const connectText = document.getElementById('connectText');
            const connectIcon = document.getElementById('connectIcon');
            
            // ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
            connectBtn.disabled = false;
            
            if (userRole === 'owner') {
                // Ownerã®å ´åˆï¼šãƒ«ãƒ¼ãƒ ä½œã‚Šç›´ã—
                connectText.textContent = 'ãƒ«ãƒ¼ãƒ ä½œã‚Šç›´ã—';
                connectIcon.textContent = 'ğŸ”„';
                connectBtn.onclick = recreateRoom;
            } else {
                // Guestã®å ´åˆï¼šæ¥ç¶šå–ã‚Šæ¶ˆã—
                connectText.textContent = 'æ¥ç¶šå–ã‚Šæ¶ˆã—';
                connectIcon.textContent = 'âŒ';
                connectBtn.onclick = cancelConnection;
            }
        }
        
        // Ownerç”¨ï¼šãƒ«ãƒ¼ãƒ ä½œã‚Šç›´ã—æ©Ÿèƒ½
        function recreateRoom() {
            console.log('ãƒ«ãƒ¼ãƒ ä½œã‚Šç›´ã—ã‚’é–‹å§‹ã—ã¾ã™');
            
            // ç¾åœ¨ã®æ¥ç¶šã‚’ãƒªã‚»ãƒƒãƒˆ
            resetConnection();
            
            // ãƒ•ã‚©ãƒ¼ãƒ ã®å€¤ã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆå…¥åŠ›å†…å®¹ã¯ä¿æŒã•ã‚Œã‚‹ï¼‰
            const roomId = document.getElementById('roomId').value.trim();
            const playerName = document.getElementById('playerName').value.trim();
            
            if (!roomId || !playerName) {
                showError('ãƒ«ãƒ¼ãƒ åã¨ãŠåå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
        }
        
        // Guestç”¨ï¼šæ¥ç¶šå–ã‚Šæ¶ˆã—æ©Ÿèƒ½
        function cancelConnection() {
            console.log('æ¥ç¶šã‚’å–ã‚Šæ¶ˆã—ã¾ã™');
            
            // ã‚µãƒ¼ãƒãƒ¼ã«ãƒ«ãƒ¼ãƒ é›¢è„±ã‚’é€šçŸ¥
            if (socket && socket.connected) {
                const roomId = document.getElementById('roomId').value.trim();
                socket.emit('leave_room', { roomId: roomId });
            }
            
            // æ¥ç¶šã‚’ãƒªã‚»ãƒƒãƒˆ
            resetConnection();
        }
        
        function showWaitingForGuest() {
            const waitingGuest = document.getElementById('waitingGuest');
            const displayRoomId = document.getElementById('displayRoomId');
            const shareRoomId = document.getElementById('shareRoomId');
            const roomId = document.getElementById('roomId').value;
            
            waitingGuest.style.display = 'block';
            displayRoomId.textContent = roomId;
            shareRoomId.textContent = roomId;
        }
        
        function showParticipants(data) {
            const participants = document.getElementById('participants');
            const proceedBtnGroup = document.getElementById('proceedBtnGroup');
            const waitingGuest = document.getElementById('waitingGuest');
            const ownerName = document.getElementById('ownerName');
            const guestName = document.getElementById('guestName');
            const guestStatus = document.getElementById('guestStatus');
            
            participants.style.display = 'block';
            waitingGuest.style.display = 'none';
            
            const players = data.players || [];
            
            // roleåŸºæº–ã§è¡¨ç¤ºï¼ˆOwner/Guesté †ã§ã¯ãªãå½¹å‰²ã§å›ºå®šï¼‰
            const ownerPlayer = players.find(p => p.role === 'owner');
            const guestPlayer = players.find(p => p.role === 'guest');
            
            // Ownerè¡¨ç¤º
            const ownerStatus = document.getElementById('ownerStatus');
            if (ownerPlayer) {
                ownerName.textContent = ownerPlayer.name;
                if (userRole === 'guest') {
                    ownerStatus.textContent = 'å¾…æ©Ÿä¸­';
                    ownerStatus.className = 'wa-participant-status';
                } else {
                    ownerStatus.textContent = 'æº–å‚™å®Œäº†';
                    ownerStatus.className = 'wa-participant-status ready';
                }
            } else {
                ownerName.textContent = 'å¾…æ©Ÿä¸­...';
                ownerStatus.textContent = 'æœªæ¥ç¶š';
                ownerStatus.className = 'wa-participant-status';
            }
            
            // Guestè¡¨ç¤º
            if (guestPlayer) {
                guestName.textContent = guestPlayer.name;
                guestStatus.textContent = 'æ¥ç¶šæ¸ˆã¿';
                guestStatus.className = 'wa-participant-status ready';
            } else {
                guestName.textContent = 'å¾…æ©Ÿä¸­...';
                guestStatus.textContent = 'æœªæ¥ç¶š';
                guestStatus.className = 'wa-participant-status';
            }
            
            // ä¸¡æ–¹æƒã£ãŸã®ã§ç¶šè¡Œãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
            if (players.length >= 2) {
                proceedBtnGroup.style.display = 'block';
                updateProceedButtonText();
            }
        }
        
        function showConnectionStatus() {
            const connectionStatus = document.getElementById('connectionStatus');
            const errorDisplay = document.getElementById('errorDisplay');
            
            connectionStatus.style.display = 'block';
            errorDisplay.style.display = 'none';
        }
        
        function showError(message) {
            const errorDisplay = document.getElementById('errorDisplay');
            const errorMessage = document.getElementById('errorMessage');
            const connectionStatus = document.getElementById('connectionStatus');
            const connectBtn = document.getElementById('connectBtn');
            
            errorMessage.textContent = message;
            errorDisplay.style.display = 'block';
            connectionStatus.style.display = 'none';
            
            // æ¥ç¶šçŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
            isConnecting = false;
            roomConnected = false;
            
            // ãƒ•ã‚©ãƒ¼ãƒ æ¤œè¨¼ã‚’å†å®Ÿè¡Œã—ã¦ãƒœã‚¿ãƒ³çŠ¶æ…‹ã‚’é©åˆ‡ã«è¨­å®š
            const roomId = document.getElementById('roomId').value.trim();
            const playerName = document.getElementById('playerName').value.trim();
            const isFormValid = roomId.length >= 4 && roomId.length <= 20 &&
                               playerName.length >= 2 && playerName.length <= 15;
            
            connectBtn.disabled = !isFormValid;
            
            // ãƒœã‚¿ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã¨ã‚¢ã‚¤ã‚³ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆ
            const connectText = document.getElementById('connectText');
            const connectIcon = document.getElementById('connectIcon');
            connectIcon.textContent = 'ğŸ®';
            
            if (userRole === 'owner') {
                connectText.textContent = 'ãƒ«ãƒ¼ãƒ ã‚’é–‹è¨­';
            } else {
                connectText.textContent = 'ãƒ«ãƒ¼ãƒ ã«å‚åŠ ';
            }
        }
        
        function retryConnection() {
            const errorDisplay = document.getElementById('errorDisplay');
            errorDisplay.style.display = 'none';
            resetConnection();
        }
        
        function resetConnection() {
            if (socket) {
                console.log('Socketæ¥ç¶šã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™');
                socket.removeAllListeners();
                socket.disconnect();
                socket = null;
            }
            isConnecting = false;
            roomConnected = false;
            
            const connectionStatus = document.getElementById('connectionStatus');
            const errorDisplay = document.getElementById('errorDisplay');
            const connectBtn = document.getElementById('connectBtn');
            
            connectionStatus.style.display = 'none';
            errorDisplay.style.display = 'none';
            
            // å‚åŠ è€…è¡¨ç¤ºã‚’ãƒªã‚»ãƒƒãƒˆ
            const participants = document.getElementById('participants');
            const proceedBtnGroup = document.getElementById('proceedBtnGroup');
            const waitingGuest = document.getElementById('waitingGuest');
            participants.style.display = 'none';
            proceedBtnGroup.style.display = 'none';
            waitingGuest.style.display = 'none';
            
            // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆ
            const progressBar = document.getElementById('progressBar');
            const statusIcon = document.getElementById('statusIcon');
            const statusTitle = document.getElementById('statusTitle');
            progressBar.style.width = '0%';
            statusIcon.textContent = 'ğŸ”„';
            statusTitle.textContent = 'æ¥ç¶šä¸­...';
            
            // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
            const connectionDot = document.getElementById('connectionDot');
            const connectionText = document.getElementById('connectionText');
            const statusRoom = document.getElementById('statusRoom');
            connectionDot.style.backgroundColor = 'var(--enjhi)';
            connectionText.textContent = 'æœªæ¥ç¶š';
            statusRoom.textContent = 'æœªè¨­å®š';
            
            // ãƒ•ã‚©ãƒ¼ãƒ æ¤œè¨¼ã‚’å†å®Ÿè¡Œã—ã¦ãƒœã‚¿ãƒ³çŠ¶æ…‹ã‚’é©åˆ‡ã«è¨­å®š
            const roomId = document.getElementById('roomId').value.trim();
            const playerName = document.getElementById('playerName').value.trim();
            const isFormValid = roomId.length >= 4 && roomId.length <= 20 &&
                               playerName.length >= 2 && playerName.length <= 15;
            
            connectBtn.disabled = !isFormValid;
            
            // ãƒœã‚¿ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã¨ã‚¢ã‚¤ã‚³ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆ
            const connectText = document.getElementById('connectText');
            const connectIcon = document.getElementById('connectIcon');
            connectIcon.textContent = 'ğŸ®';
            
            if (userRole === 'owner') {
                connectText.textContent = 'ãƒ«ãƒ¼ãƒ ã‚’é–‹è¨­';
            } else {
                connectText.textContent = 'ãƒ«ãƒ¼ãƒ ã«å‚åŠ ';
            }
            
            // onclickã‚¤ãƒ™ãƒ³ãƒˆã‚’å…ƒã«æˆ»ã™
            connectBtn.onclick = connectToRoom;
            
            // ç¶šè¡Œãƒœã‚¿ãƒ³ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’ãƒªã‚»ãƒƒãƒˆ
            updateProceedButtonText();
        }
        
        function proceedToModeSelect() {
            const roomId = document.getElementById('roomId').value;
            const playerName = document.getElementById('playerName').value;
            const proceedButton = document.getElementById('proceedButton');
            
            // ãƒœã‚¿ãƒ³ã‚’ä¸€æ™‚çš„ã«ç„¡åŠ¹åŒ–ã—ã¦ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã‚’é˜²ã
            if (proceedButton.disabled) return;
            proceedButton.disabled = true;
            
            // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä¸€æ™‚åœæ­¢
            proceedButton.classList.remove('wa-pulse');
            
            // å‡¦ç†å®Œäº†å¾Œã€ãƒœã‚¿ãƒ³çŠ¶æ…‹ã‚’å¾©å…ƒï¼ˆ3ç§’å¾Œï¼‰
            setTimeout(() => {
                proceedButton.disabled = false;
                proceedButton.classList.add('wa-pulse');
            }, 3000);
            
            if (userRole === 'owner') {
                // Ownerã®å ´åˆã€ã‚µãƒ¼ãƒãƒ¼ã«ãƒ¢ãƒ¼ãƒ‰é¸æŠé·ç§»ã‚’é€šçŸ¥ã—ã¦ã‹ã‚‰é·ç§»
                if (socket && socket.connected) {
                    socket.emit('proceed_to_mode_select', {
                        roomId: roomId
                    });
                }
                
                // ãƒ¢ãƒ¼ãƒ‰é¸æŠç”»é¢ã¸é·ç§»
                window.location.href = `mode-select.html?role=${userRole}&roomId=${encodeURIComponent(roomId)}&playerName=${encodeURIComponent(playerName)}`;
            } else {
                // Guestã®å ´åˆã€ä¸»å‚¬è€…ã®æ“ä½œã‚’å¾…ã¤ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
                showGuestWaitingForOwner();
            }
        }
        
        // ç¶šè¡Œãƒœã‚¿ãƒ³ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’å½¹å‰²ã«å¿œã˜ã¦æ›´æ–°
        function updateProceedButtonText() {
            const proceedButton = document.getElementById('proceedButton');
            const proceedIcon = document.getElementById('proceedIcon');
            const proceedText = document.getElementById('proceedText');
            
            if (!proceedButton || !proceedIcon || !proceedText) return;
            
            if (userRole === 'owner') {
                proceedIcon.textContent = 'âœ¨';
                proceedText.textContent = 'ãƒ¢ãƒ¼ãƒ‰é¸æŠã¸é€²ã‚€';
            } else {
                proceedIcon.textContent = 'ğŸ‹';
                proceedText.textContent = 'æ¥ç¶šã™ã‚‹';
            }
        }
        
        // Guestç”¨ã®å¾…æ©Ÿãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
        function showGuestWaitingForOwner() {
            // æ—¢å­˜ã®é€šçŸ¥ãŒã‚ã‚Œã°å‰Šé™¤
            const existingNotice = document.getElementById('guestWaitingNotice');
            if (existingNotice) {
                existingNotice.remove();
            }
            
            // é€šçŸ¥è¦ç´ ã‚’ä½œæˆ
            const notice = document.createElement('div');
            notice.id = 'guestWaitingNotice';
            notice.className = 'wa-guest-waiting-notice wa-fade-in';
            notice.innerHTML = `
                <div class="wa-notice-content">
                    <div class="wa-notice-icon">ğŸŒ¸</div>
                    <div class="wa-notice-text">
                        <h4>ğŸ‹ å‚åŠ è€…æ§˜ã¸ã®ã”æ¡ˆå†…</h4>
                        <p>
                            ä¸»å‚¬è€…(Owner)ãŒãƒ¢ãƒ¼ãƒ‰é¸æŠã‚’çµ‚ãˆã‚‹ã¾ã§ãŠå¾…ã¡ãã ã•ã„ã€‚<br>
                            ä¸»å‚¬è€…ã®é¸æŠãŒå®Œäº†ã™ã‚‹ã¨ã€è‡ªå‹•çš„ã«ç”»é¢ãŒåˆ‡ã‚Šæ›¿ã‚ã‚Šã¾ã™ã€‚
                        </p>
                        <div class="wa-waiting-animation">
                            <div class="wa-waiting-dot"></div>
                            <div class="wa-waiting-dot"></div>
                            <div class="wa-waiting-dot"></div>
                        </div>
                    </div>
                    <button class="wa-notice-close" onclick="this.closest('.wa-guest-waiting-notice').remove();">Ã—</button>
                </div>
            `;
            
            document.body.appendChild(notice);
        }

        function goBack() {
            if (socket) {
                socket.disconnect();
            }
            window.location.href = 'index.html';
        }
        
        // å››å­£ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®š
        const seasons = ['spring', 'summer', 'autumn', 'winter'];
        let currentSeasonIndex = 0;
        
        // å­£ç¯€åˆ‡ã‚Šæ›¿ãˆï¼ˆè‡ªå‹•ã®ã¿ï¼‰
        function changeSeason() {
            const seasonElement = document.getElementById('seasonalDecoration');
            
            currentSeasonIndex = (currentSeasonIndex + 1) % seasons.length;
            const season = seasons[currentSeasonIndex];
            
            seasonElement.className = `seasonal-decoration season-${season}`;
            
            // å­£ç¯€ã«å¿œã˜ãŸè£…é£¾è¦ç´ ã‚’ç”Ÿæˆ
            generateSeasonalElements(season);
        }
        
        // å­£ç¯€è£…é£¾ã®ç”Ÿæˆ
        function generateSeasonalElements(season = 'spring') {
            const container = document.getElementById('seasonalDecoration');
            container.innerHTML = '';
            
            const elementCount = 6;
            
            for (let i = 0; i < elementCount; i++) {
                const element = document.createElement('div');
                
                switch (season) {
                    case 'spring':
                        element.className = 'sakura-petal';
                        element.style.left = Math.random() * 100 + '%';
                        element.style.animationDelay = Math.random() * 8 + 's';
                        element.style.animationDuration = (6 + Math.random() * 4) + 's';
                        break;
                        
                    case 'summer':
                        element.className = 'summer-leaf';
                        element.style.cssText = `
                            position: absolute;
                            width: 8px;
                            height: 8px;
                            background: var(--tsuyu);
                            border-radius: 50% 0 50% 0;
                            left: ${Math.random() * 100}%;
                            animation: summerSway ${4 + Math.random() * 3}s ease-in-out infinite;
                            animation-delay: ${Math.random() * 4}s;
                            opacity: 0.3;
                        `;
                        break;
                        
                    case 'autumn':
                        element.className = 'momiji-leaf';
                        element.style.left = Math.random() * 100 + '%';
                        element.style.animationDelay = Math.random() * 10 + 's';
                        element.style.animationDuration = (8 + Math.random() * 4) + 's';
                        break;
                        
                    case 'winter':
                        element.className = 'snow-flake';
                        element.innerHTML = 'â„';
                        element.style.cssText = `
                            position: absolute;
                            color: var(--yuki);
                            font-size: ${6 + Math.random() * 6}px;
                            left: ${Math.random() * 100}%;
                            animation: snowFall ${6 + Math.random() * 6}s linear infinite;
                            animation-delay: ${Math.random() * 6}s;
                            opacity: 0.6;
                        `;
                        break;
                }
                
                container.appendChild(element);
            }
        }
        
        // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !isConnecting) {
                const connectBtn = document.getElementById('connectBtn');
                if (!connectBtn.disabled) {
                    connectToRoom();
                }
            }
            
            if (e.key === 'Escape') {
                goBack();
            }
        });
        
        // ãƒšãƒ¼ã‚¸é›¢è„±æ™‚ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
        window.addEventListener('beforeunload', () => {
            if (socket) {
                socket.disconnect();
            }
        });
    </script>

    <style>
        /* å¤ã¨å†¬ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        @keyframes summerSway {
            0%, 100% { transform: translateX(0) rotate(0deg); }
            25% { transform: translateX(10px) rotate(90deg); }
            75% { transform: translateX(-10px) rotate(270deg); }
        }
        
        @keyframes snowFall {
            0% {
                transform: translateY(-100px) rotate(0deg);
                opacity: 0;
            }
            10% {
                opacity: 0.8;
            }
            90% {
                opacity: 0.8;
            }
            100% {
                transform: translateY(100vh) rotate(360deg);
                opacity: 0;
            }
        }
        
        .wa-section-title {
            font-family: var(--font-accent);
            font-size: 1.5rem;
            color: var(--enjhi);
            text-align: center;
            margin-bottom: var(--spacing-xl);
        }

        .wa-role-badge {
            background: var(--gradient-sakura);
            border: 2px solid var(--enjhi);
            border-radius: var(--border-radius-large);
            padding: var(--spacing-md) var(--spacing-lg);
            text-align: center;
            margin-bottom: var(--spacing-xl);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-md);
        }

        .wa-role-icon {
            font-size: 2rem;
        }

        .wa-role-text {
            font-family: var(--font-accent);
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--enjhi);
        }

        .wa-label-icon {
            margin-right: var(--spacing-sm);
        }

        .wa-radio-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--spacing-md);
            margin-top: var(--spacing-sm);
        }

        .wa-radio-item {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-md);
            border: 2px solid var(--ai);
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: all 0.3s ease;
            background: var(--washi);
        }

        .wa-radio-item:hover {
            border-color: var(--enjhi);
            background: var(--gradient-sakura);
        }

        .wa-radio-item input {
            display: none;
        }

        .wa-radio-custom {
            width: 20px;
            height: 20px;
            border: 2px solid var(--ai);
            border-radius: 50%;
            position: relative;
            transition: all 0.3s ease;
        }

        .wa-radio-item input:checked + .wa-radio-custom {
            border-color: var(--enjhi);
            background: var(--enjhi);
        }

        .wa-radio-item input:checked + .wa-radio-custom::after {
            content: '';
            position: absolute;
            width: 8px;
            height: 8px;
            background: var(--yuki);
            border-radius: 50%;
            top: 4px;
            left: 4px;
        }

        .wa-radio-text {
            font-family: var(--font-main);
            color: var(--sumi);
        }

        .wa-connection-status {
            margin-top: var(--spacing-xl);
        }

        .wa-waiting-guest {
            background: var(--gradient-sakura);
            padding: var(--spacing-lg);
            border-radius: var(--border-radius);
            margin-top: var(--spacing-md);
        }

        .wa-room-info {
            background: rgba(178, 45, 53, 0.1);
            padding: var(--spacing-sm);
            border-radius: var(--border-radius);
            margin: var(--spacing-md) 0;
            text-align: center;
        }

        .wa-guest-instructions {
            margin-top: var(--spacing-lg);
        }

        .wa-guest-instructions h5 {
            color: var(--enjhi);
            margin-bottom: var(--spacing-sm);
        }

        .wa-guest-instructions ol {
            padding-left: var(--spacing-lg);
        }

        .wa-guest-instructions li {
            margin-bottom: var(--spacing-xs);
        }

        .wa-participants {
            margin-top: var(--spacing-lg);
        }

        .wa-participant-list {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-sm);
            margin-top: var(--spacing-md);
        }

        .wa-participant-item {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            padding: var(--spacing-md);
            background: var(--washi);
            border: 1px solid rgba(22, 94, 131, 0.2);
            border-radius: var(--border-radius);
        }

        .wa-participant-role {
            font-weight: 600;
            color: var(--ai);
            min-width: 60px;
        }

        .wa-participant-name {
            flex: 1;
            font-weight: 500;
            color: var(--sumi);
        }

        .wa-participant-status {
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: var(--border-radius);
            font-size: 0.8rem;
            font-weight: 600;
            background: rgba(178, 45, 53, 0.1);
            color: var(--enjhi);
        }

        .wa-participant-status.ready {
            background: var(--take);
            color: var(--yuki);
        }

        .wa-error-display {
            margin-top: var(--spacing-xl);
        }

        .wa-help-section {
            margin-top: var(--spacing-xl);
        }

        .wa-help-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: var(--spacing-lg);
        }

        .wa-help-item strong {
            color: var(--enjhi);
            display: block;
            margin-bottom: var(--spacing-sm);
        }

        /* Guestå¾…æ©Ÿé€šçŸ¥ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .wa-guest-waiting-notice {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            background: var(--gradient-sakura);
            border: 2px solid var(--enjhi);
            border-radius: var(--border-radius-large);
            box-shadow: var(--shadow-strong);
            max-width: 400px;
            animation: wa-notice-slide-in 0.4s ease-out;
        }

        .wa-notice-content {
            display: flex;
            align-items: flex-start;
            padding: var(--spacing-lg);
            gap: var(--spacing-md);
        }

        .wa-notice-icon {
            font-size: 2rem;
            flex-shrink: 0;
        }

        .wa-notice-text h4 {
            color: var(--enjhi);
            font-family: var(--font-accent);
            margin: 0 0 var(--spacing-sm) 0;
            font-size: 1.1rem;
        }

        .wa-notice-text p {
            color: var(--sumi);
            margin: 0 0 var(--spacing-md) 0;
            line-height: 1.6;
            font-size: 0.9rem;
        }

        .wa-waiting-animation {
            display: flex;
            justify-content: center;
            gap: var(--spacing-xs);
            margin-top: var(--spacing-sm);
        }

        .wa-waiting-dot {
            width: 8px;
            height: 8px;
            background: var(--enjhi);
            border-radius: 50%;
            animation: wa-waiting-pulse 1.4s ease-in-out infinite both;
        }

        .wa-waiting-dot:nth-child(1) { animation-delay: -0.32s; }
        .wa-waiting-dot:nth-child(2) { animation-delay: -0.16s; }
        .wa-waiting-dot:nth-child(3) { animation-delay: 0s; }

        .wa-notice-close {
            background: none;
            border: none;
            color: var(--enjhi);
            font-size: 1.4rem;
            font-weight: bold;
            cursor: pointer;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }

        .wa-notice-close:hover {
            background: rgba(178, 45, 53, 0.1);
        }

        /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        @keyframes wa-notice-slide-in {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes wa-waiting-pulse {
            0%, 80%, 100% {
                transform: scale(0);
                opacity: 0.5;
            }
            40% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .wa-fade-out {
            animation: wa-notice-slide-out 0.3s ease-in forwards;
        }

        @keyframes wa-notice-slide-out {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        @media (max-width: 768px) {
            .wa-radio-group {
                grid-template-columns: 1fr;
            }
            
            .wa-help-grid {
                grid-template-columns: 1fr;
            }
            
            .wa-guest-waiting-notice {
                left: 10px;
                right: 10px;
                top: 10px;
                max-width: none;
            }

            .wa-notice-content {
                padding: var(--spacing-md);
            }

            .wa-notice-text h4 {
                font-size: 1rem;
            }

            .wa-notice-text p {
                font-size: 0.85rem;
            }
        }
    </style>
</body>
</html>
