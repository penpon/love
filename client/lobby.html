<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ルーム情報入力 - CS学習クイズバトル</title>
    <link rel="stylesheet" href="css/taisho.css">
</head>
<body>
    <!-- 四季の装飾要素 -->
    <div class="seasonal-decoration" id="seasonalDecoration"></div>

    <main class="washi-container wa-fade-in">
        <!-- ヘッダー -->
        <header class="wa-header">
            <h1 class="wa-title">学習の座敷へようこそ</h1>
            <p class="wa-subtitle" id="roleSubtitle">主催者としてルームを設営</p>
            <div class="wa-divider"></div>
        </header>

        <!-- 役割表示バッジ -->
        <div class="wa-role-badge" id="roleBadge">
            <span class="wa-role-icon" id="roleIcon">👑</span>
            <span class="wa-role-text" id="roleText">主催者 (Owner)</span>
        </div>

        <!-- ルーム設定フォーム -->
        <section class="wa-room-setup">
            <div class="wa-form">
                <h2 class="wa-form-title">🏛️ ルーム情報</h2>

                <div class="wa-form-group">
                    <label class="wa-form-label" for="roomId">
                        <span class="wa-label-icon">🏮</span>
                        ルーム名
                    </label>
                    <input 
                        type="text" 
                        id="roomId" 
                        class="wa-form-input" 
                        placeholder="例: 大正浪漫学習室" 
                        maxlength="20"
                        autocomplete="off"
                    >
                    <div class="wa-form-hint">
                        英数字・ひらがな・カタカナ・漢字が使用できます（4-20文字）
                    </div>
                </div>

                <div class="wa-form-group">
                    <label class="wa-form-label" for="playerName">
                        <span class="wa-label-icon">🎭</span>
                        お名前
                    </label>
                    <input 
                        type="text" 
                        id="playerName" 
                        class="wa-form-input" 
                        placeholder="例: 恋する学習者" 
                        maxlength="15"
                        autocomplete="name"
                    >
                    <div class="wa-form-hint">
                        学習仲間に表示されるお名前です（2-15文字）
                    </div>
                </div>


                <!-- 接続ボタン -->
                <div class="wa-btn-group">
                    <button class="wa-btn wa-btn-outline" onclick="goBack()">
                        <span>🔙</span>
                        <span>戻る</span>
                    </button>
                    <button class="wa-btn wa-btn-primary" id="connectBtn" onclick="connectToRoom()">
                        <span id="connectIcon">🏮</span>
                        <span id="connectText">学習の間に入室</span>
                    </button>
                </div>
            </div>
        </section>

        <!-- 接続状況表示 -->
        <div class="wa-connection-status" id="connectionStatus" style="display: none;">
            <div class="wa-card">
                <div class="wa-card-title">
                    <span id="statusIcon">🔄</span>
                    <span id="statusTitle">接続中...</span>
                </div>
                <div class="wa-card-content">
                    <div class="wa-progress">
                        <div class="wa-progress-bar" id="progressBar" style="width: 0%"></div>
                    </div>
                    <p id="statusMessage">サーバーに接続しています...</p>
                    
                    <!-- 参加者待ち（Owner専用） -->
                    <div class="wa-waiting-guest" id="waitingGuest" style="display: none;">
                        <h4>👥 参加者をお待ちしています</h4>
                        <p>他の方がこのルームに参加するまでお待ちください</p>
                        <div class="wa-room-info">
                            <strong>ルーム名: </strong><span id="displayRoomId"></span>
                        </div>
                        <div class="wa-guest-instructions">
                            <h5>📢 参加方法をお伝えください</h5>
                            <ol>
                                <li>トップページで「参加者 (Guest)」を選択</li>
                                <li>ルーム名に「<strong id="shareRoomId"></strong>」を入力</li>
                                <li>お名前を入力して入室</li>
                            </ol>
                        </div>
                    </div>

                    <!-- 参加者表示 -->
                    <div class="wa-participants" id="participants" style="display: none;">
                        <h4>👤 参加者</h4>
                        <div class="wa-participant-list">
                            <div class="wa-participant-item">
                                <span class="wa-participant-role">主催者</span>
                                <span class="wa-participant-name" id="ownerName">-</span>
                                <span class="wa-participant-status" id="ownerStatus">準備完了</span>
                            </div>
                            <div class="wa-participant-item">
                                <span class="wa-participant-role">参加者</span>
                                <span class="wa-participant-name" id="guestName">待機中...</span>
                                <span class="wa-participant-status" id="guestStatus">未接続</span>
                            </div>
                        </div>
                    </div>

                    <!-- 続行ボタン -->
                    <div class="wa-btn-group" id="proceedBtnGroup" style="display: none; margin-top: 2rem;">
                        <button class="wa-btn wa-btn-secondary wa-pulse" id="proceedButton" onclick="proceedToModeSelect()">
                            <span id="proceedIcon">✨</span>
                            <span id="proceedText">モード選択へ進む</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- エラー表示 -->
        <div class="wa-error-display" id="errorDisplay" style="display: none;">
            <div class="wa-alert wa-alert-error">
                <h4>⚠️ 接続エラー</h4>
                <p id="errorMessage"></p>
                <button class="wa-btn wa-btn-outline" onclick="retryConnection()">
                    <span>🔄</span>
                    <span>再試行</span>
                </button>
            </div>
        </div>

        <!-- ヘルプ情報 -->
        <div class="wa-help-section">
            <div class="wa-card">
                <div class="wa-card-title">💡 ご利用方法</div>
                <div class="wa-card-content">
                    <div class="wa-help-grid">
                        <div class="wa-help-item">
                            <strong>👑 主催者の方</strong>
                            <p>新しいルーム名とお名前を入力してルームを作成します。参加者の入室をお待ちします。</p>
                        </div>
                        <div class="wa-help-item">
                            <strong>🎋 参加者の方</strong>
                            <p>主催者が作成したルーム名とお名前を入力してルームに参加します。自動的に主催者と接続されます。</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ステータスバー -->
        <div class="wa-status">
            <div class="wa-status-item">
                <span class="wa-status-dot" id="connectionDot"></span>
                <span id="connectionText">未接続</span>
            </div>
            <div class="wa-status-item">
                <span>🎭 役割: <span id="statusRole">-</span></span>
            </div>
            <div class="wa-status-item">
                <span>🏮 ルーム: <span id="statusRoom">未設定</span></span>
            </div>
        </div>
    </main>

    <script src="/socket.io/socket.io.js"></script>
    <script src="js/socket.js"></script>
    <script>
        // URLパラメータから役割を取得
        const urlParams = new URLSearchParams(window.location.search);
        const userRole = urlParams.get('role') || 'owner';
        
        let socket = null;
        let isConnecting = false;
        let roomConnected = false;
        
        // 初期化
        document.addEventListener('DOMContentLoaded', () => {
            setupRoleUI();
            setupFormValidation();
            generateSeasonalElements('spring');
            
            // 自動季節変更（30秒ごと）
            setInterval(changeSeason, 30000);
            
            // フォーカス設定
            setTimeout(() => {
                document.getElementById('roomId').focus();
            }, 500);
        });
        
        // 役割に応じたUI設定
        function setupRoleUI() {
            const roleIcon = document.getElementById('roleIcon');
            const roleText = document.getElementById('roleText');
            const roleSubtitle = document.getElementById('roleSubtitle');
            const statusRole = document.getElementById('statusRole');
            const connectBtn = document.getElementById('connectBtn');
            const connectText = document.getElementById('connectText');
            
            if (userRole === 'owner') {
                roleIcon.textContent = '👑';
                roleText.textContent = '主催者 (Owner)';
                roleSubtitle.textContent = '主催者としてルームを設営';
                statusRole.textContent = '主催者';
                connectText.textContent = 'ルームを開設';
            } else {
                roleIcon.textContent = '🎋';
                roleText.textContent = '参加者 (Guest)';
                roleSubtitle.textContent = '参加者として学習に加わる';
                statusRole.textContent = '参加者';
                connectText.textContent = 'ルームに参加';
                
                // Guest専用のプレースホルダー
                document.getElementById('roomId').placeholder = '主催者から教えてもらったルーム名';
            }
        }
        
        // フォーム検証
        function setupFormValidation() {
            const roomIdInput = document.getElementById('roomId');
            const playerNameInput = document.getElementById('playerName');
            const connectBtn = document.getElementById('connectBtn');
            
            function validateForm() {
                const roomId = roomIdInput.value.trim();
                const playerName = playerNameInput.value.trim();
                
                const isValid = roomId.length >= 4 && 
                               roomId.length <= 20 &&
                               playerName.length >= 2 && 
                               playerName.length <= 15;
                
                connectBtn.disabled = !isValid;
                
                // リアルタイムフィードバック
                updateFieldStatus(roomIdInput, roomId.length >= 4 && roomId.length <= 20);
                updateFieldStatus(playerNameInput, playerName.length >= 2 && playerName.length <= 15);
            }
            
            roomIdInput.addEventListener('input', validateForm);
            playerNameInput.addEventListener('input', validateForm);
            
            validateForm();
        }
        
        function updateFieldStatus(field, isValid) {
            if (field.value.length > 0) {
                if (isValid) {
                    field.style.borderColor = 'var(--take)';
                    field.style.backgroundColor = 'rgba(74, 122, 78, 0.1)';
                } else {
                    field.style.borderColor = 'var(--enjhi)';
                    field.style.backgroundColor = 'rgba(178, 45, 53, 0.05)';
                }
            } else {
                field.style.borderColor = 'var(--ai)';
                field.style.backgroundColor = 'var(--washi)';
            }
        }
        
        // ルーム接続
        function connectToRoom() {
            if (isConnecting) {
                showError('現在接続処理中です。しばらくお待ちください。');
                return;
            }
            
            if (roomConnected) {
                showError('既にルームに接続されています。');
                return;
            }
            
            const roomId = document.getElementById('roomId').value.trim();
            const playerName = document.getElementById('playerName').value.trim();
            const connectBtn = document.getElementById('connectBtn');
            
            // フォーム検証
            if (!roomId) {
                showError('ルーム名を入力してください。');
                return;
            } else if (roomId.length < 4) {
                showError(`ルーム名が短すぎます。現在${roomId.length}文字（4文字以上必要）`);
                return;
            } else if (roomId.length > 20) {
                showError(`ルーム名が長すぎます。現在${roomId.length}文字（20文字以内）`);
                return;
            }
            
            if (!playerName) {
                showError('お名前を入力してください。');
                return;
            } else if (playerName.length < 2) {
                showError(`お名前が短すぎます。現在${playerName.length}文字（2文字以上必要）`);
                return;
            } else if (playerName.length > 15) {
                showError(`お名前が長すぎます。現在${playerName.length}文字（15文字以内）`);
                return;
            }
            
            // 接続開始
            isConnecting = true;
            connectBtn.disabled = true;
            
            // ボタンテキストを更新
            const connectText = document.getElementById('connectText');
            const connectIcon = document.getElementById('connectIcon');
            connectText.textContent = '接続中...';
            connectIcon.textContent = '🔄';
            
            showConnectionStatus();
            updateProgress(20, 'サーバーに接続中...');
            
            // 既存の接続をクリーンアップ
            if (socket) {
                console.log('既存のSocket接続をクリーンアップします');
                socket.removeAllListeners();
                socket.disconnect();
                socket = null;
            }
            
            // 新しいSocket.io接続を作成
            socket = io({
                forceNew: true,
                transports: ['websocket', 'polling']
            });
            
            socket.on('connect', () => {
                console.log('サーバーに接続しました');
                updateProgress(40, 'ルーム情報を送信中...');
                
                socket.emit('join_room', {
                    roomId: roomId,
                    playerName: playerName,
                    role: userRole
                });
            });
            
            socket.on('connect_error', (error) => {
                console.error('接続エラー:', error);
                let errorMessage = 'サーバーに接続できませんでした。';
                
                if (error.type === 'TransportError') {
                    errorMessage += '通信エラーが発生しました。ネットワーク接続を確認してください。';
                } else if (error.message) {
                    errorMessage += `エラー: ${error.message}`;
                } else {
                    errorMessage += 'しばらく待ってから再試行してください。';
                }
                
                showError(errorMessage);
            });
            
            socket.on('room_full', () => {
                showError('このルームは満室です。別のルーム名をお試しください。');
                isConnecting = false;
            });
            
            socket.on('room_status', (data) => {
                console.log('ルーム状況:', data);
                updateProgress(80, 'ルーム状況を確認中...');
                
                setTimeout(() => {
                    updateRoomStatus(data);
                    isConnecting = false;
                    roomConnected = true;
                    updateProgress(100, '準備完了！');
                }, 1000);
            });
            
            socket.on('match_found', (data) => {
                console.log('マッチング完了:', data);
                showParticipants(data);
            });
            
            socket.on('player_disconnected', (data) => {
                showError(`${data.playerName}さんが切断されました。`);
                resetConnection();
            });
            
            socket.on('room_closed_by_owner', (data) => {
                console.log('主催者によってルームが閉じられました:', data);
                showError(`${data.message}\n主催者: ${data.ownerName} さんが新しいルーム "${data.newRoomId}" を作成しました。`);
                resetConnection();
            });
            
            // Guest用: Owner がモード選択画面に遷移した際の通知のみ（遷移はしない）
            socket.on('owner_proceeded_to_mode_select', (data) => {
                console.log(`Owner ${data.ownerName} がモード選択画面に遷移しました`, data);
                
                // Guestの場合は主催者の操作待ちメッセージを表示
                if (userRole === 'guest') {
                    showGuestWaitingForOwner();
                }
            });
            
            // Guest用: 学習モード選択時の直接遷移
            socket.on('redirect_to_learning', (data) => {
                console.log('学習モードが選択されました:', data);
                
                if (userRole === 'guest') {
                    const roomId = document.getElementById('roomId').value;
                    const playerName = document.getElementById('playerName').value;
                    
                    console.log('Guestとして学習画面に直接遷移します');
                    
                    // 短い遅延の後、学習画面へ遷移
                    setTimeout(() => {
                        window.location.href = `learning.html?role=${userRole}&roomId=${encodeURIComponent(roomId)}&playerName=${encodeURIComponent(playerName)}`;
                    }, 1000);
                }
            });
            
            // Guest用: クイズモード選択時の直接遷移
            socket.on('redirect_to_matching', (data) => {
                console.log('クイズモードが選択されました:', data);
                
                if (userRole === 'guest') {
                    const roomId = document.getElementById('roomId').value;
                    const playerName = document.getElementById('playerName').value;
                    
                    console.log('Guestとしてマッチング画面に直接遷移します');
                    
                    // 短い遅延の後、マッチング画面へ遷移
                    setTimeout(() => {
                        window.location.href = `matching.html?role=${userRole}&roomId=${encodeURIComponent(roomId)}&playerName=${encodeURIComponent(playerName)}`;
                    }, 1000);
                }
            });
            
            socket.on('disconnect', () => {
                console.log('サーバーから切断されました');
                showError('サーバーとの接続が切断されました。');
                resetConnection();
            });
        }
        
        function updateProgress(percent, message) {
            const progressBar = document.getElementById('progressBar');
            const statusMessage = document.getElementById('statusMessage');
            
            progressBar.style.width = percent + '%';
            statusMessage.textContent = message;
            
            if (percent === 100) {
                setTimeout(() => {
                    document.getElementById('statusIcon').textContent = '✅';
                    document.getElementById('statusTitle').textContent = '準備完了';
                }, 500);
            }
        }
        
        function updateRoomStatus(data) {
            const participants = data.players || [];
            const connectionDot = document.getElementById('connectionDot');
            const connectionText = document.getElementById('connectionText');
            const statusRoom = document.getElementById('statusRoom');
            
            connectionDot.style.backgroundColor = 'var(--take)';
            connectionText.textContent = '準備完了';
            statusRoom.textContent = document.getElementById('roomId').value;
            
            // 接続完了後のボタン状態を更新
            updateConnectionButton();
            
            // ボタンテキストを役割に応じて更新
            updateProceedButtonText();
            
            if (userRole === 'owner') {
                if (participants.length < 2) {
                    showWaitingForGuest();
                } else {
                    showParticipants({ players: participants });
                }
            } else {
                showParticipants({ players: participants });
            }
            
            // ボタンテキストを更新
            updateProceedButtonText();
        }
        
        // 接続完了後のボタン状態を更新
        function updateConnectionButton() {
            const connectBtn = document.getElementById('connectBtn');
            const connectText = document.getElementById('connectText');
            const connectIcon = document.getElementById('connectIcon');
            
            // ボタンを有効化
            connectBtn.disabled = false;
            
            if (userRole === 'owner') {
                // Ownerの場合：ルーム作り直し
                connectText.textContent = 'ルーム作り直し';
                connectIcon.textContent = '🔄';
                connectBtn.onclick = recreateRoom;
            } else {
                // Guestの場合：接続取り消し
                connectText.textContent = '接続取り消し';
                connectIcon.textContent = '❌';
                connectBtn.onclick = cancelConnection;
            }
        }
        
        // Owner用：ルーム作り直し機能
        function recreateRoom() {
            console.log('ルーム作り直しを開始します');
            
            // 現在の接続をリセット
            resetConnection();
            
            // フォームの値をチェック（入力内容は保持される）
            const roomId = document.getElementById('roomId').value.trim();
            const playerName = document.getElementById('playerName').value.trim();
            
            if (!roomId || !playerName) {
                showError('ルーム名とお名前を入力してください');
                return;
            }
        }
        
        // Guest用：接続取り消し機能
        function cancelConnection() {
            console.log('接続を取り消します');
            
            // サーバーにルーム離脱を通知
            if (socket && socket.connected) {
                const roomId = document.getElementById('roomId').value.trim();
                socket.emit('leave_room', { roomId: roomId });
            }
            
            // 接続をリセット
            resetConnection();
        }
        
        function showWaitingForGuest() {
            const waitingGuest = document.getElementById('waitingGuest');
            const displayRoomId = document.getElementById('displayRoomId');
            const shareRoomId = document.getElementById('shareRoomId');
            const roomId = document.getElementById('roomId').value;
            
            waitingGuest.style.display = 'block';
            displayRoomId.textContent = roomId;
            shareRoomId.textContent = roomId;
        }
        
        function showParticipants(data) {
            const participants = document.getElementById('participants');
            const proceedBtnGroup = document.getElementById('proceedBtnGroup');
            const waitingGuest = document.getElementById('waitingGuest');
            const ownerName = document.getElementById('ownerName');
            const guestName = document.getElementById('guestName');
            const guestStatus = document.getElementById('guestStatus');
            
            participants.style.display = 'block';
            waitingGuest.style.display = 'none';
            
            const players = data.players || [];
            
            // role基準で表示（Owner/Guest順ではなく役割で固定）
            const ownerPlayer = players.find(p => p.role === 'owner');
            const guestPlayer = players.find(p => p.role === 'guest');
            
            // Owner表示
            const ownerStatus = document.getElementById('ownerStatus');
            if (ownerPlayer) {
                ownerName.textContent = ownerPlayer.name;
                if (userRole === 'guest') {
                    ownerStatus.textContent = '待機中';
                    ownerStatus.className = 'wa-participant-status';
                } else {
                    ownerStatus.textContent = '準備完了';
                    ownerStatus.className = 'wa-participant-status ready';
                }
            } else {
                ownerName.textContent = '待機中...';
                ownerStatus.textContent = '未接続';
                ownerStatus.className = 'wa-participant-status';
            }
            
            // Guest表示
            if (guestPlayer) {
                guestName.textContent = guestPlayer.name;
                guestStatus.textContent = '接続済み';
                guestStatus.className = 'wa-participant-status ready';
            } else {
                guestName.textContent = '待機中...';
                guestStatus.textContent = '未接続';
                guestStatus.className = 'wa-participant-status';
            }
            
            // 両方揃ったので続行ボタンを表示
            if (players.length >= 2) {
                proceedBtnGroup.style.display = 'block';
                updateProceedButtonText();
            }
        }
        
        function showConnectionStatus() {
            const connectionStatus = document.getElementById('connectionStatus');
            const errorDisplay = document.getElementById('errorDisplay');
            
            connectionStatus.style.display = 'block';
            errorDisplay.style.display = 'none';
        }
        
        function showError(message) {
            const errorDisplay = document.getElementById('errorDisplay');
            const errorMessage = document.getElementById('errorMessage');
            const connectionStatus = document.getElementById('connectionStatus');
            const connectBtn = document.getElementById('connectBtn');
            
            errorMessage.textContent = message;
            errorDisplay.style.display = 'block';
            connectionStatus.style.display = 'none';
            
            // 接続状態をリセット
            isConnecting = false;
            roomConnected = false;
            
            // フォーム検証を再実行してボタン状態を適切に設定
            const roomId = document.getElementById('roomId').value.trim();
            const playerName = document.getElementById('playerName').value.trim();
            const isFormValid = roomId.length >= 4 && roomId.length <= 20 &&
                               playerName.length >= 2 && playerName.length <= 15;
            
            connectBtn.disabled = !isFormValid;
            
            // ボタンテキストとアイコンをリセット
            const connectText = document.getElementById('connectText');
            const connectIcon = document.getElementById('connectIcon');
            connectIcon.textContent = '🏮';
            
            if (userRole === 'owner') {
                connectText.textContent = 'ルームを開設';
            } else {
                connectText.textContent = 'ルームに参加';
            }
        }
        
        function retryConnection() {
            const errorDisplay = document.getElementById('errorDisplay');
            errorDisplay.style.display = 'none';
            resetConnection();
        }
        
        function resetConnection() {
            if (socket) {
                console.log('Socket接続をリセットします');
                socket.removeAllListeners();
                socket.disconnect();
                socket = null;
            }
            isConnecting = false;
            roomConnected = false;
            
            const connectionStatus = document.getElementById('connectionStatus');
            const errorDisplay = document.getElementById('errorDisplay');
            const connectBtn = document.getElementById('connectBtn');
            
            connectionStatus.style.display = 'none';
            errorDisplay.style.display = 'none';
            
            // 参加者表示をリセット
            const participants = document.getElementById('participants');
            const proceedBtnGroup = document.getElementById('proceedBtnGroup');
            const waitingGuest = document.getElementById('waitingGuest');
            participants.style.display = 'none';
            proceedBtnGroup.style.display = 'none';
            waitingGuest.style.display = 'none';
            
            // プログレスバーをリセット
            const progressBar = document.getElementById('progressBar');
            const statusIcon = document.getElementById('statusIcon');
            const statusTitle = document.getElementById('statusTitle');
            progressBar.style.width = '0%';
            statusIcon.textContent = '🔄';
            statusTitle.textContent = '接続中...';
            
            // ステータス更新
            const connectionDot = document.getElementById('connectionDot');
            const connectionText = document.getElementById('connectionText');
            const statusRoom = document.getElementById('statusRoom');
            connectionDot.style.backgroundColor = 'var(--enjhi)';
            connectionText.textContent = '未接続';
            statusRoom.textContent = '未設定';
            
            // フォーム検証を再実行してボタン状態を適切に設定
            const roomId = document.getElementById('roomId').value.trim();
            const playerName = document.getElementById('playerName').value.trim();
            const isFormValid = roomId.length >= 4 && roomId.length <= 20 &&
                               playerName.length >= 2 && playerName.length <= 15;
            
            connectBtn.disabled = !isFormValid;
            
            // ボタンテキストとアイコンをリセット
            const connectText = document.getElementById('connectText');
            const connectIcon = document.getElementById('connectIcon');
            connectIcon.textContent = '🏮';
            
            if (userRole === 'owner') {
                connectText.textContent = 'ルームを開設';
            } else {
                connectText.textContent = 'ルームに参加';
            }
            
            // onclickイベントを元に戻す
            connectBtn.onclick = connectToRoom;
            
            // 続行ボタンのテキストをリセット
            updateProceedButtonText();
        }
        
        function proceedToModeSelect() {
            const roomId = document.getElementById('roomId').value;
            const playerName = document.getElementById('playerName').value;
            const proceedButton = document.getElementById('proceedButton');
            
            // ボタンを一時的に無効化してダブルクリックを防ぐ
            if (proceedButton.disabled) return;
            proceedButton.disabled = true;
            
            // アニメーションを一時停止
            proceedButton.classList.remove('wa-pulse');
            
            // 処理完了後、ボタン状態を復元（3秒後）
            setTimeout(() => {
                proceedButton.disabled = false;
                proceedButton.classList.add('wa-pulse');
            }, 3000);
            
            if (userRole === 'owner') {
                // Ownerの場合、サーバーにモード選択遷移を通知してから遷移
                if (socket && socket.connected) {
                    socket.emit('proceed_to_mode_select', {
                        roomId: roomId
                    });
                }
                
                // モード選択画面へ遷移
                window.location.href = `mode-select.html?role=${userRole}&roomId=${encodeURIComponent(roomId)}&playerName=${encodeURIComponent(playerName)}`;
            } else {
                // Guestの場合、主催者の操作を待つメッセージを表示
                showGuestWaitingForOwner();
            }
        }
        
        // 続行ボタンのテキストを役割に応じて更新
        function updateProceedButtonText() {
            const proceedButton = document.getElementById('proceedButton');
            const proceedIcon = document.getElementById('proceedIcon');
            const proceedText = document.getElementById('proceedText');
            
            if (!proceedButton || !proceedIcon || !proceedText) return;
            
            if (userRole === 'owner') {
                proceedIcon.textContent = '✨';
                proceedText.textContent = 'モード選択へ進む';
            } else {
                proceedIcon.textContent = '🎋';
                proceedText.textContent = '接続する';
            }
        }
        
        // Guest用の待機メッセージを表示
        function showGuestWaitingForOwner() {
            // 既存の通知があれば削除
            const existingNotice = document.getElementById('guestWaitingNotice');
            if (existingNotice) {
                existingNotice.remove();
            }
            
            // 通知要素を作成
            const notice = document.createElement('div');
            notice.id = 'guestWaitingNotice';
            notice.className = 'wa-guest-waiting-notice wa-fade-in';
            notice.innerHTML = `
                <div class="wa-notice-content">
                    <div class="wa-notice-icon">🌸</div>
                    <div class="wa-notice-text">
                        <h4>🎋 参加者様へのご案内</h4>
                        <p>
                            主催者(Owner)がモード選択を終えるまでお待ちください。<br>
                            主催者の選択が完了すると、自動的に画面が切り替わります。
                        </p>
                        <div class="wa-waiting-animation">
                            <div class="wa-waiting-dot"></div>
                            <div class="wa-waiting-dot"></div>
                            <div class="wa-waiting-dot"></div>
                        </div>
                    </div>
                    <button class="wa-notice-close" onclick="this.closest('.wa-guest-waiting-notice').remove();">×</button>
                </div>
            `;
            
            document.body.appendChild(notice);
        }

        function goBack() {
            if (socket) {
                socket.disconnect();
            }
            window.location.href = 'index.html';
        }
        
        // 四季のアニメーション設定
        const seasons = ['spring', 'summer', 'autumn', 'winter'];
        let currentSeasonIndex = 0;
        
        // 季節切り替え（自動のみ）
        function changeSeason() {
            const seasonElement = document.getElementById('seasonalDecoration');
            
            currentSeasonIndex = (currentSeasonIndex + 1) % seasons.length;
            const season = seasons[currentSeasonIndex];
            
            seasonElement.className = `seasonal-decoration season-${season}`;
            
            // 季節に応じた装飾要素を生成
            generateSeasonalElements(season);
        }
        
        // 季節装飾の生成
        function generateSeasonalElements(season = 'spring') {
            const container = document.getElementById('seasonalDecoration');
            container.innerHTML = '';
            
            const elementCount = 6;
            
            for (let i = 0; i < elementCount; i++) {
                const element = document.createElement('div');
                
                switch (season) {
                    case 'spring':
                        element.className = 'sakura-petal';
                        element.style.left = Math.random() * 100 + '%';
                        element.style.animationDelay = Math.random() * 8 + 's';
                        element.style.animationDuration = (6 + Math.random() * 4) + 's';
                        break;
                        
                    case 'summer':
                        element.className = 'summer-leaf';
                        element.style.cssText = `
                            position: absolute;
                            width: 8px;
                            height: 8px;
                            background: var(--tsuyu);
                            border-radius: 50% 0 50% 0;
                            left: ${Math.random() * 100}%;
                            animation: summerSway ${4 + Math.random() * 3}s ease-in-out infinite;
                            animation-delay: ${Math.random() * 4}s;
                            opacity: 0.3;
                        `;
                        break;
                        
                    case 'autumn':
                        element.className = 'momiji-leaf';
                        element.style.left = Math.random() * 100 + '%';
                        element.style.animationDelay = Math.random() * 10 + 's';
                        element.style.animationDuration = (8 + Math.random() * 4) + 's';
                        break;
                        
                    case 'winter':
                        element.className = 'snow-flake';
                        element.innerHTML = '❄';
                        element.style.cssText = `
                            position: absolute;
                            color: var(--yuki);
                            font-size: ${6 + Math.random() * 6}px;
                            left: ${Math.random() * 100}%;
                            animation: snowFall ${6 + Math.random() * 6}s linear infinite;
                            animation-delay: ${Math.random() * 6}s;
                            opacity: 0.6;
                        `;
                        break;
                }
                
                container.appendChild(element);
            }
        }
        
        // キーボードショートカット
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !isConnecting) {
                const connectBtn = document.getElementById('connectBtn');
                if (!connectBtn.disabled) {
                    connectToRoom();
                }
            }
            
            if (e.key === 'Escape') {
                goBack();
            }
        });
        
        // ページ離脱時のクリーンアップ
        window.addEventListener('beforeunload', () => {
            if (socket) {
                socket.disconnect();
            }
        });
    </script>

    <style>
        /* 夏と冬のアニメーション */
        @keyframes summerSway {
            0%, 100% { transform: translateX(0) rotate(0deg); }
            25% { transform: translateX(10px) rotate(90deg); }
            75% { transform: translateX(-10px) rotate(270deg); }
        }
        
        @keyframes snowFall {
            0% {
                transform: translateY(-100px) rotate(0deg);
                opacity: 0;
            }
            10% {
                opacity: 0.8;
            }
            90% {
                opacity: 0.8;
            }
            100% {
                transform: translateY(100vh) rotate(360deg);
                opacity: 0;
            }
        }
        
        .wa-section-title {
            font-family: var(--font-accent);
            font-size: 1.5rem;
            color: var(--enjhi);
            text-align: center;
            margin-bottom: var(--spacing-xl);
        }

        .wa-role-badge {
            background: var(--gradient-sakura);
            border: 2px solid var(--enjhi);
            border-radius: var(--border-radius-large);
            padding: var(--spacing-md) var(--spacing-lg);
            text-align: center;
            margin-bottom: var(--spacing-xl);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-md);
        }

        .wa-role-icon {
            font-size: 2rem;
        }

        .wa-role-text {
            font-family: var(--font-accent);
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--enjhi);
        }

        .wa-label-icon {
            margin-right: var(--spacing-sm);
        }

        .wa-radio-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--spacing-md);
            margin-top: var(--spacing-sm);
        }

        .wa-radio-item {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-md);
            border: 2px solid var(--ai);
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: all 0.3s ease;
            background: var(--washi);
        }

        .wa-radio-item:hover {
            border-color: var(--enjhi);
            background: var(--gradient-sakura);
        }

        .wa-radio-item input {
            display: none;
        }

        .wa-radio-custom {
            width: 20px;
            height: 20px;
            border: 2px solid var(--ai);
            border-radius: 50%;
            position: relative;
            transition: all 0.3s ease;
        }

        .wa-radio-item input:checked + .wa-radio-custom {
            border-color: var(--enjhi);
            background: var(--enjhi);
        }

        .wa-radio-item input:checked + .wa-radio-custom::after {
            content: '';
            position: absolute;
            width: 8px;
            height: 8px;
            background: var(--yuki);
            border-radius: 50%;
            top: 4px;
            left: 4px;
        }

        .wa-radio-text {
            font-family: var(--font-main);
            color: var(--sumi);
        }

        .wa-connection-status {
            margin-top: var(--spacing-xl);
        }

        .wa-waiting-guest {
            background: var(--gradient-sakura);
            padding: var(--spacing-lg);
            border-radius: var(--border-radius);
            margin-top: var(--spacing-md);
        }

        .wa-room-info {
            background: rgba(178, 45, 53, 0.1);
            padding: var(--spacing-sm);
            border-radius: var(--border-radius);
            margin: var(--spacing-md) 0;
            text-align: center;
        }

        .wa-guest-instructions {
            margin-top: var(--spacing-lg);
        }

        .wa-guest-instructions h5 {
            color: var(--enjhi);
            margin-bottom: var(--spacing-sm);
        }

        .wa-guest-instructions ol {
            padding-left: var(--spacing-lg);
        }

        .wa-guest-instructions li {
            margin-bottom: var(--spacing-xs);
        }

        .wa-participants {
            margin-top: var(--spacing-lg);
        }

        .wa-participant-list {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-sm);
            margin-top: var(--spacing-md);
        }

        .wa-participant-item {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            padding: var(--spacing-md);
            background: var(--washi);
            border: 1px solid rgba(22, 94, 131, 0.2);
            border-radius: var(--border-radius);
        }

        .wa-participant-role {
            font-weight: 600;
            color: var(--ai);
            min-width: 60px;
        }

        .wa-participant-name {
            flex: 1;
            font-weight: 500;
            color: var(--sumi);
        }

        .wa-participant-status {
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: var(--border-radius);
            font-size: 0.8rem;
            font-weight: 600;
            background: rgba(178, 45, 53, 0.1);
            color: var(--enjhi);
        }

        .wa-participant-status.ready {
            background: var(--take);
            color: var(--yuki);
        }

        .wa-error-display {
            margin-top: var(--spacing-xl);
        }

        .wa-help-section {
            margin-top: var(--spacing-xl);
        }

        .wa-help-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: var(--spacing-lg);
        }

        .wa-help-item strong {
            color: var(--enjhi);
            display: block;
            margin-bottom: var(--spacing-sm);
        }

        /* Guest待機通知のスタイル */
        .wa-guest-waiting-notice {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            background: var(--gradient-sakura);
            border: 2px solid var(--enjhi);
            border-radius: var(--border-radius-large);
            box-shadow: var(--shadow-strong);
            max-width: 400px;
            animation: wa-notice-slide-in 0.4s ease-out;
        }

        .wa-notice-content {
            display: flex;
            align-items: flex-start;
            padding: var(--spacing-lg);
            gap: var(--spacing-md);
        }

        .wa-notice-icon {
            font-size: 2rem;
            flex-shrink: 0;
        }

        .wa-notice-text h4 {
            color: var(--enjhi);
            font-family: var(--font-accent);
            margin: 0 0 var(--spacing-sm) 0;
            font-size: 1.1rem;
        }

        .wa-notice-text p {
            color: var(--sumi);
            margin: 0 0 var(--spacing-md) 0;
            line-height: 1.6;
            font-size: 0.9rem;
        }

        .wa-waiting-animation {
            display: flex;
            justify-content: center;
            gap: var(--spacing-xs);
            margin-top: var(--spacing-sm);
        }

        .wa-waiting-dot {
            width: 8px;
            height: 8px;
            background: var(--enjhi);
            border-radius: 50%;
            animation: wa-waiting-pulse 1.4s ease-in-out infinite both;
        }

        .wa-waiting-dot:nth-child(1) { animation-delay: -0.32s; }
        .wa-waiting-dot:nth-child(2) { animation-delay: -0.16s; }
        .wa-waiting-dot:nth-child(3) { animation-delay: 0s; }

        .wa-notice-close {
            background: none;
            border: none;
            color: var(--enjhi);
            font-size: 1.4rem;
            font-weight: bold;
            cursor: pointer;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }

        .wa-notice-close:hover {
            background: rgba(178, 45, 53, 0.1);
        }

        /* アニメーション */
        @keyframes wa-notice-slide-in {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes wa-waiting-pulse {
            0%, 80%, 100% {
                transform: scale(0);
                opacity: 0.5;
            }
            40% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .wa-fade-out {
            animation: wa-notice-slide-out 0.3s ease-in forwards;
        }

        @keyframes wa-notice-slide-out {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        @media (max-width: 768px) {
            .wa-radio-group {
                grid-template-columns: 1fr;
            }
            
            .wa-help-grid {
                grid-template-columns: 1fr;
            }
            
            .wa-guest-waiting-notice {
                left: 10px;
                right: 10px;
                top: 10px;
                max-width: none;
            }

            .wa-notice-content {
                padding: var(--spacing-md);
            }

            .wa-notice-text h4 {
                font-size: 1rem;
            }

            .wa-notice-text p {
                font-size: 0.85rem;
            }
        }
    </style>
</body>
</html>
